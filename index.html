<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Lucky Bean - v0.6.49</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Lucky Bean">
    <link rel="icon" type="image/png" href="images/luckybean_icon.png">
    <link rel="apple-touch-icon" href="images/luckybean_icon.png">

    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@1,300&family=Montserrat:wght@800&family=Courier+Prime&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-color: #ffffff;
            --primary-color: #000000;
            --text-main: #000000;
            --text-gray-70: #4d4d4d;
            --rpg-border: #000000;
            --tablet-bg: #f8f8f8;
            --tablet-border: #eeeeee;
            --point-red: #ff4d4d;
            --divider-color: #ebebeb;
            --btn-shadow: #333333;
            --btn-light-shadow: #e0e0e0;
            --roulette-gold: #f1c40f;
            --btn-dark-gray: #444444;
            --card-bg: #f8f8f8;
            --input-bg: #ffffff;
            --white-dash-bg: #ffffff;
        }

        body.dark-mode {
            --bg-color: #1a1a1a;
            --primary-color: #ffffff;
            --text-main: #f0f0f0;
            --text-gray-70: #bbbbbb;
            --rpg-border: #ffffff;
            --tablet-bg: #2a2a2a;
            --tablet-border: #333333;
            --divider-color: #3d3d3d;
            --btn-shadow: #000000;
            --btn-light-shadow: #111111;
            --card-bg: #252525;
            --input-bg: #333333;
            --white-dash-bg: #2a2a2a;
        }

        html, body { height: 100%; margin: 0; padding: 0; touch-action: pan-x pan-y; -webkit-text-size-adjust: none; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color); color: var(--text-main);
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            overflow-x: hidden; overflow-y: auto; transition: background-color 0.3s, color 0.3s;
        }

        .fade-in-view { animation: fadeInUp 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .wrapper { width: 100%; max-width: 600px; display: flex; flex-direction: column; align-items: center; text-align: center; padding-bottom: 40px; }

        header { padding: 10px 0 10px; cursor: pointer; width: 100%; display: flex; flex-direction: column; align-items: center; position: relative; }
        .title-lucky { font-family: 'Playfair Display', serif; font-style: italic; font-weight: 300; font-size: 2.8rem; letter-spacing: -1px; color: var(--text-main); }
        .title-bean { font-family: 'Montserrat', sans-serif; font-weight: 800; font-size: 3.1rem; letter-spacing: -2px; margin-left: -5px; color: var(--text-main); }

        #btn-cafe-vibe {
            position: absolute; right: 20px; top: 15px;
            background: var(--text-main); color: var(--bg-color);
            border: none; border-radius: 20px; padding: 4px 6px;
            font-size: 0.7rem; font-weight: 800; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            display: flex; align-items: center; gap: 5px;
            animation: vibe-pulse 2s infinite; z-index: 50;
        }
        @keyframes vibe-pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .game-screen {
            position: relative; width: 92%; max-width: 500px; margin: 10px auto 25px;
            border: 6px solid var(--rpg-border); line-height: 0; overflow: hidden; background: #eee; border-radius: 4px;
        }

        .title-image { width: 100%; height: auto; display: block; transition: none; }

        #rpg-textbox {
            position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%); width: 90%;
            background: rgba(255, 255, 255, 0.92); border: 3px solid #000;
            border-radius: 8px; padding: 12px 15px; box-sizing: border-box; line-height: 1.4; pointer-events: none; z-index: 10;
        }
        body.dark-mode #rpg-textbox { background: rgba(40, 40, 40, 0.95); border-color: #fff; }
        #rpg-content { font-size: 0.95rem; font-weight: 800; color: #000; min-height: 1.2rem; word-break: keep-all; white-space: pre-wrap; text-align: left; }
        body.dark-mode #rpg-content { color: #fff; }

        .card-container {
            width: 90%; max-width: 450px; background: var(--card-bg); border-radius: 30px;
            padding: 25px; box-sizing: border-box; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.01), 0 15px 35px rgba(0,0,0,0.03); margin: 0 auto 25px;
            transition: background-color 0.3s;
        }

        .order-menu-header { 
            font-family: 'Montserrat', sans-serif; font-weight: 800; font-size: 0.8rem; color: var(--text-main); 
            text-align: left; margin-bottom: 12px; letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center;
        }
        
        .header-icon-group { display: flex; gap: 8px; align-items: center; }
        .settings-icon-btn { background: none; border: none; font-size: 1.1rem; cursor: pointer; color: #bbb; padding: 0 5px; transition: color 0.2s; }
        .settings-icon-btn:hover { color: var(--text-main); }

        .recording-dot {
            width: 8px; height: 8px; background-color: var(--point-red);
            border-radius: 50%; display: none; margin-right: 2px;
            animation: rec-blink 1.2s infinite;
        }
        .recording-dot.active { display: inline-block; }
        @keyframes rec-blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        .btn-mix-rect {
            padding: 6px 14px; border-radius: 14px;
            background: var(--input-bg); border: 2px solid var(--text-main);
            font-size: 0.65rem; font-weight: 900; color: var(--text-main);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 3px 0 rgba(0,0,0,0.15);
            transition: transform 0.1s; letter-spacing: 0.5px;
        }
        .btn-mix-rect:active { transform: translateY(2px); box-shadow: 0 1px 0 rgba(0,0,0,0.15); }
        body.dark-mode .btn-mix-rect { border-color: #fff; color: #fff; background: #444; }

        .picker-group { width: 100%; display: flex; gap: 12px; margin-bottom: 20px; }
        .picker-btn {
            flex: 1; padding: 14px; border: 1px solid var(--tablet-border); border-radius: 16px;
            background: var(--input-bg); font-weight: 700; font-size: 0.85rem; color: var(--text-main); cursor: pointer;
            display: flex; flex-direction: column; align-items: flex-start; transition: all 0.1s; position: relative;
            box-shadow: 0 4px 0 var(--btn-light-shadow);
        }
        .picker-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 var(--btn-light-shadow); }
        .picker-label { color: #bbb; font-size: 0.65rem; font-weight: 800; margin-bottom: 4px; letter-spacing: 0.5px; }
        .picker-value { display: flex; justify-content: space-between; width: 100%; align-items: center; }
        .picker-value::after { content: '‚ñæ'; color: #ccc; font-size: 1rem; }

        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; margin-bottom: 15px; }
        .toggle-label { font-size: 0.75rem; font-weight: 800; color: var(--text-main); }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--point-red); }
        input:checked + .slider:before { transform: translateX(20px); }

        .lang-btn { background: var(--tablet-border); border: none; padding: 6px 8px; font-size: 0.65rem; font-weight: 800; border-radius: 8px; cursor: pointer; color: #999; transition: 0.2s; }
        .lang-btn.active { background: var(--primary-color); color: var(--bg-color); }

        .name-mgmt-bar { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 8px; }
        .btn-text { background: none; border: none; color: #bbb; font-size: 0.7rem; font-weight: 800; cursor: pointer; padding: 5px 10px; transition: 0.2s; letter-spacing: 1px; text-align: center; }

        .divider { width: 100%; height: 1px; background-color: var(--divider-color); margin-bottom: 20px; }

        #name-input-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; width: 100%; margin-bottom: 10px; }
        .name-input {
            padding: 14px 5px; border: 1px solid var(--tablet-border); border-radius: 14px; font-size: 0.85rem;
            outline: none; text-align: center; width: 100%; box-sizing: border-box; background: var(--input-bg);
            transition: all 0.2s; font-weight: 600; color: var(--text-main);
        }

        .game-canvas-area { 
            width: 100%; min-height: 220px; height: auto; position: relative; margin: 15px 0; padding-bottom: 0; overflow: hidden; 
            background: #ffffff !important; border: 2px solid #eee; border-radius: 20px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            transition: min-height 0.3s ease-out;
        }

        .icon-selector-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; margin-top: 10px; }
        .icon-btn-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: transform 0.1s; }
        .icon-btn-item:active { transform: scale(0.95); }
        .icon-square {
            width: 100%; aspect-ratio: 1/1; border: 3px solid var(--primary-color); border-radius: 15px;
            background: #fff; overflow: hidden; margin-bottom: 8px; box-shadow: 0 4px 0 var(--btn-shadow);
            display: flex; align-items: center; justify-content: center;
        }
        .icon-square img { width: 80%; height: 80%; object-fit: contain; }
        .icon-label { font-size: 0.65rem; font-weight: 900; color: var(--text-main); letter-spacing: 0px; text-transform: uppercase; line-height: 1.2; height: 2.4em; display: flex; align-items: center; justify-content: center; }

        #hand-display { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; padding: 25px 10px; width: 100%; box-sizing: border-box; }
        .hand-wrapper { 
            display: flex; flex-direction: column; align-items: center; 
            flex: 0 0 calc(33.33% - 8px); 
            max-width: calc(33.33% - 8px); transition: transform 0.4s ease; z-index: 1; 
        }
        .hand-img { width: 100%; height: auto; aspect-ratio: 1/1; object-fit: contain; cursor: pointer; -webkit-tap-highlight-color: transparent; animation: floating 3s ease-in-out infinite; }
        
        .hand-name, .bowl-name { 
            font-size: 0.65rem; font-weight: 900; color: #444; margin-top: 6px; 
            white-space: normal; word-break: keep-all; line-height: 1.2; overflow: hidden;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; text-align: center;
            height: 2.4em; 
        }
        body.dark-mode .hand-name, body.dark-mode .bowl-name { color: #888; }

        @keyframes floating { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        .tension-shake { animation: tension-animation 0.1s infinite !important; }
        @keyframes tension-animation { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-1px, -1px); } 100% { transform: translate(1px, -1px); } }
        .shake { animation: winner-shake 0.15s infinite !important; }
        @keyframes winner-shake { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(3px); } }

        #bowls-container { display: flex; flex-wrap: wrap; justify-content: center; align-items: flex-end; gap: 12px; padding: 120px 10px 30px; width: 100%; box-sizing: border-box; margin-top: auto; }
        .cat-bowl { flex: 0 1 calc(16.66% - 12px); min-width: 48px; text-align: center; transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .bowl-img { width: 100%; max-width: 42px; height: auto; display: block; margin: 0 auto; transition: transform 0.3s; }
        
        #moving-cat { position: absolute; width: 85px; height: auto; z-index: 15; top: 15px; transition: left 0.4s ease-in-out, top 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes cat-walk { 0% { transform: translateX(-5px) rotate(-1deg); } 50% { transform: translateX(5px) rotate(1deg); } 100% { transform: translateX(-5px) rotate(-1deg); } }
        .cat-moving { animation: cat-walk 0.4s infinite; }
        .bowl-highlight { transform: scale(1.15); z-index: 10 !important; filter: drop-shadow(0 0 8px rgba(255,215,0,0.5)); }
        .bowl-dimmed { opacity: 0.2; filter: blur(2px); z-index: 1 !important; }

        #roulette-container { position: relative; width: 90%; max-width: 300px; margin: 0 auto; display: flex; flex-direction: column; align-items: center; box-sizing: border-box; }
        .roulette-pin { position: absolute; top: -18px; left: 50%; transform: translateX(-50%); width: 34px; height: 44px; z-index: 20; filter: drop-shadow(0 3px 5px rgba(0,0,0,0.3)); }

        .btn-main {
            padding: 20px 10px; font-size: 1.1rem; font-weight: 800; background: var(--primary-color); color: var(--bg-color); border: none; border-radius: 20px;
            cursor: pointer; width: 85%; max-width: 320px; transition: all 0.1s;
            box-shadow: 0 8px 0 var(--btn-shadow); text-transform: uppercase;
            position: relative; top: 0; margin-bottom: 15px;
        }
        .btn-main:active:not(:disabled) { top: 4px; box-shadow: 0 4px 0 var(--btn-shadow); transform: scale(0.98); }

        .btn-sub {
            padding: 16px; font-size: 0.9rem; font-weight: 800; background: var(--card-bg); color: var(--text-main); border: 2px solid var(--text-main); border-radius: 20px;
            cursor: pointer; width: 85%; max-width: 320px; transition: all 0.1s;
            box-shadow: 0 3px 0 var(--btn-shadow); text-transform: uppercase; margin-bottom: 12px;
        }
        .btn-sub:active:not(:disabled) { transform: translateY(3px); box-shadow: 0 3px 0 var(--btn-shadow); }

        .btn-spin {
            padding: 18px; font-size: 1.2rem; font-weight: 900; background: #e74c3c; color: white; border: 3px solid #000; border-radius: 50px;
            cursor: pointer; width: 90%; max-width: 300px; transition: all 0.1s; margin: 20px auto;
            box-shadow: 0 6px 0 #333; text-transform: uppercase; display: block;
        }
        .btn-spin:active:not(:disabled) { transform: translateY(4px); box-shadow: 0 2px 0 #333; }
        .btn-spin:disabled { opacity: 0.4; cursor: not-allowed; box-shadow: none; transform: translateY(4px); }

        .btn-again { background-color: var(--btn-dark-gray) !important; box-shadow: 0 6px 0 #222 !important; }

        .backup-btn-group { display: flex; gap: 10px; margin-top: 15px; }
        .btn-backup { flex: 1; padding: 12px; font-size: 0.75rem; font-weight: 800; border-radius: 12px; border: 1px solid var(--tablet-border); background: var(--input-bg); color: var(--text-gray-70); cursor: pointer; transition: 0.2s; }
        .btn-backup:active { transform: translateY(2px); background: var(--tablet-border); }

        .menu-recommendation-box { text-align: center; padding: 20px 0; }
        .menu-result-display { font-size: 1.5rem; font-weight: 900; color: var(--point-red); margin: 15px 0; min-height: 2rem; }
        
        #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; display: none; align-items: flex-end; justify-content: center; backdrop-filter: blur(4px); }
        .modal-content { 
            background: var(--bg-color); width: 100%; max-width: 500px; border-radius: 30px 30px 0 0; padding: 20px 25px; box-sizing: border-box; 
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1); color: var(--text-main);
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        /* ÌåùÏóÖ Í∞ÑÍ≤© Ï§ÑÏûÑ */
        .modal-item { padding: 12px 5px; border-bottom: 1px solid var(--divider-color); text-align: center; cursor: pointer; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }

        #vibe-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 12000;
            display: none; align-items: flex-end; justify-content: center; backdrop-filter: blur(3px);
        }
        .vibe-modal {
            background: var(--card-bg); width: 100%; max-width: 500px; border-radius: 30px 30px 0 0;
            padding: 30px 25px; box-sizing: border-box; color: var(--text-main);
            box-shadow: 0 -5px 20px rgba(0,0,0,0.2); animation: slideUp 0.3s;
        }
        .vibe-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .vibe-title { font-family: 'Montserrat', sans-serif; font-weight: 900; font-size: 1.1rem; }
        .vibe-list { max-height: 250px; overflow-y: auto; }
        .vibe-item { 
            display: flex; align-items: center; padding: 12px 10px; border-radius: 15px; margin-bottom: 8px; cursor: pointer; transition: 0.2s;
            background: var(--input-bg); border: 1px solid transparent;
        }
        .vibe-item.playing { border-color: var(--point-red); background: rgba(255, 77, 77, 0.05); }
        .vibe-icon { font-size: 1.5rem; margin-right: 15px; width: 30px; text-align: center; }
        .vibe-info { flex: 1; text-align: left; }
        .vibe-name { font-weight: 800; font-size: 0.85rem; margin-bottom: 3px; }
        .vibe-desc { font-size: 0.65rem; color: #888; }
        .vibe-status { font-size: 0.7rem; font-weight: 900; color: var(--point-red); opacity: 0; }
        .vibe-item.playing .vibe-status { opacity: 1; }

        .monthly-king-badge {
            background: #fff8e1; border: 1.5px solid #ffca28; border-radius: 15px;
            padding: 10px 15px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;
            flex-wrap: nowrap; overflow: hidden;
        }
        body.dark-mode .monthly-king-badge { background: #332b1a; border-color: #ffca28; }
        .king-crown { font-size: 1.4rem; flex-shrink: 0; }
        .king-info { text-align: left; flex: 1; min-width: 0; }
        .king-name { font-weight: 900; font-size: 1rem; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        body.dark-mode .king-name { color: #f0f0f0; }
        .king-tag { font-size: 0.65rem; font-weight: 800; color: #ffca28; letter-spacing: 1px; white-space: nowrap; }
        .king-count-area { margin-left: auto; font-weight: 800; color: #ffca28; white-space: nowrap; flex-shrink: 0; }
        
        .white-dashboard {
            background-color: var(--white-dash-bg);
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            padding: 20px;
            border: 1px solid var(--tablet-border);
        }

        .history-item { display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid var(--divider-color); font-size: 0.85rem; font-weight: 600; color: var(--text-main); }
        .history-item:last-child { border-bottom: none; }
        
        .view-toggle-bar { display: flex; gap: 10px; margin-bottom: 15px; }
        .view-btn { flex: 1; padding: 10px; font-size: 0.7rem; font-weight: 800; border-radius: 12px; border: 1px solid var(--tablet-border); background: var(--input-bg); color: #bbb; cursor: pointer; }
        .view-btn.active { border-color: var(--primary-color); background: var(--primary-color); color: var(--bg-color); }

        .calendar-container { width: 100%; margin-top: 10px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day-label { font-size: 0.6rem; font-weight: 800; color: #bbb; padding: 5px 0; }
        .calendar-cell { 
            aspect-ratio: 1/1; border-radius: 8px; background: var(--input-bg); border: 1px solid var(--tablet-border); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; 
            transition: transform 0.1s, border-color 0.2s;
        }
        .calendar-cell.has-data { border-color: #ffca28; background: #fffdf5; cursor: pointer; }
        .calendar-cell.has-data:active { transform: scale(0.92); background: #fffae6; }
        body.dark-mode .calendar-cell.has-data { background: #2a2618; }
        .calendar-date-num { font-size: 0.65rem; font-weight: 700; color: var(--text-main); }
        .calendar-bean-icon { font-size: 0.7rem; margin-top: 2px; }

        .about-text { 
            font-size: 0.8rem; color: var(--text-gray-70); line-height: 1.6; text-align: left; 
            word-break: break-all; hyphens: auto;
        }
        .about-label { font-weight: 800; color: var(--text-main); margin-top: 15px; display: block; font-size: 0.85rem; }

        .receipt-container { width: 100%; display: flex; justify-content: center; margin: 15px 0; overflow: hidden; }
        .receipt {
            background: #fff !important; color: #333 !important; width: 280px; padding: 35px 25px 25px; font-family: 'Courier Prime', monospace;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1); border-radius: 2px; position: relative; margin: 0 auto;
            text-align: left;
        }
        .receipt.print-ani { animation: printEffect 1.2s cubic-bezier(0.2, 0, 0.2, 1) forwards; }
        @keyframes printEffect { 0% { transform: translateY(-100%); opacity: 0; } 20% { opacity: 1; } 100% { transform: translateY(0); opacity: 1; } }

        .receipt-header { font-size: 1.5rem; font-weight: 800; margin-bottom: 5px; letter-spacing: 2px; text-align: center; }
        .receipt-subheader { font-size: 0.75rem; margin-bottom: 20px; text-align: center; color: #666; font-weight: 700; }
        .receipt-line { border-top: 1px dashed #bbb; margin: 12px 0; width: 100%; }
        .receipt-item { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.85rem; width: 100%; font-weight: 600; }
        .receipt-total { display: flex; flex-direction: column; align-items: center; margin: 25px 0; padding: 15px 0; border-top: 2px solid #333; border-bottom: 2px solid #333; }
        .label-customer { font-size: 0.75rem; font-weight: 700; color: #888; margin-bottom: 8px; text-transform: uppercase; }
        .value-customer { font-size: 2.2rem; font-weight: 900; color: var(--point-red); letter-spacing: -1px; text-align: center; }
        .fortune-area { font-size: 0.75rem; line-height: 1.6; color: #555; text-align: center; margin-top: 15px; word-break: keep-all; font-style: italic; }

        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff !important; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.6s ease-out; }
        .loading-text { font-family: 'Courier Prime', monospace; font-size: 0.8rem; letter-spacing: 3px; margin-top: 20px; color: #000 !important; }
        .loading-bar-container { width: 150px; height: 4px; background: #eee; border-radius: 10px; margin-top: 10px; overflow: hidden; }
        .loading-bar-fill { height: 100%; width: 0%; background: #000 !important; transition: width 0.1s; }

        .lounge-tabs { display: flex; gap: 4px; margin-bottom: 15px; width: 100%; box-sizing: border-box; }
        .tab-btn { flex: 1; padding: 12px 2px; font-size: 0.7rem; font-weight: 800; border: 1px solid var(--tablet-border); border-radius: 12px; background: var(--input-bg); color: #bbb; cursor: pointer; transition: 0.2s; white-space: nowrap; overflow: visible; text-align: center; }
        .tab-btn.active { background: var(--primary-color); color: var(--bg-color); border-color: var(--primary-color); }
        .lounge-content { min-height: 250px; }
        
        .fortune-card-container { perspective: 1000px; width: 200px; height: 320px; margin: 20px auto; cursor: pointer; }
        .fortune-card { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .fortune-card.flipped { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-sizing: border-box; padding: 15px; }
        .card-front { background: var(--primary-color); color: var(--bg-color); }
        .card-back { background: var(--card-bg); color: var(--text-main); transform: rotateY(180deg); border: 2px solid var(--primary-color); }
        .fortune-text { font-size: 0.8rem; line-height: 1.4; margin: 10px 0; font-weight: 700; word-break: keep-all; }
        .fortune-item { font-size: 1.5rem; margin-bottom: 10px; }
        
        .dict-list { max-height: 300px; overflow-y: auto; text-align: left; }
        .dict-item { padding: 12px; border-bottom: 1px solid var(--divider-color); display: flex; align-items: flex-start; gap: 10px; }
        .dict-icon { font-size: 1.5rem; }
        .dict-info h4 { margin: 0 0 4px 0; font-size: 0.85rem; font-weight: 800; }
        .dict-info p { margin: 0; font-size: 0.7rem; color: var(--text-gray-70); line-height: 1.4; }

        .map-link-container { display: flex; flex-direction: column; gap: 12px; margin-top: 15px; align-items: center; width: 100%; }
        .map-btn {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            width: 90%; max-width: 280px; 
            padding: 14px; border-radius: 15px; border: none;
            font-size: 0.9rem; font-weight: 800; color: #fff; cursor: pointer;
            text-decoration: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        .map-btn.active { transform: translateY(2px); }
        .map-btn.naver { background-color: #03C75A; }
        .map-btn.kakao { background-color: #FEE500; color: #000; }
        .map-btn.google { background-color: #4285F4; }
        .map-desc { font-size: 0.75rem; color: var(--text-gray-70); margin-bottom: 20px; line-height: 1.5; word-break: keep-all; text-align: center; }

        /* ÌÜ†Ïä§Ìä∏ Î∞ïÏä§ Ï§ëÏïôÌòï ÎùºÏö¥Îìú Ïä§ÌÄòÏñ¥Î°ú ÏàòÏ†ï */
        #toast-box {
            position: fixed; 
            background: rgba(0,0,0,0.85); color: #fff; padding: 20px 30px;
            border-radius: 16px; font-size: 0.9rem; font-weight: 700;
            opacity: 0; transition: opacity 0.3s, transform 0.3s; 
            pointer-events: auto;
            z-index: 15000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: max-content;
            max-width: 80%;
            text-align: center;
        }
        #toast-box.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        /* ÌôîÏÇ¥Ìëú(ÎßêÌíçÏÑ† Íº¨Î¶¨) Ï†úÍ±∞ */
        #toast-box::after { display: none !important; }

        .btn-share { margin-top:15px; background:none; border:1px solid var(--text-gray-70); border-radius:12px; padding:6px 12px; font-size:0.65rem; color:var(--text-gray-70); cursor:pointer; }

        .footer { width: 100%; text-align: center; padding: 30px 0; font-size: 0.75rem; color: #888; letter-spacing: 1px; }
        .hidden { display: none !important; }

        /* ÌûàÏä§ÌÜ†Î¶¨ Î™®Îã¨ ÎÇ¥Î∂Ä ÏÇ≠Ï†ú Î≤ÑÌäºÏö© Ïä§ÌÉÄÏùº */
        .history-modal-item { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 10px 0; border-bottom: 1px solid var(--divider-color); }
        .history-modal-item:last-child { border-bottom: none; }
        .btn-del-record { background: none; border: none; color: #ccc; font-size: 1.2rem; cursor: pointer; padding: 0 5px; }
        .btn-del-record:hover { color: var(--point-red); }
    </style>
</head>
<body class="">

    <!-- Ï§ëÏïô ÌÜ†Ïä§Ìä∏ Î∞ïÏä§ -->
    <div id="toast-box"></div>

    <div id="splash-screen">
        <img src="images/coffee.png" alt="Logo" style="width:110px; animation: floating 2s ease-in-out infinite;">
        <div id="loading-progress-area">
            <div class="loading-text">LOADING...</div>
            <div class="loading-bar-container"><div id="progress-fill" class="loading-bar-fill"></div></div>
        </div>
        <div id="start-action-area" style="display:none; flex-direction:column; align-items:center; margin-top:20px; width: 100%;">
            <button class="btn-main" id="btn-start" style="border: 3px solid #000;" onclick="handleStartGame()">START GAME</button>
            <div id="start-hint" style="font-size:0.7rem; color:#bbb; margin-top:8px; letter-spacing:1px; font-weight:800;">TAP TO BREW LUCK</div>
        </div>
    </div>

    <audio id="bgm-player" loop preload="auto">
        <source src="sounds/cafe_music_bgm.mp3" type="audio/mpeg">
    </audio>

    <!-- Í≥µÏö© Î™®Îã¨Ï∞Ω (Í∑∏Î£π, Ïù∏Ïõê, ÌûàÏä§ÌÜ†Î¶¨Ïö©) -->
    <div id="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="modal-list-container"></div>
            <button class="btn-text" id="btn-modal-close" style="width:100%; margin-top:20px; padding:15px; color:#bbb; border:1px solid #eee; border-radius:14px;" onclick="closeModal()">CLOSE</button>
        </div>
    </div>

    <div id="vibe-modal-overlay" onclick="toggleVibeModal(false)">
        <div class="vibe-modal" onclick="event.stopPropagation()">
            <div class="vibe-header">
                <span class="vibe-title">üéß CAFE VIBE</span>
                <span style="cursor:pointer; font-size:1.5rem;" onclick="toggleVibeModal(false)">√ó</span>
            </div>
            <div class="setting-row" style="margin-bottom:20px;">
                <span class="toggle-label">PLAY IN BACKGROUND</span>
                <label class="switch">
                    <input type="checkbox" id="vibe-bg-toggle" onchange="toggleVibeBgMode()">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="vibe-list" id="vibe-track-list"></div>
        </div>
    </div>

    <div class="wrapper">
        <header onclick="goFront()">
            <div class="title-container">
                <span class="title-lucky">lucky</span><span class="title-bean">bean</span>
            </div>
            <button id="btn-cafe-vibe" onclick="event.stopPropagation(); toggleVibeModal(true)">
                <span>üéß</span> VIBE
            </button>
        </header>

        <main id="main-content">
            <div class="game-screen">
                <img src="images/cafe_facade.png" alt="Cafe" id="main-img" class="title-image">
                <div id="rpg-textbox"><div id="rpg-content"></div></div>
            </div>

            <div id="front-view" class="fade-in-view">
                <div style="display: flex; flex-direction: column; align-items: center; width: 100%;">
                    <button class="btn-main" id="btn-enter-shop" onclick="showGameSelector()">ENTER SHOP</button>
                    <button class="btn-sub" id="btn-go-setup" onclick="goSetup()">SETTINGS</button>
                    <button class="btn-sub" id="btn-go-lounge" onclick="goLounge()">LOUNGE</button>
                    <button class="btn-sub" id="btn-go-history" onclick="goHistory()">HISTORY</button>
                    <button class="btn-sub" id="btn-go-about" onclick="goAbout()">ABOUT</button>
                </div>
            </div>

            <div id="selector-view" class="hidden">
                <div class="card-container">
                    <div class="order-menu-header" style="margin-bottom: 25px;">
                        <span id="txt-choose-luck">CHOOSE YOUR LUCK</span>
                        <div class="header-icon-group">
                            <span class="recording-dot"></span>
                            <button class="settings-icon-btn" onclick="goSetup('selector')">‚öôÔ∏è</button>
                        </div>
                    </div>
                    <div class="icon-selector-grid">
                        <div class="icon-btn-item" onclick="handleGameSelection('hand')">
                            <div class="icon-square"><img src="images/random_hand.png" alt="Hand"></div>
                            <div class="icon-label" id="txt-game-hand">Random Hand</div>
                        </div>
                        <div class="icon-btn-item" onclick="handleGameSelection('roulette')">
                            <div class="icon-square"><img src="images/lucky_roulette.png" alt="Roulette"></div>
                            <div class="icon-label" id="txt-game-roulette">Lucky Roulette</div>
                        </div>
                        <div class="icon-btn-item" onclick="handleGameSelection('cat')">
                            <div class="icon-square"><img src="images/cat_icon.png" alt="Cat" style="width:70%;"></div>
                            <div class="icon-label" id="txt-game-cat">Cat's Choice</div>
                        </div>
                    </div>
                </div>
                <button class="btn-main" id="btn-back-menu-selector" onclick="goFront()">BACK TO HOME</button>
            </div>

            <div id="setup-view" class="hidden">
                <div class="card-container" style="text-align: left;">
                    <div class="order-menu-header">
                        <span id="txt-setting-title">üìã GAME SETTING</span>
                        <div class="lang-toggle-container">
                            <button id="lang-ko" class="lang-btn" onclick="setLanguage('ko')">KO</button>
                            <button id="lang-en" class="lang-btn" onclick="setLanguage('en')" style="margin-left:3px;">EN</button>
                            <button id="lang-jp" class="lang-btn" onclick="setLanguage('jp')" style="margin-left:3px;">JP</button>
                        </div>
                    </div>
                    <div class="divider" style="margin-bottom: 15px;"></div>
                    <div class="setting-row">
                        <span class="toggle-label" id="lbl-darkmode">CAFE NIGHT (DARK MODE)</span>
                        <label class="switch">
                            <input type="checkbox" id="dark-toggle" onchange="toggleDarkMode()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="picker-group">
                        <div class="picker-btn" onclick="openGroupModal()">
                            <span class="picker-label" id="lbl-group">GROUP</span>
                            <div class="picker-value"><span id="display-group-name">Empty</span></div>
                        </div>
                        <div class="picker-btn" onclick="openMemberModal()">
                            <span class="picker-label" id="lbl-members">MEMBERS</span>
                            <div class="picker-value"><span id="display-member-count">3 Members</span></div>
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="toggle-label" id="lbl-history-onoff">HISTORY RECORDING</span>
                        <label class="switch">
                            <input type="checkbox" id="history-toggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="name-mgmt-bar">
                        <button class="btn-text" id="btn-random" onclick="fillRandomNames()">RANDOM</button>
                        <button class="btn-text" id="btn-clear" onclick="clearNames()">CLEAR</button>
                        <button class="btn-text" id="btn-save-team" onclick="saveCurrentTeam()" style="color:#888;">SAVE</button>
                    </div>
                    <div class="divider"></div>
                    <div id="name-input-container"></div>
                    
                    <div class="divider" style="margin-top:20px;"></div>
                    <div style="font-size:0.7rem; color:#bbb; font-weight:800; margin-bottom:5px;" id="lbl-backup-title">DATA BACKUP</div>
                    <div class="backup-btn-group">
                         <button class="btn-backup" id="btn-backup-export" onclick="exportData()">EXPORT</button>
                         <button class="btn-backup" id="btn-backup-import" onclick="importData()">IMPORT</button>
                    </div>
                </div>
                <div style="display: flex; flex-direction: column; align-items: center; width: 100%;">
                    <button class="btn-main" id="btn-save-settings" onclick="handleSaveSettings()">SAVE</button>
                    <button class="btn-sub" id="btn-settings-back" onclick="handleSetupBack()">BACK</button>
                </div>
            </div>

            <!-- Hand, Roulette, Cat views (Í∏∞Ï°¥ Ïú†ÏßÄ) -->
            <div id="game-view" class="hidden">
                <div class="card-container" style="text-align:left;">
                    <div class="order-menu-header">
                        <span id="txt-game-hand-title">üëä RANDOM HAND</span>
                        <div class="header-icon-group">
                            <button id="btn-mix-header" class="btn-mix-rect" onclick="shufflePositions()">MIX</button>
                            <span class="recording-dot"></span>
                            <button class="settings-icon-btn" onclick="goSetup('hand')">‚öôÔ∏è</button>
                        </div>
                    </div>
                    <div class="divider"></div>
                    <div class="game-canvas-area" style="min-height: 200px;">
                        <div id="hand-display"></div>
                    </div>
                    <button id="btn-hand-start" class="btn-spin" onclick="startHandGame()">START GAME</button>
                    <div id="hand-result-anchor"></div>
                    <div id="lucky-area" class="hidden" style="margin-bottom:20px; font-weight:900; color:#f1c40f; font-size:1.2rem; text-shadow: 1px 1px 0px #000; text-align: center;">üåü EXTRA LUCK! ALL PASS! üåü</div>
                    <button id="hand-again-btn" class="btn-spin btn-again hidden" onclick="confirmReplay('hand')">REPLAY</button>
                </div>
                <div id="game-btn-group" style="display:flex; flex-direction:column; align-items:center; gap:8px; width:100%;">
                    <button class="btn-main" id="btn-back-selector-hand" onclick="showGameSelector()">CHANGE GAME</button>
                    <button class="btn-sub" id="btn-back-menu-hand" onclick="goFront()">BACK TO HOME</button>
                </div>
            </div>

            <div id="roulette-view" class="hidden">
                <div class="card-container" style="text-align:left;">
                    <div class="order-menu-header">
                        <span id="txt-roulette-title">üé° LUCKY ROULETTE</span>
                        <div class="header-icon-group" style="float:right;">
                            <span class="recording-dot"></span>
                            <button class="settings-icon-btn" onclick="goSetup('roulette')">‚öôÔ∏è</button>
                        </div>
                    </div>
                    <div class="divider"></div>
                    <div class="game-canvas-area" style="min-height: 380px; justify-content: center;">
                        <div id="roulette-container">
                            <svg class="roulette-pin" viewBox="0 0 30 40">
                                <path d="M15 0 L30 20 L15 40 L0 20 Z" fill="#e74c3c" stroke="#000" stroke-width="2"/>
                            </svg>
                            <canvas id="rouletteCanvas" width="400" height="400" style="width:100%; max-width:320px; border-radius:50%; border:6px solid #333;"></canvas>
                        </div>
                    </div>
                    <button id="roulette-spin-btn" class="btn-spin" onclick="spinRoulette()">SPIN</button>
                    <div id="roulette-result-anchor"></div>
                    <button id="roulette-again-btn" class="btn-spin btn-again hidden" onclick="confirmReplay('roulette')">REPLAY</button>
                </div>
                <div id="roulette-action-area" style="display:flex; flex-direction:column; align-items:center; width:100%; gap:8px;">
                     <button class="btn-main" id="btn-back-selector-roulette" onclick="showGameSelector()">CHANGE GAME</button>
                     <button class="btn-sub" id="btn-back-menu-roulette" onclick="goFront()">BACK TO HOME</button>
                </div>
            </div>

            <div id="cat-view" class="hidden">
                <div class="card-container" style="text-align:left;">
                    <div class="order-menu-header">
                        <span id="txt-cat-title">üêà CAT'S CHOICE</span>
                        <div class="header-icon-group" style="float:right;">
                            <span class="recording-dot"></span>
                            <button class="settings-icon-btn" onclick="goSetup('cat')">‚öôÔ∏è</button>
                        </div>
                    </div>
                    <div class="divider"></div>
                    <div id="cat-white-box" class="game-canvas-area" style="min-height: 320px;">
                        <img src="images/cat_stand.png" id="moving-cat" alt="Cat" style="left: 50%; transform: translateX(-50%);">
                        <div id="bowls-container"></div>
                    </div>
                    <button id="cat-start-btn" class="btn-spin" onclick="startCatGame()">START</button>
                    <div id="cat-result-anchor"></div>
                    <button id="cat-again-btn" class="btn-spin btn-again hidden" onclick="confirmReplay('cat')">REPLAY</button>
                </div>
                <div id="cat-action-area" style="display:flex; flex-direction:column; align-items:center; width:100%; gap:8px;">
                    <button class="btn-main" id="btn-back-selector-cat" onclick="showGameSelector()">CHANGE GAME</button>
                    <button class="btn-sub" id="btn-back-menu-cat" onclick="goFront()">BACK TO HOME</button>
                </div>
            </div>

            <div id="receipt-prototype-area" class="hidden">
                <div class="receipt-container">
                    <div class="receipt">
                        <div class="receipt-header">RECEIPT</div>
                        <div class="receipt-subheader">LUCKY BEAN SHOP</div>
                        <div class="receipt-item"><span class="receipt-date"></span><span class="receipt-order-no"></span></div>
                        <div class="receipt-line"></div>
                        <div class="receipt-item"><span class="receipt-menu"></span><span class="receipt-qty"></span></div>
                        <div class="receipt-item"><span class="txt-lbl-unit">UNIT PRICE</span><span class="receipt-price"></span></div>
                        <div class="divider" style="margin: 10px 0; border-top: 1px dashed #bbb;"></div>
                        <div class="receipt-item" style="font-weight:800;"><span class="txt-lbl-sub">SUBTOTAL</span><span class="receipt-subtotal"></span></div>
                        <div class="receipt-total">
                            <span class="label-customer txt-lbl-payer">SELECTED CUSTOMER</span>
                            <span class="receipt-payer value-customer"></span>
                        </div>
                        <div class="receipt-line"></div>
                        <div class="fortune-area receipt-fortune"></div>
                        <button class="btn-text btn-capture-run" style="width:100%; margin-top: 15px; color:#ccc; border:1px solid #eee; border-radius:10px; padding:8px; font-size:0.6rem;">GET A RECEIPT</button>
                    </div>
                </div>
            </div>

            <!-- Lounge, About views (Í∏∞Ï°¥ Ïú†ÏßÄ) -->
            <div id="lounge-view" class="hidden">
                <div class="card-container" style="text-align: left;">
                    <div class="order-menu-header" id="txt-lounge-title">ü™ë COFFEE LOUNGE</div>
                    <div class="divider"></div>
                    <div class="lounge-tabs">
                        <button id="btn-tab-fortune" class="tab-btn active" onclick="switchLoungeTab('fortune')">FORTUNE</button>
                        <button id="btn-tab-menu" class="tab-btn" onclick="switchLoungeTab('menu')">MENU</button>
                        <button id="btn-tab-dict" class="tab-btn" onclick="switchLoungeTab('dict')">DICT</button>
                        <button id="btn-tab-map" class="tab-btn" onclick="switchLoungeTab('map')">NEARBY</button>
                    </div>
                    <div class="lounge-content">
                        <div id="lounge-fortune-sec">
                            <div class="fortune-card-container" onclick="drawDailyFortune()">
                                <div class="fortune-card" id="daily-fortune-card">
                                    <div class="card-front">
                                        <div style="font-size:3rem;">üò∫</div>
                                        <div style="font-size:0.8rem; font-weight:800; margin-top:10px;" id="txt-tap-card">TAP FOR LUCK</div>
                                    </div>
                                    <div class="card-back">
                                        <div class="fortune-item" id="fortune-icon">‚òï</div>
                                        <div class="fortune-text" id="fortune-msg" style="color:var(--point-red);"></div>
                                        <div class="fortune-text" style="font-size:0.7rem; color:#444; margin-top:5px; font-weight:normal;" id="fortune-detail"></div>
                                        <div style="margin-top:8px; font-size:0.75rem; font-weight:800; color:#555;">
                                            <span id="txt-score-label">SCORE</span>: <span style="color:var(--roulette-gold); font-size:1rem;">‚≠ê</span> <span id="fortune-score"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style="text-align:center;"><button class="btn-share" onclick="shareFortune()" id="btn-share-fortune">SHARE CARD</button></div>
                        </div>
                        <div id="lounge-menu-sec" class="hidden">
                             <div class="menu-recommendation-box">
                                 <div style="margin-bottom:10px;"><img src="images/coffee.png" id="menu-img-display" alt="Coffee" style="width:100px; height:auto; animation: floating 3s ease-in-out infinite;"></div>
                                 <div style="font-size:0.8rem; color:#888; min-height:1.2rem;" id="txt-menu-q">What should I drink?</div>
                                 <div class="menu-result-display" id="menu-recommend-result">?</div>
                                 <button class="btn-mix-rect" onclick="recommendMenu()" style="margin:0 auto; padding:10px 20px;">PICK MENU</button>
                             </div>
                        </div>
                        <div id="lounge-dict-sec" class="hidden"><div class="dict-list" id="coffee-dict-list"></div></div>
                        <div id="lounge-map-sec" class="hidden" style="text-align:center; padding:10px 0;">
                            <div class="map-desc" id="txt-map-desc">Find the best coffee spots near you!</div>
                            <div class="map-link-container">
                                <a href="https://map.naver.com/p/search/%EB%82%B4%EC%A3%BC%EB%B3%80%20%EC%B9%B4%ED%8E%98" target="_blank" class="map-btn naver"><span>N</span> NAVER MAP</a>
                                <a href="https://map.kakao.com/link/search/%EC%B9%B4%ED%8E%98" target="_blank" class="map-btn kakao"><span>K</span> KAKAO MAP</a>
                                <a href="https://www.google.com/maps/search/coffee+near+me" target="_blank" class="map-btn google"><span>G</span> GOOGLE MAPS</a>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="btn-main" id="btn-back-home-lounge" onclick="goFront()">BACK TO HOME</button>
            </div>

            <div id="about-view" class="hidden">
                <div class="card-container" style="text-align: left;">
                    <div class="order-menu-header" id="txt-about-title">‚òï ABOUT LUCKY BEAN</div>
                    <div class="divider"></div>
                    <div class="about-text" id="txt-about-content"></div>
                </div>
                <button class="btn-main" id="btn-back-home-about" onclick="goFront()">BACK TO HOME</button>
            </div>

            <div id="history-view" class="hidden">
                <div class="card-container" style="text-align: left;">
                    <div class="order-menu-header" id="txt-history-title">üèÜ DONATION HISTORY</div>
                    <div class="divider"></div>
                    <div class="view-toggle-bar">
                        <button id="btn-view-list" class="view-btn active" onclick="switchHistoryView('list')">LIST</button>
                        <button id="btn-view-cal" class="view-btn" onclick="switchHistoryView('cal')">CALENDAR</button>
                    </div>
                    <div id="history-content-area">
                        <div id="history-list-view">
                            <div id="monthly-king-area"></div>
                            <div class="white-dashboard">
                                <div id="history-list-content"></div>
                            </div>
                        </div>
                        <div id="history-cal-view" class="hidden">
                            <div class="calendar-container" id="calendar-render-area"></div>
                        </div>
                    </div>
                    <button class="btn-text" id="btn-reset-all" onclick="resetStats()" style="width:100%; margin-top:15px; color:var(--point-red);">RESET ALL DATA</button>
                </div>
                <button class="btn-main" id="btn-back-home-history" onclick="goFront()">BACK TO HOME</button>
            </div>
        </main>
        <div class="footer">v0.6.49 | ‚ìí 2026. Gonystudio. All rights reserved.</div>
    </div>

<script>
        /* --- 1. Localization Data (i18n) --- */
        const i18n = {
            en: {
                welcome: "Welcome to the Lucky Bean!",
                choose_luck: "Choose your luckiest game!",
                setting_msg: "Settings: Manage your team.",
                msg_setup_guide: "Please select your theme and members.",
                how_to: "How to play and track donations.",
                history_msg: "Who donated the most coffee?",
                pick_hand: "Who will pay? Pick a hand!",
                hands_mixed: "Hands Mixed!",
                safe_msg: " is Safe!",
                pay_msg: " will pay!",
                lucky_round: "LUCKY! Everyone is SAFE! üåü",
                spin_msg: "Spin the wheel for luck!",
                cat_msg: "Wait for the cat's choice...",
                cat_start: "Who will the cat visit?",
                all_pass: "üåü Lucky Pass üåü",
                all_pass_unbelievable: "üåü UNBELIEVABLE! Lucky Pass! üåü",
                btn_start: "START GAME",
                btn_enter_shop: "ENTER SHOP",
                btn_lounge: "LOUNGE",
                btn_setup: "SETTINGS",
                btn_history: "HISTORY",
                btn_about: "ABOUT",
                btn_back_menu: "BACK TO HOME",
                btn_back_home: "BACK TO HOME",
                btn_save_exit: "SAVE & EXIT", 
                btn_save_only: "SAVE", 
                btn_back_only: "BACK", 
                msg_saved: "Settings Saved!", 
                msg_confirm_discard: "You have unsaved changes. Save them?", 
                btn_shuffle: "SHUFFLE",
                btn_again: "REPLAY",
                btn_spin: "SPIN",
                btn_change_game: "CHANGE GAME",
                lbl_group: "GROUP",
                lbl_members: "P", 
                lbl_random: "RANDOM",
                lbl_clear: "CLEAR",
                lbl_save: "SAVE",
                lbl_kings: "üèÜ DONATION KINGS",
                lbl_unit_price: "UNIT PRICE",
                lbl_subtotal: "SUBTOTAL",
                lbl_selected: "SELECTED CUSTOMER",
                lbl_get_receipt: "GET A RECEIPT",
                lbl_monthly_king: "MONTHLY KING",
                lbl_darkmode: "CAFE NIGHT (DARK MODE)",
                lbl_times: "times",
                lbl_empty: "Empty",
                lbl_history_onoff: "HISTORY RECORDING",
                confirm_replay: "Are you sure you want to replay?",
                btn_mix: "MIX",
                txt_about_content: `<span class="about-label">WHAT IS LUCKY BEAN?</span> Lucky Bean is the ultimate mini-game app for coffee-loving teams! It turns the daily "Who pays?" moment into a thrilling mini-game.<br><br><span class="about-label">HOW TO PLAY</span> 1. Enter names in SETTINGS. You can save groups for quick access later!<br>2. Go to ENTER SHOP and pick your favorite game: Random Hand, Roulette, or Cat.<br>3. Interact with the game. The 'Chosen One' pays! You can capture and share the receipt.<br><br><span class="about-label">HISTORY & RANKING</span> Win records are automatically stored in HISTORY. You can track donation stats in LIST mode or tap the coffee icon in CALENDAR mode to see who paid on that day.`,
                menus: ["Americano", "Cafe Latte", "Vanilla Latte", "Flat White", "Cold Brew", "Einspanner", "Cappuccino", "Cafe Mocha", "Long Black", "Espresso"],
                days: ["S", "M", "T", "W", "T", "F", "S"],
                lounge_title: "ü™ë COFFEE LOUNGE",
                lounge_tab_fortune: "FORTUNE",
                lounge_tab_menu: "MENU",
                lounge_tab_dict: "DICT",
                lounge_tab_map: "NEARBY",
                map_desc: "Find the best coffee spots near you!",
                fortune_tap: "TAP FOR LUCK",
                lounge_msg: "Relax with a cup of virtual coffee.",
                menu_q: "What should I drink?",
                coffee_dict: {
                    "Americano": "Espresso diluted with hot water. Clean and simple.",
                    "Cafe Latte": "Espresso with steamed milk. Smooth and creamy.",
                    "Vanilla Latte": "Latte with sweet vanilla syrup.",
                    "Flat White": "Similar to Latte but with less foam. Stronger taste.",
                    "Cold Brew": "Brewed with cold water for a long time. Smooth finish.",
                    "Einspanner": "Espresso topped with cool whipped cream. Sweet & bitter.",
                    "Cappuccino": "Espresso + Steamed Milk + Thick Foam.",
                    "Cafe Mocha": "Espresso + Chocolate + Milk + Cream.",
                    "Long Black": "Hot water + Espresso (Crema preserved).",
                    "Espresso": "Pure coffee extract. Strong & intense."
                },
                lbl_backup_title: "DATA BACKUP",
                btn_export: "EXPORT",
                btn_import: "IMPORT",
                btn_share: "SHARE CARD",
                fortune_score: "Luck Score",
                msg_retry_fortune: "Draw a new fortune?",
                fortunes: [
                    { summary: "Great Luck!", detail: "Your work efficiency will skyrocket today.", score: 98 },
                    { summary: "Unexpected Gift", detail: "A sweet surprise is coming your way.", score: 92 },
                    { summary: "Sweet Break", detail: "Enjoy a perfect moment of peace.", score: 85 },
                    { summary: "Creative Flow", detail: "Brilliant ideas will pop up easily.", score: 94 },
                    { summary: "Good News", detail: "Something you've waited for will arrive.", score: 88 },
                    { summary: "Helpful Hand", detail: "You will meet someone who helps you.", score: 90 },
                    { summary: "Small Luck", detail: "A little happiness is in your pocket.", score: 75 },
                    { summary: "Tasty Coffee", detail: "Today's coffee will taste exceptional.", score: 80 },
                    { summary: "Praise Day", detail: "Your efforts will be recognized.", score: 95 },
                    { summary: "Problem Solved", detail: "A tricky issue will be resolved smoothly.", score: 89 }
                ]
            },
            ko: {
                welcome: "Îü≠ÌÇ§ÎπàÏóê Ïò§Ïã† Í≤ÉÏùÑ ÌôòÏòÅÌï©ÎãàÎã§!",
                choose_luck: "Í∞ÄÏû• Ïö¥ Ï¢ãÏùÄ Í≤åÏûÑÏùÑ Í≥®ÎùºÎ≥¥ÏÑ∏Ïöî!",
                setting_msg: "ÏÑ§Ï†ï: ÌåÄ Î©§Î≤ÑÎ•º Í¥ÄÎ¶¨ÌïòÏÑ∏Ïöî.",
                msg_setup_guide: "ÏõêÌïòÏãúÎäî ÌÖåÎßà Î∞è Ïù∏ÏõêÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.",
                how_to: "Í≤åÏûÑ Î∞©Î≤ï Î∞è ÌûàÏä§ÌÜ†Î¶¨ ÏïàÎÇ¥",
                history_msg: "ÎàÑÍ∞Ä Í∞ÄÏû• Ïª§ÌîºÎ•º ÎßéÏù¥ ÏÉÄÏùÑÍπåÏöî?",
                pick_hand: "ÎàÑÍ∞Ä ÎÇºÍπåÏöî? ÏÜêÏùÑ Í≥®ÎùºÎ≥¥ÏÑ∏Ïöî!",
                hands_mixed: "ÏÜêÏù¥ ÏÑûÏòÄÏäµÎãàÎã§!",
                safe_msg: " ÎãòÏùÄ ÏÉùÏ°¥!",
                pay_msg: " ÎãòÏù¥ ÎãπÏ≤®ÎêòÏóàÏäµÎãàÎã§!",
                lucky_round: "Îü≠ÌÇ§! Î™®Îëê ÏÉùÏ°¥ÌñàÏäµÎãàÎã§! üåü",
                spin_msg: "Î£∞Î†õÏùÑ ÎèåÎ†§ Ïö¥ÏùÑ ÏãúÌóòÌïòÏÑ∏Ïöî!",
                cat_msg: "Í≥†ÏñëÏù¥Í∞Ä Í≥†ÎØº Ï§ëÏûÖÎãàÎã§...",
                cat_start: "Í≥†ÏñëÏù¥Îäî ÎàÑÍµ¨ÏóêÍ≤å Í∞àÍπåÏöî?",
                all_pass: "üåü Lucky Pass üåü",
                all_pass_unbelievable: "üåü ÎåÄÎ∞ï! Lucky PassÏûÖÎãàÎã§! üåü",
                btn_start: "Í≤åÏûÑ ÏãúÏûë",
                btn_enter_shop: "ÏûÖÏû•ÌïòÍ∏∞",
                btn_lounge: "Ìú¥Í≤åÏã§",
                btn_setup: "ÏÑ§Ï†ï",
                btn_history: "ÌûàÏä§ÌÜ†Î¶¨",
                btn_about: "Ï†ïÎ≥¥",
                btn_back_menu: "ÌôàÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞",
                btn_back_home: "ÌôàÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞",
                btn_save_exit: "Ï†ÄÏû• Î∞è ÎÇòÍ∞ÄÍ∏∞",
                btn_save_only: "Ï†ÄÏû•ÌïòÍ∏∞",
                btn_back_only: "Îí§Î°úÍ∞ÄÍ∏∞",
                msg_saved: "Ï†ÄÏû• ÏôÑÎ£å!",
                msg_confirm_discard: "Î≥ÄÍ≤ΩÏÇ¨Ìï≠Ïù¥ ÏûàÏäµÎãàÎã§. Ï†ÄÏû•ÌïòÏãúÍ≤†ÏäµÎãàÍπå?",
                btn_shuffle: "ÏÖîÌîå",
                btn_again: "Îã§ÏãúÌïòÍ∏∞",
                btn_spin: "ÎèåÎ¶¨Í∏∞",
                btn_change_game: "Í≤åÏûÑ Î≥ÄÍ≤Ω",
                lbl_group: "Í∑∏Î£π",
                lbl_members: "Ïù∏Ïõê",
                lbl_random: "ÎûúÎç§",
                lbl_clear: "Ï¥àÍ∏∞Ìôî",
                lbl_save: "Ï†ÄÏû•",
                lbl_kings: "üèÜ Ïò§ÎäòÏùò Í∏∞Î∂ÄÏôï",
                lbl_unit_price: "Îã®Í∞Ä",
                lbl_subtotal: "Ìï©Í≥Ñ",
                lbl_selected: "ÎãπÏ≤®Ïûê",
                lbl_get_receipt: "ÏòÅÏàòÏ¶ù Î∞õÍ∏∞",
                lbl_monthly_king: "Ïù¥Îã¨Ïùò Í∏∞Î∂ÄÏôï",
                lbl_darkmode: "Ïπ¥Ìéò ÎÇòÏù¥Ìä∏ (Îã§ÌÅ¨ Î™®Îìú)",
                lbl_times: "Ìöå",
                lbl_empty: "ÎπÑÏñ¥ÏûàÏùå",
                lbl_history_onoff: "Í≤åÏûÑ Í∏∞Î°ù Ï†ÄÏû•",
                confirm_replay: "Ï†ïÎßê Í≤åÏûÑÏùÑ Îã§Ïãú ÏãúÏûëÌïòÏãúÍ≤†ÏäµÎãàÍπå?",
                btn_mix: "ÏÑûÍ∏∞",
                txt_about_content: `<span class="about-label">Îü≠ÌÇ§ÎπàÏù¥ÎûÄ?</span> Ïª§ÌîºÎ•º ÏÇ¨ÎûëÌïòÎäî ÎèôÎ£åÎì§ÏùÑ ÏúÑÌïú ÏµúÍ≥†Ïùò Î≥µÎ∂àÎ≥µ ÎèÑÍµ¨ÏûÖÎãàÎã§. Îß§Ïùº ÎèåÏïÑÏò§Îäî "ÎàÑÍ∞Ä Ïª§Ìîº ÏÇ¥Íπå?"Ïùò Í≥†ÎØºÏùÑ ÏßúÎ¶øÌïú ÎØ∏Îãà Í≤åÏûÑÏúºÎ°ú Ï¶êÍ≤®Î≥¥ÏÑ∏Ïöî!<br><br><span class="about-label">Í≤åÏûÑ Î∞©Î≤ï</span> 1. SETTINGSÏóêÏÑú ÌåÄÏõê Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî. Í∑∏Î£π Ï†ÄÏû•Ïù¥ Í∞ÄÎä•Ìï¥ Ìé∏Î¶¨Ìï©ÎãàÎã§.<br>2. ENTER SHOPÏóêÏÑú ÏõêÌïòÎäî Í≤åÏûÑÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.<br>3. Í≤åÏûÑÏóê Ï∞∏Ïó¨ÌïòÎ©¥ ÌñâÏö¥Ïùò ÎãπÏ≤®ÏûêÍ∞Ä Í≤∞Ï†ïÎê©ÎãàÎã§. ÎãπÏ≤®Îêú ÏÇ¨ÎûåÏù¥ Í≤∞Ï†ú! ÏòÅÏàòÏ¶ùÏùÑ Ï∫°Ï≤òÌï¥ Í≥µÏú†Ìï¥Î≥¥ÏÑ∏Ïöî.<br><br><span class="about-label">ÌûàÏä§ÌÜ†Î¶¨ Î∞è Îû≠ÌÇπ</span> Í≤åÏûÑ Í∏∞Î°ùÏù¥ ÏºúÏ†∏ ÏûàÏúºÎ©¥ ÌûàÏä§ÌÜ†Î¶¨Ïóê ÏûêÎèô Í∏∞Î°ùÎê©ÎãàÎã§. LIST Î™®ÎìúÏóêÏÑú Îû≠ÌÇπÏùÑ ÌôïÏù∏ÌïòÍ±∞ÎÇò, CALENDAR Î™®ÎìúÏóêÏÑú Ïª§Ìîº ÏïÑÏù¥ÏΩòÏùÑ ÎàåÎü¨ Ìï¥Îãπ ÎÇ†ÏßúÏùò ÎãπÏ≤®ÏûêÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.`,
                menus: ["ÏïÑÎ©îÎ¶¨Ïπ¥ÎÖ∏", "Ïπ¥ÌéòÎùºÎñº", "Î∞îÎãêÎùºÎùºÎñº", "ÌîåÎû´ÌôîÏù¥Ìä∏", "ÏΩúÎìúÎ∏åÎ£®", "ÏïÑÏù∏ÏäàÌéòÎÑà", "Ïπ¥Ìë∏ÏπòÎÖ∏", "Ïπ¥ÌéòÎ™®Ïπ¥", "Î°±Î∏îÎûô", "ÏóêÏä§ÌîÑÎ†àÏÜå"],
                days: ["Ïùº", "Ïõî", "Ìôî", "Ïàò", "Î™©", "Í∏à", "ÌÜ†"],
                lounge_title: "ü™ë Ïª§Ìîº Ìú¥Í≤åÏã§",
                lounge_tab_fortune: "Ïö¥ÏÑ∏",
                lounge_tab_menu: "Î©îÎâ¥",
                lounge_tab_dict: "ÎèÑÍ∞ê",
                lounge_tab_map: "Ï£ºÎ≥Ä",
                map_desc: "ÌòÑÏû¨ ÏúÑÏπò Ï£ºÎ≥ÄÏùò ÎßõÏûàÎäî Ïπ¥ÌéòÎ•º Ï∞æÏïÑÎ≥¥ÏÑ∏Ïöî!",
                fortune_tap: "Ïπ¥ÎìúÎ•º ÎàåÎü¨Î≥¥ÏÑ∏Ïöî",
                lounge_msg: "Îî∞ÎúªÌïú Ïª§ÌîºÏôÄ Ìï®Íªò Ïû†Ïãú Ïâ¨Ïñ¥Í∞ÄÏÑ∏Ïöî.",
                menu_q: "Ïò§Îäò Î≠ê ÎßàÏãúÏßÄ?",
                coffee_dict: {
                    "ÏïÑÎ©îÎ¶¨Ïπ¥ÎÖ∏": "ÏóêÏä§ÌîÑÎ†àÏÜåÏóê Îú®Í±∞Ïö¥ Î¨ºÏùÑ Ìù¨ÏÑùÌïú Ïª§Ìîº. ÍπîÎÅîÌï®Ïùò Ï†ïÏÑù.",
                    "Ïπ¥ÌéòÎùºÎñº": "ÏóêÏä§ÌîÑÎ†àÏÜåÏôÄ Ïä§ÌåÄ Ïö∞Ïú†Ïùò Ï°∞Ìôî. Î∂ÄÎìúÎüΩÍ≥† Í≥†ÏÜåÌïú Îßõ.",
                    "Î∞îÎãêÎùºÎùºÎñº": "ÎùºÎñºÏóê Îã¨ÏΩ§Ìïú Î∞îÎãêÎùº ÏãúÎüΩÏùÑ ÎçîÌïú Ïª§Ìîº.",
                    "ÌîåÎû´ÌôîÏù¥Ìä∏": "ÎùºÎñºÎ≥¥Îã§ ÌèºÏù¥ ÏñáÍ≥† ÏóêÏä§ÌîÑÎ†àÏÜå ÎßõÏù¥ ÏßÑÌïú Ïª§Ìîº.",
                    "ÏΩúÎìúÎ∏åÎ£®": "Ï∞¨Î¨ºÎ°ú Ïò§Îûú ÏãúÍ∞Ñ Ïö∞Î†§ÎÇ¥Ïñ¥ Ïì¥ÎßõÏù¥ Ï†ÅÍ≥† Î∂ÄÎìúÎü¨ÏõÄ.",
                    "ÏïÑÏù∏ÏäàÌéòÎÑà": "ÏïÑÎ©îÎ¶¨Ïπ¥ÎÖ∏ ÏúÑÏóê Ï∞®Í∞ÄÏö¥ ÌúòÌïëÌÅ¨Î¶ºÏùÑ ÏñπÏùÄ Îã¨ÏΩ§ ÏåâÏåÄÌïú Ïª§Ìîº.",
                    "Ïπ¥Ìë∏ÏπòÎÖ∏": "ÏóêÏä§ÌîÑÎ†àÏÜå+Ïä§ÌåÄ Ïö∞Ïú†+ÎëêÍ∫ºÏö¥ Í±∞Ìíà.",
                    "Ïπ¥ÌéòÎ™®Ïπ¥": "ÏóêÏä§ÌîÑÎ†àÏÜå+Ï¥àÏΩúÎ¶ø+Ïö∞Ïú†+ÌúòÌïëÌÅ¨Î¶º.",
                    "Î°±Î∏îÎûô": "Îú®Í±∞Ïö¥ Î¨º ÏúÑÏóê ÏóêÏä§ÌîÑÎ†àÏÜåÎ•º Î∂ÄÏñ¥ ÌÅ¨Î†àÎßàÎ•º ÏÇ¥Î¶∞ Ïª§Ìîº.",
                    "ÏóêÏä§ÌîÑÎ†àÏÜå": "Í∞ïÎ†¨ÌïòÍ≥† ÏßÑÌïú Ïª§Ìîº Ï∂îÏ∂ú ÏõêÏï°."
                },
                lbl_backup_title: "Îç∞Ïù¥ÌÑ∞ Î∞±ÏóÖ",
                btn_export: "ÎÇ¥Î≥¥ÎÇ¥Í∏∞",
                btn_import: "Î∂àÎü¨Ïò§Í∏∞",
                btn_share: "Ïπ¥Îìú Í≥µÏú†ÌïòÍ∏∞",
                fortune_score: "Ïö¥ÏÑ∏ Ï†êÏàò",
                msg_retry_fortune: "Ïö¥ÏÑ∏Î•º Îã§Ïãú ÎΩëÏúºÏãúÍ≤†ÏäµÎãàÍπå?",
                fortunes: [
                    { summary: "ÏóÖÎ¨¥ Ìö®Ïú® Í∏âÏÉÅÏäπ!", detail: "Ïò§ÎäòÎî∞Îùº ÏùºÏù¥ Ïà†Ïà† ÌíÄÎ¶¨Îäî ÎÇ†ÏûÖÎãàÎã§.", score: 98 },
                    { summary: "ÎúªÎ∞ñÏùò ÏÑ†Î¨º", detail: "Í∏∞Î∂Ñ Ï¢ãÏùÄ ÏÑúÌîÑÎùºÏù¥Ï¶àÍ∞Ä Í∏∞Îã§Î¶¨Í≥† ÏûàÏñ¥Ïöî.", score: 92 },
                    { summary: "Îã¨ÏΩ§Ìïú Ìú¥Ïãù", detail: "ÏôÑÎ≤ΩÌïú ÌèâÌôîÏôÄ Ìú¥ÏãùÏùÑ Ï¶êÍ∏∞ÏÑ∏Ïöî.", score: 85 },
                    { summary: "ÏïÑÏù¥ÎîîÏñ¥ Ìè≠Î∞ú", detail: "Ï∞ΩÏùòÏ†ÅÏù∏ ÏÉùÍ∞ÅÏù¥ ÏÉòÏÜüÎäî ÌïòÎ£®ÏûÖÎãàÎã§.", score: 94 },
                    { summary: "Í∏∞Îã§Î¶¨Îçò ÏÜåÏãù", detail: "Ïò§Îûò Í∏∞Îã§Î¶∞ Ï¢ãÏùÄ ÏÜåÏãùÏù¥ Ï∞æÏïÑÏòµÎãàÎã§.", score: 88 },
                    { summary: "Í∑ÄÏù∏ÏùÑ ÎßåÎÇ®", detail: "ÎãπÏã†ÏóêÍ≤å ÌÅ∞ ÎèÑÏõÄÏù¥ Îê† ÏÇ¨ÎûåÏùÑ ÎßåÎÇ©ÎãàÎã§.", score: 90 },
                    { summary: "ÏÜåÏÜåÌïú ÌñâÏö¥", detail: "Ï£ºÎ®∏Îãà ÏÜç ÏûëÏùÄ ÌñâÎ≥µÏùÑ Î∞úÍ≤¨Ìï† Í±∞ÏòàÏöî.", score: 75 },
                    { summary: "ÍøÄÎßõ Ïª§Ìîº", detail: "Ïò§Îäò ÎßàÏãúÎäî Ïª§ÌîºÎäî Ïú†ÎÇúÌûà ÎßõÏûàÏùÑ Í±∞ÏòàÏöî.", score: 80 },
                    { summary: "Ïπ≠Ï∞¨Î∞õÎäî ÎÇ†", detail: "ÎãπÏã†Ïùò ÎÖ∏Î†•Ïù¥ ÎπõÏùÑ Î∞úÌïòÍ≥† Ïù∏Ï†ïÎ∞õÏäµÎãàÎã§.", score: 95 },
                    { summary: "Î¨∏Ï†ú Ìï¥Í≤∞", detail: "Í≥®Ïπò ÏïÑÌîà Î¨∏Ï†úÍ∞Ä ÏãúÏõêÌïòÍ≤å Ìï¥Í≤∞Îê©ÎãàÎã§.", score: 89 }
                ]
            },
            jp: {
                welcome: "„É©„ÉÉ„Ç≠„Éº„Éì„Éº„É≥„Å∏„Çà„ÅÜ„Åì„ÅùÔºÅ",
                choose_luck: "‰∏ÄÁï™„É©„ÉÉ„Ç≠„Éº„Å™„Ç≤„Éº„É†„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑÔºÅ",
                setting_msg: "Ë®≠ÂÆöÔºö„ÉÅ„Éº„É†„É°„É≥„Éê„Éº„ÇíÁÆ°ÁêÜ„Åó„Åæ„Åô„ÄÇ",
                msg_setup_guide: "„ÉÜ„Éº„Éû„Å®‰∫∫Êï∞„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                how_to: "ÈÅä„Å≥Êñπ„Å®Â±•Ê≠¥„ÅÆ„ÅîÊ°àÂÜÖ",
                history_msg: "Ë™∞„Åå‰∏ÄÁï™„Ç≥„Éº„Éí„Éº„Çí„Åä„Åî„Çä„Åæ„Åó„Åü„ÅãÔºü",
                pick_hand: "Ë™∞„ÅåÊâï„ÅÜÔºü Êâã„ÇíÈÅ∏„Çì„ÅßÔºÅ",
                hands_mixed: "Êâã„Åå„Ç∑„É£„ÉÉ„Éï„É´„Åï„Çå„Åæ„Åó„ÅüÔºÅ",
                safe_msg: " „Åï„Çì„ÅØÁîüÂ≠òÔºÅ",
                pay_msg: " „Åï„Çì„ÅåÂΩìÈÅ∏„Åó„Åæ„Åó„ÅüÔºÅ",
                lucky_round: "„É©„ÉÉ„Ç≠„ÉºÔºÅÂÖ®Âì°ÁîüÂ≠ò„Åß„ÅôÔºÅ üåü",
                spin_msg: "„É´„Éº„É¨„ÉÉ„Éà„ÇíÂõû„Åó„Å¶ÈÅãË©¶„ÅóÔºÅ",
                cat_msg: "Áå´„ÅåÊÇ©„Çì„Åß„ÅÑ„Åæ„Åô...",
                cat_start: "Áå´„ÅØË™∞„ÅÆ„Å®„Åì„Çç„Å∏Ë°å„Åè„Åã„Å™Ôºü",
                all_pass: "üåü Lucky Pass üåü",
                all_pass_unbelievable: "üåü „Åô„Åî„ÅÑÔºÅLucky Pass„Åß„ÅôÔºÅ üåü",
                btn_start: "„Çπ„Çø„Éº„Éà",
                btn_enter_shop: "ÂÖ•Â†¥„Åô„Çã",
                btn_lounge: "„É©„Ç¶„É≥„Ç∏",
                btn_setup: "Ë®≠ÂÆö",
                btn_history: "Â±•Ê≠¥",
                btn_about: "ÊÉÖÂ†±",
                btn_back_menu: "„Éõ„Éº„É†„Å∏Êàª„Çã",
                btn_back_home: "„Éõ„Éº„É†„Å∏Êàª„Çã",
                btn_save_exit: "‰øùÂ≠ò„Åó„Å¶ÁµÇ‰∫Ü",
                btn_save_only: "‰øùÂ≠ò", 
                btn_back_only: "Êàª„Çã", 
                msg_saved: "‰øùÂ≠òÂÆå‰∫Ü!", 
                msg_confirm_discard: "Â§âÊõ¥ÂÜÖÂÆπ„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ‰øùÂ≠ò„Åó„Åæ„Åô„ÅãÔºü", 
                btn_shuffle: "„Ç∑„É£„ÉÉ„Éï„É´",
                btn_again: "„ÇÇ„ÅÜ‰∏ÄÂ∫¶",
                btn_spin: "Âõû„Åô",
                btn_change_game: "„Ç≤„Éº„É†Â§âÊõ¥",
                lbl_group: "„Ç∞„É´„Éº„Éó",
                lbl_members: "‰∫∫Êï∞",
                lbl_random: "„É©„É≥„ÉÄ„É†",
                lbl_clear: "„ÇØ„É™„Ç¢",
                lbl_save: "‰øùÂ≠ò",
                lbl_kings: "üèÜ ‰ªäÊó•„ÅÆÂØÑ‰ªòÁéã",
                lbl_unit_price: "Âçò‰æ°",
                lbl_subtotal: "ÂêàË®à",
                lbl_selected: "ÂΩìÈÅ∏ËÄÖ",
                lbl_get_receipt: "„É¨„Ç∑„Éº„Éà„Çí‰øùÂ≠ò",
                lbl_monthly_king: "‰ªäÊúà„ÅÆÂØÑ‰ªòÁéã",
                lbl_darkmode: "„Ç´„Éï„Çß„Éä„Ç§„Éà („ÉÄ„Éº„ÇØ„É¢„Éº„Éâ)",
                lbl_times: "Âõû",
                lbl_empty: "Á©∫",
                lbl_history_onoff: "Â±•Ê≠¥„Çí‰øùÂ≠ò„Åô„Çã",
                confirm_replay: "„Ç≤„Éº„É†„Çí„ÇÑ„ÇäÁõ¥„Åó„Åæ„Åô„ÅãÔºü",
                btn_mix: "Ê∑∑„Åú„Çã",
                txt_about_content: `<span class="about-label">„É©„ÉÉ„Ç≠„Éº„Éì„Éº„É≥„Å®„ÅØÔºü</span> „Ç≥„Éº„Éí„Éº„ÇíÊÑõ„Åô„Çã„ÉÅ„Éº„É†„ÅÆ„Åü„ÇÅ„ÅÆÊúÄÈ´ò„ÅÆÈÅãË©¶„Åó„ÉÑ„Éº„É´„Åß„Åô„ÄÇÊØéÊó•„ÅÆ„ÄåË™∞„Åå„Ç≥„Éº„Éí„Éº„ÇíË≤∑„ÅÜ„ÅãÔºü„Äç„Å®„ÅÑ„ÅÜÊÇ©„Åø„Çí„ÄÅÂà∫ÊøÄÁöÑ„Å™„Éü„Éã„Ç≤„Éº„É†„Å´Â§â„Åà„Åæ„Åó„Çá„ÅÜÔºÅ<br><br><span class="about-label">ÈÅä„Å≥Êñπ</span> 1. SETTINGS„Åß„ÉÅ„Éº„É†„É°„É≥„Éê„Éº„ÅÆÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Åæ„Åô„ÄÇ„Ç∞„É´„Éº„Éó‰øùÂ≠òÊ©üËÉΩ„Åå‰æøÂà©„Åß„Åô„ÄÇ<br>2. ENTER SHOP„Åß„ÅäÂ•Ω„Åø„ÅÆ„Ç≤„Éº„É†„ÇíÈÅ∏Êäû„Åó„Åæ„Åô„ÄÇ<br>3. „Ç≤„Éº„É†„Å´ÂèÇÂä†„Åó„Å¶ÂΩìÈÅ∏ËÄÖ„ÅåÊ±∫„Åæ„Å£„Åü„Çâ„ÄÅ„Åù„ÅÆ‰∫∫„Åå„Åä„Åî„ÇäÔºÅ„É¨„Ç∑„Éº„Éà„Çí‰øùÂ≠ò„Åó„Å¶ÂÖ±Êúâ„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ<br><br><span class="about-label">Â±•Ê≠¥„Å®„É©„É≥„Ç≠„É≥„Ç∞</span> Â±•Ê≠¥‰øùÂ≠ò„Åå„Ç™„É≥„ÅÆÂ†¥Âêà„ÄÅÁµêÊûú„ÅåËá™ÂãïÁöÑ„Å´‰øùÂ≠ò„Åï„Çå„Åæ„Åô„ÄÇLIST„É¢„Éº„Éâ„Åß„É©„É≥„Ç≠„É≥„Ç∞„ÇíÁ¢∫Ë™ç„Åó„Åü„Çä„ÄÅCALENDAR„É¢„Éº„Éâ„Åß„Ç≥„Éº„Éí„Éº„Ç¢„Ç§„Ç≥„É≥„Çí„Çø„ÉÉ„Éó„Åó„Å¶ÂΩìÈÅ∏ËÄÖ„ÇíÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇ`,
                menus: ["„Ç¢„É°„É™„Ç´„Éº„Éé", "„Ç´„Éï„Çß„É©„ÉÜ", "„Éê„Éã„É©„É©„ÉÜ", "„Éï„É©„ÉÉ„Éà„Éõ„ÉØ„Ç§„Éà", "„Ç≥„Éº„É´„Éâ„Éñ„É™„É•„Éº", "„Ç¢„Ç§„É≥„Ç∑„É•„Éö„Éä„Éº", "„Ç´„Éó„ÉÅ„Éº„Éé", "Ïπ¥ÌéòÎ™®Ïπ¥", "Î°±Î∏îÎûô", "ÏóêÏä§ÌîÑÎ†àÏÜå"],
                days: ["Êó•", "Êúà", "ÁÅ´", "Ê∞¥", "Êú®", "Èáë", "Âúü"],
                lounge_title: "ü™ë „Ç≥„Éº„Éí„Éº„É©„Ç¶„É≥„Ç∏",
                lounge_tab_fortune: "ÈÅãÂã¢",
                lounge_tab_menu: "„É°„Éã„É•„Éº",
                lounge_tab_dict: "Âõ≥Èëë",
                lounge_tab_map: "Âë®Ëæ∫",
                map_desc: "ÁèæÂú®Âú∞Âë®Ëæ∫„ÅÆ„Åä„ÅÑ„Åó„ÅÑ„Ç´„Éï„Çß„ÇíÊé¢„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜÔºÅ",
                fortune_tap: "„Ç´„Éº„Éâ„Çí„Çø„ÉÉ„Éó",
                lounge_msg: "Ê∏©„Åã„ÅÑ„Ç≥„Éº„Éí„Éº„Å®‰∏ÄÁ∑í„Å´‰∏Ä‰ºë„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                menu_q: "‰Ωï„ÇíÈ£≤„ÇÇ„ÅÜ„Åã„Å™Ôºü",
                coffee_dict: {
                    "„Ç¢„É°„É™„Ç´„Éº„Éé": "„Ç®„Çπ„Éó„É¨„ÉÉ„ÇΩ„Çí„ÅäÊπØ„ÅßÂâ≤„Å£„Åü„Ç≥„Éº„Éí„Éº. „Åô„Å£„Åç„Çä„Å®„Åó„ÅüÂë≥„Çè„ÅÑ„ÄÇ",
                    "„Ç´„Éï„Çß„É©„ÉÜ": "„Ç®„Çπ„Éó„É¨„ÉÉ„ÇΩ„Å®„Çπ„ÉÅ„Éº„É†„Éü„É´„ÇØ„ÅÆË™øÂíå. „Åæ„Çç„ÇÑ„Åã„ÅßÈ¶ô„Å∞„Åó„ÅÑ„ÄÇ",
                    "„Éê„Éã„É©„É©„ÉÜ": "„É©„ÉÜ„Å´Áîò„ÅÑ„Éê„Éã„É©„Ç∑„É≠„ÉÉ„Éó„ÇíÂä†„Åà„Åü„Ç≥„Éº„Éí„Éº„ÄÇ",
                    "„Éï„É©„ÉÉ„Éà„Éõ„ÉØ„Ç§„Éà": "„É©„ÉÜ„Çà„Çä„Éï„Ç©„Éº„É†„ÅåËñÑ„Åè„ÄÅ„Ç®„Çπ„Éó„É¨„ÉÉ„ÇΩ„ÅÆÂë≥„ÅåÊøÉ„ÅÑ„ÄÇ",
                    "„Ç≥„Éº„É´„Éâ„Éñ„É™„É•„Éº": "ÂÜ∑Ê∞¥„ÅßÈï∑ÊôÇÈñìÊäΩÂá∫„ÄÇËã¶Âë≥„ÅåÂ∞ë„Å™„Åè„Åæ„Çç„ÇÑ„Åã„ÄÇ",
                    "„Ç¢„Ç§„É≥„Ç∑„É•„Éö„Éä„Éº": "„Ç®„Çπ„Éó„É¨„ÉÉ„ÇΩ„ÅÆ‰∏ä„Å´ÂÜ∑„Åü„ÅÑ„Éõ„Ç§„ÉÉ„Éó„ÇØ„É™„Éº„É†„Çí‰πó„Åõ„ÅüÁîòËã¶„ÅÑ„Ç≥„Éº„Éí„Éº„ÄÇ",
                    "„Ç´„Éó„ÉÅ„Éº„Éé": "„Ç®„Çπ„Éó„É¨„ÉÉ„ÇΩ+„Çπ„ÉÅ„Éº„É†„Éü„É´„ÇØ+Âéö„ÅÑÊ≥°„ÄÇ",
                    "Ïπ¥ÌéòÎ™®Ïπ¥": "„Ç®„Çπ„Éó„É¨„ÉÉ„ÇΩ+„ÉÅ„Éß„Ç≥+„Éü„É´„ÇØ+„Éõ„Ç§„ÉÉ„Éó„ÄÇ",
                    "Î°±Î∏îÎûô": "„ÅäÊπØ„ÅÆ‰∏ä„Å´„Ç®„Çπ„Éó„É¨„ÉÉ„ÇΩ„ÇíÊ≥®„Åé„ÇØ„É¨„Éû„ÇíÁîü„Åã„Åó„Åü„ÇÇ„ÅÆ„ÄÇ",
                    "ÏóêÏä§ÌîÑÎ†àÏÜå": "„Ç≥„Éº„Éí„ÉºÊäΩÂá∫ÂéüÊ∂≤„ÄÇÂº∑ÁÉà„ÅßÊøÉÂéö„ÄÇ"
                },
                lbl_backup_title: "„Éá„Éº„Çø„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó",
                btn_export: "„Ç®„ÇØ„Çπ„Éù„Éº„Éà",
                btn_import: "„Ç§„É≥„Éù„Éº„Éà",
                btn_share: "„Ç´„Éº„Éâ„ÇíÂÖ±Êúâ",
                fortune_score: "ÈÅãÂã¢„Çπ„Ç≥„Ç¢",
                msg_retry_fortune: "„ÇÇ„ÅÜ‰∏ÄÂ∫¶Âºï„Åç„Åæ„Åô„ÅãÔºü",
                fortunes: [
                    { summary: "‰ªï‰∫ãÂäπÁéá„Ç¢„ÉÉ„ÉóÔºÅ", detail: "‰ªäÊó•„ÅØ‰ªï‰∫ã„Åå„Çπ„Ç§„Çπ„Ç§ÈÄ≤„ÇÄÊó•„Åß„Åô„ÄÇ", score: 98 },
                    { summary: "ÊÄù„ÅÑ„Åå„Åë„Å™„ÅÑ„Éó„É¨„Çº„É≥„Éà", detail: "Â¨â„Åó„ÅÑ„Çµ„Éó„É©„Ç§„Ç∫„ÅåÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ", score: 92 },
                    { summary: "Áîò„ÅÑ‰ºëÊÅØÊôÇÈñì", detail: "ÂÆåÁíß„Å™Âπ≥Âíå„Å®‰ºëÊÅØ„ÇíÊ•Ω„Åó„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ", score: 85 },
                    { summary: "„Ç¢„Ç§„Éá„Ç¢„ÅåÊ∫¢„ÇåÂá∫„Åô", detail: "ÂâµÈÄ†ÁöÑ„Å™ËÄÉ„Åà„ÅåÊπß„ÅçÂá∫„Çã‰∏ÄÊó•„Åß„Åô„ÄÇ", score: 94 },
                    { summary: "Â¨â„Åó„ÅÑ„Éã„É•„Éº„Çπ", detail: "ÂæÖ„Å°„Çè„Å≥„Å¶„ÅÑ„ÅüËâØ„ÅÑÁü•„Çâ„Åõ„ÅåÂ±ä„Åç„Åæ„Åô„ÄÇ", score: 88 },
                    { summary: "Âä©„Å£‰∫∫„Å´‰ºö„Åà„Çã‰∫àÊÑü", detail: "„ÅÇ„Å™„Åü„ÇíÂä©„Åë„Å¶„Åè„Çå„Çã‰∫∫„Å´Âá∫‰ºö„ÅÑ„Åæ„Åô„ÄÇ", score: 90 },
                    { summary: "Â∞è„Åï„Å™Âπ∏„Åõ", detail: "„Éù„Ç±„ÉÉ„Éà„ÅÆ‰∏≠Ïùò ÏûëÏùÄ Âπ∏„Åõ„ÇíË¶ã„Å§„Åë„Åæ„Åô„ÄÇ", score: 75 },
                    { summary: "‰ªäÊó•„ÅÆ„Ç≥„Éº„Éí„Éº„ÅØÊ†ºÂà•", detail: "‰ªäÊó•È£≤„ÇÄ„Ç≥„Éº„Éí„Éº„ÅØ‰∏ÄÊÆµ„Å®ÁæéÂë≥„Åó„ÅÑ„Åß„Åó„Çá„ÅÜ„ÄÇ", score: 80 },
                    { summary: "„ÅäË§í„ÇÅ„ÅÆË®ÄËëâ", detail: "„ÅÇ„Å™„Åü„ÅÆÂä™Âäõ„ÅåËºù„Åç„ÄÅË™ç„ÇÅ„Çâ„Çå„Åæ„Åô„ÄÇ", score: 95 },
                    { summary: "ÂïèÈ°åËß£Ê±∫", detail: "È†≠„ÇíÊÇ©„Åæ„Åõ„Å¶„ÅÑ„ÅüÂïèÈ°å„Åå„ÅÇ„Å£„Åï„ÇäËß£Ê±∫„Åó„Åæ„Åô„ÄÇ", score: 89 }
                ]
            }
        };

        /* --- 2. Global Variables --- */
        let currentLang = localStorage.getItem('luckyBeanLang') || 'en';
        let isDarkMode = localStorage.getItem('luckyBeanDark') === 'true';
        let recordStats = localStorage.getItem('luckyBeanRecord') !== 'false';
        
        const randomNicknames = ["Coffee Monster", "Latte King", "Ice Bear", "Sugar Addict", "Lucky Guy", "Morning Coffee", "Bean Hunter", "Cream Lover"];
        let memberNames = []; 
        let currentTeamName = 'Empty'; 
        let currentMemberCount = 3;
        let isGameOver = false; 
        let winnerIndex = -1;
        let isLuckyRound = false; 
        let lastWasLucky = false;
        let isShuffling = false; 
        let catRunning = false;
        let rouletteAngle = 0; 
        let rouletteSpinning = false; 
        let currentRouletteItems = [];
        let typeTimeout; 
        let fromView = 'front';
        let historyViewMode = 'list';
        let calCursor = new Date();
        let loungeTabMode = 'fortune';
        let selectedMenuIndex = -1;
        const MENU_KEYS = ["Americano", "Cafe Latte", "Vanilla Latte", "Flat White", "Cold Brew", "Einspanner", "Cappuccino", "Cafe Mocha", "Long Black", "Espresso"];

        /* --- 3. Audio Engine --- */
        let isAudioStarted = false;
        let vibePlaying = false; 
        let vibeBackgroundMode = false;
        let currentVibeIndex = 0; 
        const vibeTracks = [
            { name: "Lucky Bean Cafe", desc: "Original Soundtrack", file: "sounds/cafe_music_bgm.mp3", icon: "‚òï" },
            { name: "Lazy Sunday Jazz", desc: "Relaxing piano vibes", file: "sounds/jazz.mp3", icon: "üé∑" },
            { name: "Rainy Window Seat", desc: "Heavy rain & thunder", file: "sounds/rain.mp3", icon: "üåßÔ∏è" },
            { name: "Barista's Morning", desc: "Espresso machine sounds", file: "sounds/coffee.mp3", icon: "ü•£" },
            { name: "Writer's Deadline", desc: "Typewriter & Fireplace", file: "sounds/typing.mp3", icon: "‚å®Ô∏è" },
            { name: "Forest Break", desc: "Birds & Stream water", file: "sounds/forest.mp3", icon: "üå≤" }
        ];

        const AudioEngine = {
            ctx: null, player: null, 
            initAndPlayBGM() {
                try {
                    if (!this.ctx) {
                        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                        this.player = document.getElementById('bgm-player');
                        this.player.volume = 0.15;
                    }
                    if (this.ctx.state === 'suspended') this.ctx.resume();
                    if (this.player && this.player.paused) {
                        this.player.src = vibeTracks[0].file;
                        this.player.play().then(() => { 
                            isAudioStarted = true; vibePlaying = true; renderVibeList();
                        }).catch(e => console.log("Audio play failed:", e));
                    }
                } catch(e) { console.warn("Audio Init Error", e); }
            },
            pauseBGM() { if (this.player) this.player.pause(); },
            resumeBGM() { if (this.player && isAudioStarted) this.player.play(); },
            play(type) {
                if (this.ctx && this.ctx.state === 'suspended') this.ctx.resume();
                if (!this.ctx) return;
                try {
                    const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain(); const now = this.ctx.currentTime;
                    osc.connect(gain); gain.connect(this.ctx.destination);
                    if (type === 'start') {
                        osc.frequency.setValueAtTime(698.46, now); osc.frequency.exponentialRampToValueAtTime(1046.50, now + 0.15);
                        gain.gain.setValueAtTime(0.5, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                        osc.start(now); osc.stop(now + 0.2);
                    } else if (type === 'safe') {
                        osc.type = 'sine'; osc.frequency.setValueAtTime(1174.66, now);
                        gain.gain.setValueAtTime(0.3, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                        osc.start(now); osc.stop(now + 0.1);
                    } else if (type === 'fail') {
                        osc.frequency.setValueAtTime(880, now); osc.frequency.exponentialRampToValueAtTime(110, now + 0.5);
                        gain.gain.setValueAtTime(0.5, now); gain.gain.linearRampToValueAtTime(0, now + 0.5);
                        osc.start(now); osc.stop(now + 0.5);
                    } else if (type === 'whoosh') {
                        osc.type = 'triangle'; osc.frequency.setValueAtTime(100, now); osc.frequency.exponentialRampToValueAtTime(1200, now + 0.3);
                        gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.3);
                        osc.start(now); osc.stop(now + 0.3);
                    } else if (type === 'print') {
                        const bufferSize = this.ctx.sampleRate * 0.5;
                        const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                        const data = buffer.getChannelData(0);
                        for (let i = 0; i < bufferSize; i++) { data[i] = Math.random() * 2 - 1; }
                        const noise = this.ctx.createBufferSource(); noise.buffer = buffer;
                        const filter = this.ctx.createBiquadFilter(); filter.type = 'bandpass';
                        filter.frequency.setValueAtTime(1200, now); filter.frequency.exponentialRampToValueAtTime(2500, now + 0.4);
                        const nGain = this.ctx.createGain(); nGain.gain.setValueAtTime(0.12, now);
                        nGain.gain.exponentialRampToValueAtTime(0.01, now + 0.8);
                        noise.connect(filter); filter.connect(nGain); nGain.connect(this.ctx.destination);
                        noise.start(now); noise.stop(now + 0.8);
                    }
                } catch(e) {}
            },
            playVibe(idx) {
                if(!this.player) return;
                this.player.src = vibeTracks[idx].file;
                this.player.play().catch(e => console.log("Vibe play error:", e));
            },
            stopVibe() { if(this.player) this.player.pause(); }
        };

        function triggerHaptic(pattern) { if (navigator.vibrate) { try { navigator.vibrate(pattern); } catch(e) {} } }

        /* ÏàòÏ†ïÎêú Ï§ëÏïôÌòï ÌÜ†Ïä§Ìä∏ Î∞ïÏä§ Ìï®Ïàò */
        function showToast(msg) {
            const toast = document.getElementById('toast-box');
            toast.innerText = msg;
            toast.classList.add('show');
            if(window.toastTimeout) clearTimeout(window.toastTimeout);
            window.toastTimeout = setTimeout(() => { toast.classList.remove('show'); }, 2000);
        }

        /* --- 4. Initialization --- */
        window.onload = () => {
            try {
                if(isDarkMode) document.body.classList.add('dark-mode');
                document.getElementById('history-toggle').checked = recordStats;
                applyLanguage();
                renderVibeList();
                updateRecordingDot(); 

                const fill = document.getElementById('progress-fill');
                let progress = 0;
                
                const safetyTimer = setTimeout(() => {
                    document.getElementById('loading-progress-area').style.display = 'none';
                    document.getElementById('start-action-area').style.display = 'flex';
                }, 3000);

                const interval = setInterval(() => {
                    progress += Math.random() * 15;
                    if (progress >= 100) {
                        progress = 100; 
                        clearInterval(interval);
                        clearTimeout(safetyTimer);
                        setTimeout(() => {
                            const loadArea = document.getElementById('loading-progress-area');
                            const actionArea = document.getElementById('start-action-area');
                            if(loadArea) loadArea.style.display = 'none';
                            if(actionArea) actionArea.style.display = 'flex';
                        }, 500);
                    }
                    if(fill) fill.style.width = progress + '%';
                }, 50);
            } catch(e) {
                console.error("Init Error:", e);
                document.getElementById('loading-progress-area').style.display = 'none';
                document.getElementById('start-action-area').style.display = 'flex';
            }
        };

        document.addEventListener("visibilitychange", () => {
            if (document.hidden) {
                if (vibePlaying && !vibeBackgroundMode) AudioEngine.stopVibe();
            } else {
                if (vibePlaying) AudioEngine.player.play();
            }
        });

        /* --- 5. UI & View Logic --- */
        function updateRecordingDot() {
            const isRec = localStorage.getItem('luckyBeanRecord') !== 'false';
            document.querySelectorAll('.recording-dot').forEach(d => {
                if(isRec) d.classList.add('active'); else d.classList.remove('active');
            });
        }

        function toggleVibeModal(show) {
            document.getElementById('vibe-modal-overlay').style.display = show ? 'flex' : 'none';
            if(show) renderVibeList();
        }
        function toggleVibeBgMode() {
            vibeBackgroundMode = document.getElementById('vibe-bg-toggle').checked;
        }
        function renderVibeList() {
            const list = document.getElementById('vibe-track-list');
            list.innerHTML = vibeTracks.map((t, i) => `
                <div class="vibe-item ${i === currentVibeIndex && vibePlaying ? 'playing' : ''}" onclick="playVibeTrack(${i})">
                    <div class="vibe-icon">${t.icon}</div>
                    <div class="vibe-info">
                        <div class="vibe-name">${t.name}</div>
                        <div class="vibe-desc">${t.desc}</div>
                    </div>
                    <div class="vibe-status">${i === currentVibeIndex && vibePlaying ? 'PLAYING' : ''}</div>
                </div>
            `).join('');
        }
        function playVibeTrack(index) {
            if (currentVibeIndex === index && vibePlaying) {
                AudioEngine.stopVibe();
                vibePlaying = false;
            } else {
                currentVibeIndex = index;
                vibePlaying = true;
                AudioEngine.playVibe(index);
            }
            renderVibeList();
        }

        function toggleDarkMode() {
            isDarkMode = document.getElementById('dark-toggle').checked;
            const mainImg = document.getElementById('main-img');
            if(isDarkMode) {
                document.body.classList.add('dark-mode');
                if(mainImg.src.includes('cafe_facade.png')) mainImg.src = 'images/cafe_facade_night.png';
                if(mainImg.src.includes('cafe_facade_zoom.png')) mainImg.src = 'images/cafe_facade_zoom_night.png';
            } else {
                document.body.classList.remove('dark-mode');
                if(mainImg.src.includes('cafe_facade_night.png')) mainImg.src = 'images/cafe_facade.png';
                if(mainImg.src.includes('cafe_facade_zoom_night.png')) mainImg.src = 'images/cafe_facade_zoom.png';
            }
            if (!document.getElementById('setup-view').classList.contains('hidden')) {
                mainImg.src = isDarkMode ? 'images/cafe_setting_guy.png' : 'images/cafe_setting.png';
            }
            localStorage.setItem('luckyBeanDark', isDarkMode);
        }

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('luckyBeanLang', lang);
            applyLanguage();
        }

        function applyLanguage() {
            const t = i18n[currentLang];
            document.getElementById('lang-ko').classList.toggle('active', currentLang === 'ko');
            document.getElementById('lang-en').classList.toggle('active', currentLang === 'en');
            document.getElementById('lang-jp').classList.toggle('active', currentLang === 'jp');
            
            const transMap = {
                'btn-start': t.btn_start, 'btn-enter-shop': t.btn_enter_shop, 'btn-go-lounge': t.btn_lounge,
                'btn-go-setup': t.btn_setup, 'btn-go-history': t.btn_history, 'btn-go-about': t.btn_about,
                'btn-back-menu-selector': t.btn_back_menu, 'btn-back-menu-hand': t.btn_back_menu,
                'btn-back-menu-roulette': t.btn_back_menu, 'btn-back-menu-cat': t.btn_back_menu,
                'btn-back-home': t.btn_back_home, 'btn-back-home-about': t.btn_back_home, 'btn-back-home-history': t.btn_back_home, 'btn-back-home-lounge': t.btn_back_home,
                'btn-save-exit': t.btn_save_exit, 'btn-shuffle': t.btn_shuffle, 'hand-again-btn': t.btn_again,
                'roulette-again-btn': t.btn_again, 'cat-again-btn': t.btn_again, 'roulette-spin-btn': t.btn_spin,
                'btn-hand-start': t.btn_start, 
                'cat-start-btn': t.btn_start, 'btn-back-selector-hand': t.btn_change_game, 'btn-back-selector-roulette': t.btn_change_game,
                'btn-back-selector-cat': t.btn_change_game, 'btn-view-list': currentLang === 'ko' ? "Î¶¨Ïä§Ìä∏" : (currentLang === 'jp' ? "„É™„Çπ„Éà" : "LIST"),
                'btn-view-cal': currentLang === 'ko' ? "Îã¨Î†•" : (currentLang === 'jp' ? "„Ç´„É¨„É≥„ÉÄ„Éº" : "CALENDAR"),
                'btn-tab-fortune': t.lounge_tab_fortune, 'btn-tab-dict': t.lounge_tab_dict, 'btn-tab-map': t.lounge_tab_map,
                'btn-tab-menu': t.lounge_tab_menu,
                'txt-map-desc': t.map_desc, 'txt-menu-q': t.menu_q, 'btn-mix-header': t.btn_mix,
                'txt-donation-kings-hist': t.lbl_kings, 'lbl-backup-title': t.lbl_backup_title,
                'btn-backup-export': t.btn_export, 'btn-backup-import': t.btn_import, 'btn-share-fortune': t.btn_share,
                'txt-score-label': t.fortune_score, 
                'btn-settings-back': t.btn_back_only, 
                'btn-save-settings': t.btn_save_only 
            };

            Object.keys(transMap).forEach(id => {
                const el = document.getElementById(id); if(el) el.innerText = transMap[id];
            });

            document.getElementById('lbl-group').innerText = t.lbl_group;
            document.getElementById('lbl-members').innerText = t.lbl_members;
            document.getElementById('lbl-darkmode').innerText = t.lbl_darkmode;
            document.getElementById('lbl-history-onoff').innerText = t.lbl_history_onoff;
            document.getElementById('btn-random').innerText = t.lbl_random;
            document.getElementById('btn-clear').innerText = t.lbl_clear;
            document.getElementById('btn-save-team').innerText = t.lbl_save;
            document.getElementById('txt-choose-luck').innerText = t.choose_luck;
            document.getElementById('txt-about-content').innerHTML = t.txt_about_content;
            document.getElementById('display-group-name').innerText = currentTeamName === 'Empty' ? t.lbl_empty : currentTeamName;
            document.getElementById('display-member-count').innerText = `${currentMemberCount}${currentLang === 'ko' ? 'Î™Ö' : (currentLang === 'jp' ? '‰∫∫' : 'P')}`;
            
            document.getElementById('txt-game-hand').innerText = currentLang === 'ko' ? "ÎûúÎç§ ÏÜê ÎΩëÍ∏∞" : (currentLang === 'jp' ? "„É©„É≥„ÉÄ„É†ÊâãÊãõ„Åç" : "Random Hand");
            document.getElementById('txt-game-roulette').innerText = currentLang === 'ko' ? "ÌñâÏö¥Ïùò Î£∞Î†õ" : (currentLang === 'jp' ? "Âπ∏ÈÅã„ÅÆ„É´„Éº„É¨„ÉÉ„Éà" : "Lucky Roulette");
            document.getElementById('txt-game-cat').innerText = currentLang === 'ko' ? "Í≥†ÏñëÏù¥Ïùò ÏÑ†ÌÉù" : (currentLang === 'jp' ? "Áå´„ÅÆÈÅ∏Êäû" : "Cat's Choice");
            
            document.getElementById('txt-game-hand-title').innerText = currentLang === 'ko' ? "üëä ÎûúÎç§ ÏÜê ÎΩëÍ∏∞" : (currentLang === 'jp' ? "üëä „É©„É≥„ÉÄ„É†ÊâãÊãõ„Åç" : "üëä Random Hand");
            document.getElementById('txt-roulette-title').innerText = currentLang === 'ko' ? "üé° ÌñâÏö¥Ïùò Î£∞Î†õ" : (currentLang === 'jp' ? "üé° Âπ∏ÈÅã„ÅÆ„É´„Éº„É¨„ÉÉ„Éà" : "üé° LUCKY ROULETTE");
            document.getElementById('txt-cat-title').innerText = currentLang === 'ko' ? "üêà Í≥†ÏñëÏù¥Ïùò ÏÑ†ÌÉù" : (currentLang === 'jp' ? "üêà Áå´„ÅÆÈÅ∏Êäû" : "üêà CAT'S CHOICE");
            document.getElementById('txt-setting-title').innerHTML = `üìã ${currentLang === 'ko' ? "Í≤åÏûÑ ÏÑ§Ï†ï" : (currentLang === 'jp' ? "„Ç≤„Éº„É†Ë®≠ÂÆö" : "GAME SETTING")}`;
            document.getElementById('txt-about-title').innerHTML = `‚òï ${currentLang === 'ko' ? "Îü≠ÌÇ§Îπà Ï†ïÎ≥¥" : (currentLang === 'jp' ? "„É©„ÉÉ„Ç≠„Éº„Éì„Éº„É≥ÊÉÖÂ†±" : "ABOUT LUCKY BEAN")}`;
            document.getElementById('txt-history-title').innerHTML = `üèÜ ${currentLang === 'ko' ? "Í∏∞Î∂Ä ÌûàÏä§ÌÜ†Î¶¨" : (currentLang === 'jp' ? "ÂØÑ‰ªòÂ±•Ê≠¥" : "DONATION HISTORY")}`;
            
            document.getElementById('txt-lounge-title').innerHTML = `ü™ë ${t.lounge_title.replace("‚òï ", "").replace("ü™ë ", "")}`;
            const cardFrontText = document.querySelector('.card-front > div:nth-child(2)');
            if(cardFrontText) cardFrontText.innerText = t.fortune_tap;

            const setupView = document.getElementById('setup-view');
            if (setupView && !setupView.classList.contains('hidden')) {
                updateText('msg_setup_guide');
            }

            renderMenuRecommendation();
            if(loungeTabMode === 'dict') renderCoffeeDict();
        }

        function updateText(msgKey, isDirect = false) {
            clearTimeout(typeTimeout);
            const content = document.getElementById('rpg-content'); content.innerText = ''; let i = 0;
            const msg = isDirect ? msgKey : i18n[currentLang][msgKey];
            function typing() { if (i < msg.length) { content.innerText += msg.charAt(i); i++; typeTimeout = setTimeout(typing, 40); } }
            typing();
        }

        function handleStartGame() {
            triggerHaptic(10); AudioEngine.initAndPlayBGM();
            const splash = document.getElementById('splash-screen');
            splash.style.opacity = '0';
            setTimeout(() => { splash.style.display = 'none'; goFront(); }, 600);
        }

        function handleGameSelection(gameType) {
            triggerHaptic(10); AudioEngine.play('start'); 
            if (gameType === 'hand') startGame();
            else if (gameType === 'roulette') goRoulette();
            else if (gameType === 'cat') goCatGame();
        }

        function hideAllViews() {
            ['front-view', 'selector-view', 'setup-view', 'game-view', 'about-view', 'history-view', 'roulette-view', 'cat-view', 'lounge-view'].forEach(v => {
                const el = document.getElementById(v); if(el) { el.classList.add('hidden'); el.classList.remove('fade-in-view'); }
            });
            document.getElementById('lucky-area').classList.add('hidden');
            document.getElementById('hand-result-anchor').innerHTML = '';
            document.getElementById('roulette-result-anchor').innerHTML = '';
            document.getElementById('cat-result-anchor').innerHTML = '';
            document.getElementById('btn-hand-start').classList.remove('hidden');
            document.getElementById('roulette-spin-btn').classList.remove('hidden');
            document.getElementById('cat-start-btn').classList.remove('hidden');
            document.getElementById('hand-again-btn').classList.add('hidden');
            document.getElementById('roulette-again-btn').classList.add('hidden');
            document.getElementById('cat-again-btn').classList.add('hidden');
            document.querySelectorAll('button').forEach(btn => btn.disabled = false);
        }

        function goFront() {
            fromView = 'front'; hideAllViews();
            document.getElementById('front-view').classList.remove('hidden');
            document.getElementById('front-view').classList.add('fade-in-view');
            document.getElementById('main-img').src = isDarkMode ? 'images/cafe_facade_night.png' : 'images/cafe_facade.png';
            updateText('welcome'); 
        }

        function showGameSelector() {
            fromView = 'selector'; hideAllViews();
            document.getElementById('selector-view').classList.remove('hidden');
            document.getElementById('selector-view').classList.add('fade-in-view');
            document.getElementById('main-img').src = isDarkMode ? 'images/cafe_facade_zoom_night.png' : 'images/cafe_facade_zoom.png';
            updateText('choose_luck');
        }

        function goSetup(source = 'front') {
            fromView = source; hideAllViews();
            document.getElementById('setup-view').classList.remove('hidden');
            document.getElementById('setup-view').classList.add('fade-in-view');
            document.getElementById('main-img').src = isDarkMode ? 'images/cafe_setting_guy.png' : 'images/cafe_setting.png';
            updateText('msg_setup_guide'); 
            generateNameInputs();
            document.getElementById('dark-toggle').checked = isDarkMode;
            document.getElementById('history-toggle').checked = (localStorage.getItem('luckyBeanRecord') !== 'false');
        }

        function goAbout() {
            hideAllViews(); document.getElementById('about-view').classList.remove('hidden');
            document.getElementById('about-view').classList.add('fade-in-view');
            document.getElementById('main-img').src = isDarkMode ? 'images/cafe_facade_night.png' : 'images/cafe_facade.png'; updateText('how_to');
        }

        function goHistory() {
            hideAllViews(); document.getElementById('history-view').classList.remove('hidden');
            document.getElementById('history-view').classList.add('fade-in-view');
            document.getElementById('main-img').src = isDarkMode ? 'images/cafe_history_guy.png' : 'images/cafe_history.png';
            updateText('history_msg'); switchHistoryView(historyViewMode);
        }

        function goLounge() {
            hideAllViews();
            document.getElementById('lounge-view').classList.remove('hidden');
            document.getElementById('lounge-view').classList.add('fade-in-view');
            document.getElementById('main-img').src = 'images/cafe_lounge.png';
            updateText('lounge_msg');
            switchLoungeTab('fortune');
        }

        function switchLoungeTab(tab) {
            triggerHaptic(10); loungeTabMode = tab;
            document.getElementById('btn-tab-fortune').classList.toggle('active', tab === 'fortune');
            document.getElementById('btn-tab-menu').classList.toggle('active', tab === 'menu');
            document.getElementById('btn-tab-dict').classList.toggle('active', tab === 'dict');
            document.getElementById('btn-tab-map').classList.toggle('active', tab === 'map');
            document.getElementById('lounge-fortune-sec').classList.toggle('hidden', tab !== 'fortune');
            document.getElementById('lounge-menu-sec').classList.toggle('hidden', tab !== 'menu');
            document.getElementById('lounge-dict-sec').classList.toggle('hidden', tab !== 'dict');
            document.getElementById('lounge-map-sec').classList.toggle('hidden', tab !== 'map');
            if (tab === 'fortune') document.getElementById('daily-fortune-card').classList.remove('flipped'); 
            else if (tab === 'dict') renderCoffeeDict(); 
            else if (tab === 'menu' && selectedMenuIndex === -1) renderMenuRecommendation();
        }

        function recommendMenu() {
            triggerHaptic(10); AudioEngine.play('whoosh');
            const resultEl = document.getElementById('menu-recommend-result');
            selectedMenuIndex = -1; renderMenuRecommendation(); 
            resultEl.style.opacity = '0.3';
            const menus = i18n[currentLang].menus;
            let count = 0;
            const interval = setInterval(() => {
                const randIdx = Math.floor(Math.random() * menus.length);
                resultEl.innerText = menus[randIdx];
                count++;
                if(count > 12) {
                    clearInterval(interval);
                    selectedMenuIndex = Math.floor(Math.random() * MENU_KEYS.length);
                    renderMenuRecommendation();
                    resultEl.style.opacity = '1';
                    AudioEngine.play('start'); triggerHaptic(30);
                    confetti({ particleCount: 50, spread: 60, origin: { y: 0.7 }, gravity: 2, colors:['#6f4e37', '#f1c40f'] });
                }
            }, 80);
        }

        function renderMenuRecommendation() {
            const imgEl = document.getElementById('menu-img-display');
            const nameEl = document.getElementById('menu-recommend-result');
            const descEl = document.getElementById('txt-menu-q'); 
            if (selectedMenuIndex === -1) {
                imgEl.src = 'images/coffee.png'; nameEl.innerText = '?';
                descEl.innerText = i18n[currentLang].menu_q;
                descEl.style.fontWeight = "normal"; descEl.style.color = "#888";
            } else {
                const engKey = MENU_KEYS[selectedMenuIndex]; 
                const localName = i18n[currentLang].menus[selectedMenuIndex];
                const localDesc = i18n[currentLang].coffee_dict[localName];
                const fileName = engKey.replace(/ /g, '_');
                imgEl.src = `images/${fileName}.png`;
                nameEl.innerText = localName;
                descEl.innerText = localDesc ? localDesc : "";
                descEl.style.fontWeight = "800"; descEl.style.color = "var(--text-main)";
            }
        }

        function drawDailyFortune() {
            const card = document.getElementById('daily-fortune-card');
            if (card.classList.contains('flipped')) { 
                if(!confirm(i18n[currentLang].msg_retry_fortune)) return;
                triggerHaptic(10); card.classList.remove('flipped'); return; 
            }
            triggerHaptic(20); AudioEngine.play('whoosh');
            const t = i18n[currentLang];
            const randomFortune = t.fortunes[Math.floor(Math.random() * t.fortunes.length)];
            document.getElementById('fortune-msg').innerText = randomFortune.summary;
            document.getElementById('fortune-detail').innerText = randomFortune.detail;
            document.getElementById('fortune-score').innerText = randomFortune.score;
            setTimeout(() => { triggerHaptic(40); card.classList.add('flipped'); AudioEngine.play('safe'); }, 300);
        }
        
        async function shareFortune() {
            const card = document.getElementById('daily-fortune-card');
            if (!card.classList.contains('flipped')) { showToast(currentLang === 'ko' ? "Î®ºÏ†Ä Ïö¥ÏÑ∏Î•º ÎΩëÏïÑÏ£ºÏÑ∏Ïöî!" : "Draw a fortune first!"); return; }
            const btn = document.getElementById('btn-share-fortune'); const originalText = btn.innerText; btn.innerText = "...";
            const elementToCapture = card.querySelector('.card-back');
            try {
                const canvas = await html2canvas(elementToCapture, { backgroundColor: "#f8f8f8", scale: 3 });
                canvas.toBlob(async (blob) => {
                    const file = new File([blob], "fortune_card.png", { type: "image/png" });
                    if (navigator.share) await navigator.share({ files: [file] });
                    else { const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'fortune_card.png'; a.click(); }
                    btn.innerText = originalText;
                });
            } catch (e) { btn.innerText = "ERROR"; setTimeout(() => btn.innerText = originalText, 1000); }
        }

        function renderCoffeeDict() {
            const listArea = document.getElementById('coffee-dict-list');
            const dict = i18n[currentLang].coffee_dict;
            let html = '';
            for (const [name, desc] of Object.entries(dict)) {
                html += `<div class="dict-item"><div class="dict-icon">‚òï</div><div class="dict-info"><h4>${name}</h4><p>${desc}</p></div></div>`;
            }
            listArea.innerHTML = html;
        }

        /* --- 6. Settings Logic --- */
        function checkSettingsChanged() {
            const savedRecord = localStorage.getItem('luckyBeanRecord') !== 'false';
            const currentRecord = document.getElementById('history-toggle').checked;
            if (savedRecord !== currentRecord) return true;

            const savedNames = JSON.parse(localStorage.getItem('lastCoffeeMembers') || '["User 1","User 2","User 3"]');
            const currentInputs = document.querySelectorAll('.name-input');
            if (savedNames.length !== currentMemberCount) return true;
            for(let i = 0; i < currentMemberCount; i++) {
                let currentVal = currentInputs[i].value.trim() || `User ${i+1}`;
                if (savedNames[i] !== currentVal) return true;
            }
            return false;
        }

        function revertSettings() {
            recordStats = localStorage.getItem('luckyBeanRecord') !== 'false';
            const savedNames = JSON.parse(localStorage.getItem('lastCoffeeMembers') || '["User 1","User 2","User 3"]');
            currentMemberCount = savedNames.length;
            document.getElementById('history-toggle').checked = recordStats;
            generateNameInputs(savedNames);
            document.getElementById('display-member-count').innerText = `${currentMemberCount}${currentLang === 'ko' ? 'Î™Ö' : (currentLang === 'jp' ? '‰∫∫' : 'P')}`;
        }

        function handleSaveSettings() {
            recordStats = document.getElementById('history-toggle').checked;
            localStorage.setItem('luckyBeanRecord', recordStats);
            const inputs = document.querySelectorAll('.name-input');
            const tempNames = [];
            for (let i = 0; i < currentMemberCount; i++) { 
                tempNames.push(inputs[i].value.trim() || `User ${i+1}`); 
            }
            localStorage.setItem('lastCoffeeMembers', JSON.stringify(tempNames));
            updateRecordingDot();
            showToast(i18n[currentLang].msg_saved);
        }

        function handleSetupBack() {
            if (checkSettingsChanged()) {
                if (confirm(i18n[currentLang].msg_confirm_discard)) {
                    handleSaveSettings();
                    navigateBack();
                } else {
                    revertSettings();
                    navigateBack();
                }
            } else {
                navigateBack();
            }
        }

        function navigateBack() {
            if (fromView === 'hand') startGame(); 
            else if (fromView === 'roulette') goRoulette(); 
            else if (fromView === 'cat') goCatGame(); 
            else if (fromView === 'selector') showGameSelector();
            else goFront();
        }

        function exportData() {
            const data = {
                members: localStorage.getItem('lastCoffeeMembers'),
                teams: localStorage.getItem('coffeeTeams'),
                stats: localStorage.getItem('coffeeStats'),
                history: localStorage.getItem('coffeeHistory'), 
                settings: {
                    lang: localStorage.getItem('luckyBeanLang'),
                    dark: localStorage.getItem('luckyBeanDark'),
                    record: localStorage.getItem('luckyBeanRecord')
                }
            };
            const str = JSON.stringify(data);
            if (navigator.clipboard) {
                navigator.clipboard.writeText(str).then(() => showToast(currentLang === 'ko' ? "Îç∞Ïù¥ÌÑ∞Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!" : "Data Copied!")).catch(() => prompt("Copy this:", str));
            } else { prompt("Copy this:", str); }
        }

        function importData() {
            const input = prompt(currentLang === 'ko' ? "Î≥µÏÇ¨Ìïú Îç∞Ïù¥ÌÑ∞Î•º Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî:" : "Paste backup data:");
            if(!input) return;
            try {
                const data = JSON.parse(input);
                if(data.members) localStorage.setItem('lastCoffeeMembers', data.members);
                if(data.teams) localStorage.setItem('coffeeTeams', data.teams);
                if(data.stats) localStorage.setItem('coffeeStats', data.stats);
                if(data.settings) {
                    if(data.settings.lang) localStorage.setItem('luckyBeanLang', data.settings.lang);
                    if(data.settings.dark) localStorage.setItem('luckyBeanDark', data.settings.dark);
                    if(data.settings.record) localStorage.setItem('luckyBeanRecord', data.settings.record);
                }
                alert(currentLang === 'ko' ? "Î≥µÏõê ÏôÑÎ£å! ÏÉàÎ°úÍ≥†Ïπ®Ìï©ÎãàÎã§." : "Restored! Reloading...");
                location.reload();
            } catch(e) { alert("Invalid Data"); }
        }

        /* --- 7. Name & Group Management --- */
        function openMemberModal() {
            const overlay = document.getElementById('modal-overlay'); const container = document.getElementById('modal-list-container');
            overlay.style.display = 'flex'; container.innerHTML = '';
            for (let i = 2; i <= 12; i++) {
                const div = document.createElement('div'); div.className = 'modal-item';
                div.innerHTML = `<span>${i}${currentLang === 'ko' ? 'Î™Ö' : (currentLang === 'jp' ? '‰∫∫' : 'P')}</span><span>‚ñæ</span>`; 
                div.onclick = () => { triggerHaptic(10); currentMemberCount = i; generateNameInputs(); closeModal(); };
                container.appendChild(div);
            }
        }
        function generateNameInputs(providedNames = null) {
            const container = document.getElementById('name-input-container');
            const saved = localStorage.getItem('lastCoffeeMembers');
            const lastSaved = saved ? JSON.parse(saved) : null;
            const currentInputs = Array.from(container.querySelectorAll('.name-input')).map(i => i.value);
            let namesToUse = providedNames || (lastSaved && lastSaved.length === currentMemberCount ? lastSaved : currentInputs);
            container.innerHTML = '';
            for (let i = 0; i < currentMemberCount; i++) {
                const input = document.createElement('input'); input.type = 'text'; input.className = 'name-input';
                input.placeholder = `User ${i+1}`; if (namesToUse && namesToUse[i]) input.value = namesToUse[i];
                container.appendChild(input);
            }
            document.getElementById('display-member-count').innerText = `${currentMemberCount}${currentLang === 'ko' ? 'Î™Ö' : (currentLang === 'jp' ? '‰∫∫' : 'P')}`;
        }
        function fillRandomNames() {
            triggerHaptic(10);
            let shuffled = [...randomNicknames].sort(() => Math.random() - 0.5);
            document.querySelectorAll('.name-input').forEach((input, idx) => { input.value = shuffled[idx % shuffled.length]; });
        }
        function openGroupModal() {
            const overlay = document.getElementById('modal-overlay'); const container = document.getElementById('modal-list-container');
            overlay.style.display = 'flex'; container.innerHTML = '';
            const teams = JSON.parse(localStorage.getItem('coffeeTeams') || '{}');
            const keys = Object.keys(teams);
            if(keys.length === 0) {
                container.innerHTML = `<div style="padding:40px; text-align:center; color:#ccc; font-weight:700;">NO SAVED GROUPS</div>`;
            } else {
                keys.forEach(name => {
                    const div = document.createElement('div'); div.className = 'modal-item';
                    div.innerHTML = `<span style="flex:1; text-align:left;" onclick="loadTeam('${name}')">${name}</span><span style="color:#eee; font-size:1.5rem; padding:0 10px;" onclick="deleteTeam('${name}')">√ó</span>`;
                    container.appendChild(div);
                });
            }
        }
        function deleteTeam(name) { if(confirm("Delete team?")) { const teams = JSON.parse(localStorage.getItem('coffeeTeams') || '{}'); delete teams[name]; localStorage.setItem('coffeeTeams', JSON.stringify(teams)); openGroupModal(); } }
        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
        function loadTeam(name) { triggerHaptic(10); currentTeamName = name; document.getElementById('display-group-name').innerText = name; const teams = JSON.parse(localStorage.getItem('coffeeTeams') || '{}'); if (teams[name]) { currentMemberCount = teams[name].count; generateNameInputs(teams[name].names); } closeModal(); }
        function saveCurrentTeam() { const name = prompt(currentLang === 'ko' ? "Í∑∏Î£π Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:" : "Group Name:"); if (!name) return; const names = Array.from(document.querySelectorAll('.name-input')).map(i => i.value.trim() || `User`); const teams = JSON.parse(localStorage.getItem('coffeeTeams') || '{}'); teams[name] = { count: currentMemberCount, names: names }; localStorage.setItem('coffeeTeams', JSON.stringify(teams)); currentTeamName = name; document.getElementById('display-group-name').innerText = name; }
        function clearNames() { document.querySelectorAll('.name-input').forEach(i => i.value = ''); }
        function confirmReplay(gameType) { if (confirm(i18n[currentLang].confirm_replay)) { if (AudioEngine.ctx) AudioEngine.ctx.resume(); if (gameType === 'hand') startGame(); else if (gameType === 'roulette') goRoulette(); else if (gameType === 'cat') goCatGame(); } }

        /* --- 8. Game: Random Hand --- */
        function startGame() {
            triggerHaptic(10);
            const saved = localStorage.getItem('lastCoffeeMembers');
            memberNames = saved ? JSON.parse(saved) : ["User 1", "User 2", "User 3"];
            AudioEngine.play('start'); 
            winnerIndex = Math.floor(Math.random() * memberNames.length);
            isLuckyRound = !lastWasLucky && Math.random() < 0.15; 
            isGameOver = false; hideAllViews();
            document.getElementById('game-view').classList.remove('hidden');
            document.getElementById('game-view').classList.add('fade-in-view');
            updateText('pick_hand');
            document.getElementById('main-img').src = isDarkMode ? 'images/cafe_counter_guy.png' : 'images/cafe_counter.png';
            renderHands();
        }
        function renderHands() {
            const display = document.getElementById('hand-display'); display.innerHTML = '';
            for (let i = 0; i < memberNames.length; i++) {
                const wrapper = document.createElement('div'); wrapper.className = 'hand-wrapper';
                const handImg = document.createElement('img'); handImg.src = 'images/hand_nothing.png'; handImg.className = 'hand-img';
                const nameTag = document.createElement('div'); nameTag.className = 'hand-name'; nameTag.innerText = memberNames[i];
                wrapper.appendChild(handImg); wrapper.appendChild(nameTag); display.appendChild(wrapper);
            }
        }
        function shufflePositions() {
            if (isGameOver || isShuffling) return;
            isShuffling = true; AudioEngine.play('whoosh');
            const wrappers = Array.from(document.querySelectorAll('.hand-wrapper'));
            const images = wrappers.map(w => w.querySelector('.hand-img'));
            images.forEach(img => { img.style.animation = 'none'; });
            const startRects = images.map(img => img.getBoundingClientRect());
            let indices = wrappers.map((_, i) => i);
            for (let i = indices.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [indices[i], indices[j]] = [indices[j], indices[i]]; }
            images.forEach((img, i) => {
                const targetIndex = indices[i];
                const dx = startRects[targetIndex].left - startRects[i].left;
                const dy = startRects[targetIndex].top - startRects[i].top;
                img.style.transition = 'transform 0.5s cubic-bezier(0.25, 1, 0.5, 1)'; 
                img.style.transform = `translate(${dx}px, ${dy}px)`;
            });
            setTimeout(() => {
                images.forEach(img => { img.style.transition = 'none'; img.style.transform = 'none'; img.style.animation = 'floating 3s ease-in-out infinite'; });
                winnerIndex = Math.floor(Math.random() * memberNames.length);
                isShuffling = false; updateText('hands_mixed');
            }, 500);
        }
        function startHandGame() {
            if (isGameOver || isShuffling) return;
            document.getElementById('btn-hand-start').disabled = true;
            AudioEngine.play('whoosh'); triggerHaptic(20);
            const hands = document.querySelectorAll('.hand-img');
            hands.forEach(h => h.classList.add('tension-shake'));
            setTimeout(() => { hands.forEach(h => h.classList.remove('tension-shake')); revealHandResult(); }, 2000); 
        }
        function revealHandResult() {
            const hands = document.querySelectorAll('.hand-img');
            isGameOver = true;
            document.getElementById('btn-hand-start').classList.add('hidden'); 
            if (isLuckyRound) {
                lastWasLucky = true; AudioEngine.play('start'); triggerHaptic([50, 50, 50]);
                hands.forEach(h => { h.src = 'images/hand_open.png'; h.style.animation = "floating 0.5s infinite"; });
                updateText('lucky_round');
                document.getElementById('main-img').src = isDarkMode ? 'images/cafe_lucky_guy.png' : 'images/cafe_counter_lucky.png';
                document.getElementById('lucky-area').classList.remove('hidden');
            } else {
                lastWasLucky = false; AudioEngine.play('fail'); triggerHaptic([100, 50, 100]);
                hands.forEach((h, index) => { if (index === winnerIndex) { h.src = 'images/hand_money.png'; h.classList.add('shake'); } else { h.src = 'images/hand_clap.gif'; } });
                updateText(`${memberNames[winnerIndex]}${i18n[currentLang].pay_msg}`, true);
                document.getElementById('main-img').src = isDarkMode ? 'images/cafe_counter_thanks_guy.gif' : 'images/cafe_counter_thanks.gif';
                if (recordStats) updateStats(memberNames[winnerIndex]); 
                confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
                showFinish(memberNames.length, memberNames[winnerIndex], 'hand-result-anchor');
            }
            document.getElementById('hand-again-btn').classList.remove('hidden');
        }

        /* --- 9. Game: Roulette --- */
        function goRoulette() { 
            triggerHaptic(10); hideAllViews(); 
            const saved = localStorage.getItem('lastCoffeeMembers'); 
            const members = saved ? JSON.parse(saved) : ["User 1", "User 2", "User 3"]; 
            currentRouletteItems = [...members, i18n[currentLang].all_pass]; 
            document.getElementById('roulette-view').classList.remove('hidden'); 
            document.getElementById('roulette-view').classList.add('fade-in-view'); 
            document.getElementById('main-img').src = isDarkMode ? 'images/cafe_counter_guy.png' : 'images/cafe_counter.png'; 
            updateText('spin_msg'); rouletteAngle = 0; drawRoulette(); 
        }
        function drawRoulette() {
            const canvas = document.getElementById('rouletteCanvas'); const ctx = canvas.getContext('2d');
            const cx = 200, cy = 200, r = 190;
            const weights = currentRouletteItems.map(item => (item.includes('Lucky Pass') || item.includes('Ï†ÑÏõê ÌÜµÍ≥º') || item.includes('ÁîüÂ≠ò')) ? 0.2 : 1);
            const totalWeight = weights.reduce((a, b) => a + b, 0);
            ctx.clearRect(0, 0, 400, 400); let startAngle = rouletteAngle;
            for (let i = 0; i < currentRouletteItems.length; i++) {
                const sliceAngle = (weights[i] / totalWeight) * Math.PI * 2;
                ctx.beginPath(); ctx.fillStyle = (weights[i] < 1) ? "#000" : (i % 2 === 0 ? "#f8f8f8" : "#ebebeb");
                ctx.moveTo(cx, cy); ctx.arc(cx, cy, r, startAngle, startAngle + sliceAngle); ctx.fill();
                ctx.strokeStyle = "#333"; ctx.lineWidth = 2; ctx.stroke();
                ctx.save(); ctx.translate(cx, cy); ctx.rotate(startAngle + sliceAngle / 2); ctx.textAlign = "right";
                ctx.fillStyle = (weights[i] < 1) ? "#f1c40f" : "#333";
                ctx.font = "bold 14px Montserrat"; ctx.fillText(currentRouletteItems[i], r - 30, 5); ctx.restore();
                startAngle += sliceAngle;
            }
            ctx.beginPath(); ctx.arc(cx, cy, 15, 0, Math.PI * 2); ctx.fillStyle = "#333"; ctx.fill();
        }
        function spinRoulette() { 
            if (rouletteSpinning) return; 
            rouletteSpinning = true; AudioEngine.play('whoosh'); triggerHaptic(20); 
            document.getElementById('roulette-spin-btn').disabled = true; 
            const duration = 4500; const startTS = performance.now(); const startRot = rouletteAngle; 
            const targetRot = startRot + (Math.random() * 5 + 5) * Math.PI * 2; let lastTick = 0; 
            function animate(now) { 
                const elapsed = now - startTS; const progress = Math.min(elapsed / duration, 1); 
                const easeOut = 1 - Math.pow(1 - progress, 4); rouletteAngle = startRot + (targetRot - startRot) * easeOut; 
                if(now - lastTick > 150) { triggerHaptic(5); lastTick = now; } drawRoulette(); 
                if (progress < 1) requestAnimationFrame(animate); else { rouletteSpinning = false; finishSpin(); } 
            } 
            requestAnimationFrame(animate); 
        }
        function finishSpin() {
            const weights = currentRouletteItems.map(item => (item.includes('Lucky Pass') || item.includes('Ï†ÑÏõê ÌÜµÍ≥º') || item.includes('ÁîüÂ≠ò')) ? 0.2 : 1);
            const totalWeight = weights.reduce((a, b) => a + b, 0);
            let normalizedAngle = (rouletteAngle % (Math.PI * 2)); if (normalizedAngle < 0) normalizedAngle += Math.PI * 2;
            const pinPos = (Math.PI * 1.5); let checkAngle = normalizedAngle, winnerIdx = 0;
            for (let i = 0; i < currentRouletteItems.length; i++) {
                const sliceAngle = (weights[i] / totalWeight) * Math.PI * 2;
                const start = checkAngle % (Math.PI * 2); const end = (checkAngle + sliceAngle) % (Math.PI * 2);
                if (end < start) { if (pinPos >= start || pinPos <= end) { winnerIdx = i; break; } }
                else { if (pinPos >= start && pinPos <= end) { winnerIdx = i; break; } }
                checkAngle += sliceAngle;
            }
            const winnerName = currentRouletteItems[winnerIdx];
            document.getElementById('roulette-spin-btn').classList.add('hidden'); 
            document.getElementById('roulette-again-btn').classList.remove('hidden');
            if (weights[winnerIdx] < 1) { 
                AudioEngine.play('start'); updateText('all_pass_unbelievable'); triggerHaptic([50, 50, 50]); 
                document.getElementById('main-img').src = isDarkMode ? 'images/cafe_lucky_guy.png' : 'images/cafe_counter_lucky.png'; 
                confetti({ particleCount: 200, spread: 100, origin: { y: 0.7 }, colors: ['#f1c40f', '#fff'] }); 
            } else { 
                AudioEngine.play('fail'); updateText(`${winnerName}${i18n[currentLang].pay_msg}`, true); triggerHaptic([100, 50, 100]); 
                document.getElementById('main-img').src = isDarkMode ? 'images/cafe_counter_thanks_guy.gif' : 'images/cafe_counter_thanks.gif'; 
                if (recordStats) updateStats(winnerName); 
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.7 } }); 
                showFinish(currentRouletteItems.length - 1, winnerName, 'roulette-result-anchor'); 
            }
        }

        /* --- 10. Game: Cat's Choice --- */
        function goCatGame() { 
            triggerHaptic(10); hideAllViews(); 
            const saved = localStorage.getItem('lastCoffeeMembers'); 
            memberNames = saved ? JSON.parse(saved) : ["User 1", "User 2", "User 3"]; 
            document.getElementById('cat-view').classList.remove('hidden'); 
            document.getElementById('cat-view').classList.add('fade-in-view'); 
            document.getElementById('main-img').src = isDarkMode ? 'images/cafe_counter_guy.png' : 'images/cafe_counter.png'; 
            updateText('cat_start'); 
            const cat = document.getElementById('moving-cat'); 
            cat.src = 'images/cat_stand.png'; cat.style.transition = 'none'; 
            cat.style.left = '50%'; cat.style.top = '15px'; cat.style.transform = 'translateX(-50%)'; cat.className = ''; 
            setTimeout(() => { cat.style.transition = 'left 0.4s ease-in-out, top 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275)'; }, 50); 
            renderCatBowls(); 
        }
        function renderCatBowls() { 
            const container = document.getElementById('bowls-container'); container.innerHTML = ''; 
            const count = memberNames.length; const rows = Math.ceil(count / 6); 
            const whiteBox = document.getElementById('cat-white-box'); 
            if(rows >= 2) { whiteBox.style.minHeight = "400px"; container.style.paddingTop = "100px"; } 
            else { whiteBox.style.minHeight = "320px"; container.style.paddingTop = "120px"; } 
            memberNames.forEach((name, i) => { 
                const bowl = document.createElement('div'); bowl.className = 'cat-bowl'; 
                bowl.innerHTML = `<img src="images/cat_bowl_full.png" class="bowl-img" id="img-bowl-${i}"><div class="bowl-name">${name}</div>`; 
                container.appendChild(bowl); 
            }); 
        }
        function startCatGame() {
            if (catRunning) return; catRunning = true;
            document.getElementById('cat-start-btn').disabled = true; updateText('cat_msg'); AudioEngine.play('whoosh'); triggerHaptic(20);
            const cat = document.getElementById('moving-cat'); 
            cat.src = 'images/cat_walk.gif'; cat.style.transform = 'none'; cat.classList.add('cat-moving');
            winnerIndex = Math.floor(Math.random() * memberNames.length); 
            const bowlEls = document.querySelectorAll('.cat-bowl'); const gameArea = document.getElementById('cat-white-box');
            let visits = 0; const maxVisits = 7 + Math.floor(Math.random() * 4);
            function moveCat() {
                const parentRect = gameArea.getBoundingClientRect();
                if (visits < maxVisits) {
                    let nextIdx; do { nextIdx = Math.floor(Math.random() * memberNames.length); } while (nextIdx === winnerIndex && memberNames.length > 1);
                    const target = bowlEls[nextIdx].getBoundingClientRect();
                    cat.style.left = (target.left - parentRect.left + (target.width / 2)) - (cat.offsetWidth / 2) + 'px';
                    cat.style.top = (15 + Math.random() * 40) + 'px';
                    visits++; setTimeout(moveCat, 450 + Math.random() * 200);
                } else {
                    const final = bowlEls[winnerIndex].getBoundingClientRect();
                    cat.style.left = (final.left - parentRect.left + (final.width / 2)) - (cat.offsetWidth / 2) + 'px';
                    cat.style.top = (final.top - parentRect.top - cat.offsetHeight + 18) + 'px';
                    setTimeout(() => {
                        cat.classList.remove('cat-moving'); cat.src = 'images/cat_eat.png';
                        bowlEls.forEach((b, idx) => { 
                            if(idx !== winnerIndex) b.classList.add('bowl-dimmed'); 
                            else { b.classList.add('bowl-highlight'); setTimeout(() => { document.getElementById(`img-bowl-${winnerIndex}`).src = 'images/cat_bowl_empty.png'; }, 500); } 
                        });
                        AudioEngine.play('fail'); updateText(`${memberNames[winnerIndex]}${i18n[currentLang].pay_msg}`, true); triggerHaptic([100, 50, 100]);
                        document.getElementById('main-img').src = isDarkMode ? 'images/cafe_counter_thanks_guy.gif' : 'images/cafe_counter_thanks.gif';
                        if (recordStats) updateStats(memberNames[winnerIndex]); 
                        confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
                        showFinish(memberNames.length, memberNames[winnerIndex], 'cat-result-anchor');
                        document.getElementById('cat-start-btn').classList.add('hidden'); document.getElementById('cat-again-btn').classList.remove('hidden'); catRunning = false;
                    }, 600);
                }
            }
            moveCat();
        }

        /* --- 11. Result & History --- */
        function showFinish(total, payerName, anchorId) {
            const now = new Date(); const randomPrice = (Math.random() * 5 + 3.5).toFixed(2); const t = i18n[currentLang];
            const prototype = document.getElementById('receipt-prototype-area').querySelector('.receipt-container').cloneNode(true);
            const receipt = prototype.querySelector('.receipt');
            receipt.querySelector('.receipt-date').innerText = now.toLocaleDateString(); 
            receipt.querySelector('.receipt-order-no').innerText = "NO." + Math.floor(1000 + Math.random() * 9000); 
            receipt.querySelector('.receipt-qty').innerText = "x" + total; 
            receipt.querySelector('.receipt-price').innerText = "$" + randomPrice; 
            receipt.querySelector('.receipt-subtotal').innerText = "$" + (randomPrice * total).toFixed(2); 
            receipt.querySelector('.receipt-payer').innerText = payerName;
            receipt.querySelector('.txt-lbl-unit').innerText = t.lbl_unit_price; 
            receipt.querySelector('.txt-lbl-sub').innerText = t.lbl_subtotal; 
            receipt.querySelector('.txt-lbl-payer').innerText = t.lbl_selected; 
            receipt.querySelector('.btn-capture-run').innerText = t.lbl_get_receipt;
            const randomFortune = t.fortunes[Math.floor(Math.random() * t.fortunes.length)];
            receipt.querySelector('.receipt-fortune').innerText = randomFortune.summary;
            receipt.querySelector('.receipt-menu').innerText = t.menus[Math.floor(Math.random() * t.menus.length)];
            const anchor = document.getElementById(anchorId); anchor.innerHTML = ''; anchor.appendChild(prototype);
            requestAnimationFrame(() => { AudioEngine.play('print'); receipt.classList.add('print-ani'); triggerHaptic(20); });
            receipt.querySelector('.btn-capture-run').onclick = function() { shareAsImage(receipt, this); };
        }
        async function shareAsImage(element, btn) { 
            const originalText = btn.innerText; btn.innerText = "..."; 
            try { 
                const canvas = await html2canvas(element, { backgroundColor: "#ffffff", scale: 3 }); 
                canvas.toBlob(async (blob) => { 
                    const file = new File([blob], "receipt.png", { type: "image/png" }); 
                    if (navigator.share) await navigator.share({ files: [file] }); 
                    else { const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'receipt.png'; a.click(); } 
                    btn.innerText = originalText; 
                }); 
            } catch (e) { btn.innerText = "ERROR"; } 
        }
        
        function updateStats(name) { 
            let stats = JSON.parse(localStorage.getItem('coffeeStats') || '{}'); 
            const now = new Date(); const monthKey = now.toISOString().slice(0, 7); const dateKey = now.toISOString().slice(0, 10); 
            if(!stats[name]) stats[name] = { total: 0, monthly: {}, daily: [] }; 
            stats[name].total += 1; stats[name].monthly[monthKey] = (stats[name].monthly[monthKey] || 0) + 1; 
            if(!stats[name].daily) stats[name].daily = []; stats[name].daily.push(dateKey); 
            localStorage.setItem('coffeeStats', JSON.stringify(stats)); 
        }
        
        function switchHistoryView(mode) {
            historyViewMode = mode; triggerHaptic(10);
            document.getElementById('btn-view-list').classList.toggle('active', mode === 'list');
            document.getElementById('btn-view-cal').classList.toggle('active', mode === 'cal');
            document.getElementById('history-list-view').classList.toggle('hidden', mode !== 'list');
            document.getElementById('history-cal-view').classList.toggle('hidden', mode !== 'cal');
            if(mode === 'list') renderHistoryList(); else renderCalendar();
        }

        function renderHistoryList() {
            const stats = JSON.parse(localStorage.getItem('coffeeStats') || '{}'); 
            const month = new Date().toISOString().slice(0, 7);
            const savedMembers = localStorage.getItem('lastCoffeeMembers');
            const currentMembers = savedMembers ? JSON.parse(savedMembers) : [];
            let displayList = [];
            Object.keys(stats).forEach(name => { displayList.push({ name: name, total: stats[name].total || 0, monthly: (stats[name].monthly && stats[name].monthly[month]) || 0 }); });
            currentMembers.forEach(name => { if (!displayList.find(item => item.name === name)) displayList.push({ name: name, total: 0, monthly: 0 }); });
            displayList.sort((a, b) => b.total - a.total);
            const kingArea = document.getElementById('monthly-king-area'); 
            const content = document.getElementById('history-list-content'); 
            if (displayList.length === 0) { kingArea.innerHTML = ""; content.innerHTML = `<div style="text-align:center; padding:50px; color:#ccc;">NO DATA</div>`; return; } 
            const king = [...displayList].sort((a,b) => b.monthly - a.monthly)[0]; 
            if(king && king.monthly > 0) {
                kingArea.innerHTML = `<div class="monthly-king-badge"><div class="king-crown">üëë</div><div class="king-info"><div class="king-tag">${i18n[currentLang].lbl_monthly_king}</div><div class="king-name">${king.name}</div></div><div class="king-count-area">${king.monthly}${i18n[currentLang].lbl_times}</div></div>`; 
            } else { kingArea.innerHTML = ""; }
            const maxVal = Math.max(...displayList.map(i => i.total));
            const minVal = Math.min(...displayList.map(i => i.total));
            content.innerHTML = displayList.map(item => {
                let prefix = '';
                if (item.total === maxVal && item.total > 0) prefix = 'ü•á ';
                else if (item.total === minVal) prefix = 'üçÄ ';
                return `<div class="history-item"><span>${prefix}${item.name}</span><span style="color:var(--point-red)">${item.total}${i18n[currentLang].lbl_times}</span></div>`;
            }).join(''); 
        }

        function renderCalendar() {
            const area = document.getElementById('calendar-render-area');
            const year = calCursor.getFullYear();
            const month = calCursor.getMonth();
            const stats = JSON.parse(localStorage.getItem('coffeeStats') || '{}');
            let html = `<div class="calendar-header"><button class="btn-text" onclick="changeCalMonth(-1)">‚óÄ</button><span style="font-weight:800; font-size:0.9rem;">${year}.${String(month+1).padStart(2,'0')}</span><button class="btn-text" onclick="changeCalMonth(1)">‚ñ∂</button></div><div class="calendar-grid">`;
            i18n[currentLang].days.forEach(d => html += `<div class="calendar-day-label">${d}</div>`);
            const firstDay = new Date(year, month, 1).getDay(); const lastDate = new Date(year, month + 1, 0).getDate();
            for(let i=0; i<firstDay; i++) html += `<div></div>`;
            for(let d=1; d<=lastDate; d++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                let payers = [];
                Object.entries(stats).forEach(([name, data]) => { if(data.daily && data.daily.includes(dateStr)) payers.push(name); });
                const hasDataClass = payers.length > 0 ? 'has-data' : '';
                const clickAttr = payers.length > 0 ? `onclick="showPayerDetailModal('${dateStr}')"` : "";
                html += `<div class="calendar-cell ${hasDataClass}" ${clickAttr}><span class="calendar-date-num">${d}</span>${payers.length > 0 ? '<span class="calendar-bean-icon">‚òï</span>' : ''}</div>`;
            }
            html += `</div>`;
            area.innerHTML = html;
        }

        /* [Í∞úÏÑ†] Îã¨Î†• ÌÅ¥Î¶≠ Ïãú Ï†ÑÏö© Î™®Îã¨ Ï∞Ω ÌëúÏãú Î∞è Í∞úÎ≥Ñ Í∏∞Î°ù ÏÇ≠Ï†ú Í∏∞Îä• */
        function showPayerDetailModal(dateStr) {
            triggerHaptic(10);
            const overlay = document.getElementById('modal-overlay');
            const container = document.getElementById('modal-list-container');
            const stats = JSON.parse(localStorage.getItem('coffeeStats') || '{}');
            
            overlay.style.display = 'flex';
            container.innerHTML = `<div style="font-weight:900; font-size:1rem; margin-bottom:15px; border-bottom:2px solid #000; padding-bottom:10px;">üìÖ ${dateStr}</div>`;

            let recordsFound = false;
            Object.entries(stats).forEach(([name, data]) => {
                if (data.daily && data.daily.includes(dateStr)) {
                    // ÎèôÏùº ÎÇ†ÏßúÏóê Ïó¨Îü¨ Î≤à ÎãπÏ≤®ÎêòÏóàÏùÑ Ïàò ÏûàÏúºÎØÄÎ°ú ÌöüÏàò Ï≤¥ÌÅ¨
                    const countOnThisDay = data.daily.filter(d => d === dateStr).length;
                    for(let i=0; i<countOnThisDay; i++) {
                        recordsFound = true;
                        const item = document.createElement('div');
                        item.className = 'history-modal-item';
                        item.innerHTML = `
                            <span style="font-weight:700;">‚òï ${name}</span>
                            <button class="btn-del-record" onclick="deleteHistoryRecord('${name}', '${dateStr}')">√ó</button>
                        `;
                        container.appendChild(item);
                    }
                }
            });

            if(!recordsFound) closeModal();
        }

        /* Í∞úÎ≥Ñ Í∏∞Î°ù ÏÇ≠Ï†ú Î°úÏßÅ */
        function deleteHistoryRecord(name, dateStr) {
            if(!confirm(`${name} ÎãòÏùò Ìï¥Îãπ Í∏∞Î°ùÏùÑ ÏÇ≠Ï†úÌï†ÍπåÏöî?`)) return;
            
            let stats = JSON.parse(localStorage.getItem('coffeeStats') || '{}');
            if(stats[name]) {
                // daily Î∞∞Ïó¥ÏóêÏÑú Ìï¥Îãπ ÎÇ†Ïßú Ïù∏Îç±Ïä§ ÌïòÎÇò Ï∞æÏïÑÏÑú ÏÇ≠Ï†ú
                const idx = stats[name].daily.indexOf(dateStr);
                if(idx > -1) {
                    stats[name].daily.splice(idx, 1);
                    stats[name].total -= 1;
                    
                    // ÏõîÍ∞Ñ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                    const monthKey = dateStr.slice(0, 7);
                    if(stats[name].monthly[monthKey]) {
                        stats[name].monthly[monthKey] -= 1;
                        if(stats[name].monthly[monthKey] <= 0) delete stats[name].monthly[monthKey];
                    }
                    
                    // ÌÜµÍ≥Ñ Îç∞Ïù¥ÌÑ∞Í∞Ä 0Ïù¥Î©¥ Ï†ïÎ¶¨
                    if(stats[name].total <= 0) delete stats[name];
                    
                    localStorage.setItem('coffeeStats', JSON.stringify(stats));
                    showToast("Í∏∞Î°ùÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.");
                    
                    // UI Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏
                    renderCalendar();
                    // Î™®Îã¨ ÎÇ¥Ïö© Í∞±Ïã† (ÎÇ®ÏùÄ Í∏∞Î°ùÏù¥ ÏûàÏúºÎ©¥ Ïú†ÏßÄ, ÏóÜÏúºÎ©¥ Îã´Ïùå)
                    const stillHasData = JSON.parse(localStorage.getItem('coffeeStats') || '{}');
                    let anyLeft = false;
                    Object.values(stillHasData).forEach(d => { if(d.daily.includes(dateStr)) anyLeft = true; });
                    
                    if(anyLeft) showPayerDetailModal(dateStr);
                    else closeModal();
                }
            }
        }

        function changeCalMonth(delta) { triggerHaptic(10); calCursor.setMonth(calCursor.getMonth() + delta); renderCalendar(); }
        function resetStats() { if(confirm("Clear all?")) { localStorage.removeItem('coffeeStats'); goFront(); } }
    </script>
</body>
</html>
