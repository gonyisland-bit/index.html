<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>lucky bean - v0.6.5</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Lucky Bean">
    <link rel="icon" type="image/png" href="coffeegame_icon.png">
    <link rel="apple-touch-icon" href="coffeegame_icon.png">

    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@1,300&family=Montserrat:wght@800&family=Courier+Prime&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-color: #ffffff;
            --primary-color: #000000;
            --text-gray-70: #4d4d4d;
            --rpg-border: #000000;
            --tablet-bg: #f8f8f8;
            --tablet-border: #eeeeee;
            --point-red: #ff4d4d;
            --divider-color: #ebebeb;
            --btn-shadow: #333333;
            --btn-light-shadow: #e0e0e0;
            --roulette-gold: #f1c40f;
            --btn-dark-gray: #444444;
        }

        html, body { height: 100%; margin: 0; padding: 0; touch-action: pan-x pan-y; -webkit-text-size-adjust: none; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color); color: var(--primary-color);
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            overflow-x: hidden; overflow-y: auto;
        }

        .wrapper { width: 100%; max-width: 600px; display: flex; flex-direction: column; align-items: center; text-align: center; padding-bottom: 40px; }

        header { padding: 30px 0 10px; cursor: pointer; width: 100%; display: flex; flex-direction: column; align-items: center; }
        .title-lucky { font-family: 'Playfair Display', serif; font-style: italic; font-weight: 300; font-size: 2.8rem; letter-spacing: -1px; }
        .title-bean { font-family: 'Montserrat', sans-serif; font-weight: 800; font-size: 3.1rem; letter-spacing: -2px; margin-left: -5px; }

        .game-screen {
            position: relative; width: 92%; max-width: 500px; margin: 10px auto 25px;
            border: 6px solid #000; line-height: 0; overflow: hidden; background: #eee; border-radius: 4px;
        }

        .title-image { width: 100%; height: auto; display: block; transition: none; }

        #rpg-textbox {
            position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%); width: 90%;
            background: rgba(255, 255, 255, 0.92); border: 3px solid var(--rpg-border);
            border-radius: 8px; padding: 12px 15px; box-sizing: border-box; line-height: 1.4; pointer-events: none; z-index: 10;
        }
        #rpg-content { font-size: 0.95rem; font-weight: 800; color: #000; min-height: 1.2rem; word-break: keep-all; white-space: pre-wrap; text-align: left; }

        .card-container {
            width: 90%; max-width: 450px; background: var(--tablet-bg); border-radius: 30px;
            padding: 25px; box-sizing: border-box; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.01), 0 15px 35px rgba(0,0,0,0.03); margin: 0 auto 25px;
        }

        .order-menu-header { 
            font-family: 'Montserrat', sans-serif; font-weight: 800; font-size: 0.8rem; color: #333; 
            text-align: left; margin-bottom: 12px; letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center;
        }
        
        .settings-icon-btn {
            background: none; border: none; font-size: 1.1rem; cursor: pointer; color: #bbb; padding: 0 5px; transition: color 0.2s;
        }

        .picker-group { width: 100%; display: flex; gap: 12px; margin-bottom: 20px; }
        .picker-btn {
            flex: 1; padding: 14px; border: 1px solid #eee; border-radius: 16px;
            background: white; font-weight: 700; font-size: 0.85rem; color: #333; cursor: pointer;
            display: flex; flex-direction: column; align-items: flex-start; transition: all 0.1s; position: relative;
            box-shadow: 0 4px 0 var(--btn-light-shadow);
        }
        .picker-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 var(--btn-light-shadow); }
        .picker-label { color: #bbb; font-size: 0.65rem; font-weight: 800; margin-bottom: 4px; letter-spacing: 0.5px; }
        .picker-value { display: flex; justify-content: space-between; width: 100%; align-items: center; }
        .picker-value::after { content: 'â–¾'; color: #ccc; font-size: 1rem; }

        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; margin-bottom: 15px; }
        .toggle-label { font-size: 0.75rem; font-weight: 800; color: #333; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--point-red); }
        input:checked + .slider:before { transform: translateX(20px); }

        .icon-selector-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; margin-top: 10px; }
        .icon-btn-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: transform 0.1s; }
        .icon-square {
            width: 100%; aspect-ratio: 1/1; border: 3px solid #000; border-radius: 15px;
            background: #fff; overflow: hidden; margin-bottom: 8px; box-shadow: 0 4px 0 #333;
            display: flex; align-items: center; justify-content: center;
        }
        .icon-square img { width: 80%; height: 80%; object-fit: contain; }
        .icon-label { font-size: 0.65rem; font-weight: 900; color: #000; letter-spacing: 0px; text-transform: uppercase; line-height: 1.2; height: 2.4em; display: flex; align-items: center; }

        .name-mgmt-bar { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 8px; }
        .btn-text { background: none; border: none; color: #bbb; font-size: 0.7rem; font-weight: 800; cursor: pointer; padding: 5px 10px; transition: 0.2s; letter-spacing: 1px; text-align: center; }

        .divider { width: 100%; height: 1px; background-color: var(--divider-color); margin-bottom: 20px; }

        #name-input-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; width: 100%; margin-bottom: 10px; }
        .name-input {
            padding: 14px 5px; border: 1px solid #eee; border-radius: 14px; font-size: 0.85rem;
            outline: none; text-align: center; width: 100%; box-sizing: border-box; background: white;
            transition: all 0.2s; font-weight: 600;
        }

        .stats-container { width: 100%; background: #fff; padding: 15px; border-radius: 20px; font-size: 0.8rem; box-sizing: border-box; border: 1px solid #eee; }
        .stats-title { font-weight: 800; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; color: #bbb; font-size: 0.7rem; letter-spacing: 1px; }
        .stats-row { display: flex; justify-content: space-between; margin-bottom: 8px; color: #666; font-weight: 600; }

        .game-canvas-area { 
            width: 100%; min-height: 220px; height: auto; position: relative; margin: 15px 0; padding-bottom: 25px; overflow: hidden; background: #fff; border: 2px solid #eee; border-radius: 20px; 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            transition: min-height 0.3s ease-out;
        }

        #hand-display { 
            display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; padding: 25px 15px; width: 100%; box-sizing: border-box; 
        }
        .hand-wrapper { display: flex; flex-direction: column; align-items: center; flex: 0 0 calc(33.33% - 15px); min-width: 85px; transition: transform 0.4s ease; z-index: 1; }
        .hand-img { width: 100%; max-width: 110px; height: auto; aspect-ratio: 1/1; object-fit: contain; cursor: pointer; -webkit-tap-highlight-color: transparent; animation: floating 3s ease-in-out infinite; }
        .hand-name { font-size: 0.75rem; font-weight: 800; margin-top: 8px; color: #555; text-align: center; word-break: keep-all; line-height: 1.2; }

        @keyframes floating { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        .tension-shake { animation: tension-animation 0.1s infinite !important; }
        @keyframes tension-animation { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-1px, -1px); } 100% { transform: translate(1px, -1px); } }
        .shake { animation: winner-shake 0.15s infinite !important; }
        @keyframes winner-shake { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(3px); } }

        #bowls-container { 
            display: flex; flex-wrap: wrap; justify-content: center; align-items: flex-end;
            gap: 12px; padding: 120px 10px 30px; width: 100%; box-sizing: border-box; margin-top: auto;
        }
        .cat-bowl { flex: 0 1 calc(16.66% - 12px); min-width: 48px; text-align: center; transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .bowl-img { width: 100%; max-width: 42px; height: auto; display: block; margin: 0 auto; transition: transform 0.3s; }
        .bowl-name { 
            font-size: 0.55rem; font-weight: 800; color: #888; margin-top: 6px; 
            white-space: normal; word-break: keep-all; line-height: 1.1; overflow: hidden;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
        }
        
        #moving-cat { 
            position: absolute; width: 85px; height: auto; z-index: 15; top: 15px;
            transition: left 0.4s ease-in-out, top 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        @keyframes cat-walk { 0% { transform: translateX(-5px) rotate(-1deg); } 50% { transform: translateX(5px) rotate(1deg); } 100% { transform: translateX(-5px) rotate(-1deg); } }
        .cat-moving { animation: cat-walk 0.4s infinite; }
        .bowl-highlight { transform: scale(1.15); z-index: 10 !important; filter: drop-shadow(0 0 8px rgba(255,215,0,0.5)); }
        .bowl-dimmed { opacity: 0.2; filter: blur(2px); z-index: 1 !important; }

        #roulette-container { position: relative; width: 100%; max-width: 320px; margin: 20px auto; display: flex; flex-direction: column; align-items: center; }
        .roulette-pin {
            position: absolute; top: -18px; left: 50%; transform: translateX(-50%);
            width: 34px; height: 44px; z-index: 20; filter: drop-shadow(0 3px 5px rgba(0,0,0,0.3));
        }

        .btn-main {
            padding: 20px 10px; font-size: 1.1rem; font-weight: 800; background: var(--primary-color); color: white; border: none; border-radius: 20px;
            cursor: pointer; width: 85%; max-width: 320px; transition: all 0.1s;
            box-shadow: 0 8px 0 var(--btn-shadow); text-transform: uppercase;
            position: relative; top: 0; margin-bottom: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .btn-main:active:not(:disabled) { top: 4px; box-shadow: 0 4px 0 var(--btn-shadow); transform: scale(0.98); }

        .btn-sub {
            padding: 16px; font-size: 0.9rem; font-weight: 800; background: #fff; color: #000; border: 2px solid #000; border-radius: 20px;
            cursor: pointer; width: 85%; max-width: 320px; transition: all 0.1s;
            box-shadow: 0 6px 0 var(--btn-shadow); text-transform: uppercase; margin-bottom: 12px;
        }
        .btn-sub:active:not(:disabled) { transform: translateY(3px); box-shadow: 0 3px 0 var(--btn-shadow); }

        .btn-spin {
            padding: 18px; font-size: 1.2rem; font-weight: 900; background: #e74c3c; color: white; border: 3px solid #000; border-radius: 50px;
            cursor: pointer; width: 90%; max-width: 300px; transition: all 0.1s; margin: 20px auto;
            box-shadow: 0 6px 0 #333; text-transform: uppercase; display: block;
        }
        .btn-spin:active:not(:disabled) { transform: translateY(4px); box-shadow: 0 2px 0 #333; }
        .btn-spin:disabled { opacity: 0.4; cursor: not-allowed; box-shadow: none; transform: translateY(4px); }

        .btn-again { background-color: var(--btn-dark-gray) !important; box-shadow: 0 6px 0 #222 !important; }

        #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: none; align-items: flex-end; justify-content: center; backdrop-filter: blur(4px); }
        .modal-content { background: white; width: 100%; max-width: 500px; border-radius: 30px 30px 0 0; padding: 30px 25px; box-sizing: border-box; animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .lang-btn { background: #eee; border: none; padding: 6px 12px; font-size: 0.7rem; font-weight: 800; border-radius: 8px; cursor: pointer; color: #999; transition: 0.2s; }
        .lang-btn.active { background: #000; color: #fff; }

        .monthly-king-badge {
            background: #fff8e1; border: 1.5px solid #ffca28; border-radius: 15px;
            padding: 10px 15px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;
            flex-wrap: nowrap; overflow: hidden;
        }
        .king-crown { font-size: 1.4rem; flex-shrink: 0; }
        .king-info { text-align: left; flex: 1; min-width: 0; }
        .king-name { font-weight: 900; font-size: 1rem; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .king-tag { font-size: 0.65rem; font-weight: 800; color: #ffca28; letter-spacing: 1px; white-space: nowrap; }
        .king-count-area { margin-left: auto; font-weight: 800; color: #ffca28; white-space: nowrap; flex-shrink: 0; }

        .history-item { display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #f0f0f0; font-size: 0.85rem; font-weight: 600; color: #333; }
        .about-text { font-size: 0.85rem; color: #666; line-height: 1.7; text-align: left; word-break: keep-all; }
        .about-label { font-weight: 800; color: #000; margin-top: 18px; display: block; font-size: 0.9rem; }

        .receipt-container { width: 100%; display: flex; justify-content: center; margin: 15px 0; }
        .receipt {
            background: #fff; color: #333; width: 280px; padding: 35px 25px 25px; font-family: 'Courier Prime', monospace;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1); border-radius: 2px; position: relative; margin: 0 auto;
            text-align: left;
        }
        .receipt.show { animation: slideUpReceipt 0.6s forwards; }
        @keyframes slideUpReceipt { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .receipt-header { font-size: 1.5rem; font-weight: 800; margin-bottom: 5px; letter-spacing: 2px; text-align: center; }
        .receipt-subheader { font-size: 0.75rem; margin-bottom: 20px; text-align: center; color: #666; font-weight: 700; }
        .receipt-line { border-top: 1px dashed #bbb; margin: 12px 0; width: 100%; }
        .receipt-item { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.85rem; width: 100%; font-weight: 600; }
        .receipt-total { display: flex; flex-direction: column; align-items: center; margin: 25px 0; padding: 15px 0; border-top: 2px solid #333; border-bottom: 2px solid #333; }
        .label-customer { font-size: 0.75rem; font-weight: 700; color: #888; margin-bottom: 8px; text-transform: uppercase; }
        .value-customer { font-size: 2.2rem; font-weight: 900; color: var(--point-red); letter-spacing: -1px; text-align: center; }
        .fortune-area { font-size: 0.75rem; line-height: 1.6; color: #555; text-align: center; margin-top: 15px; word-break: keep-all; font-style: italic; }

        .footer { width: 100%; text-align: center; padding: 40px 0; font-size: 0.75rem; color: #ccc; letter-spacing: 1px; }
        .hidden { display: none !important; }

        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.6s ease-out; }
        .loading-text { font-family: 'Courier Prime', monospace; font-size: 0.8rem; letter-spacing: 3px; margin-top: 20px; color: #333; }
        .loading-bar-container { width: 150px; height: 4px; background: #eee; border-radius: 10px; margin-top: 10px; overflow: hidden; }
        .loading-bar-fill { height: 100%; width: 0%; background: #000; transition: width 0.1s; }
    </style>
</head>
<body>

    <div id="splash-screen">
        <img src="coffee.png" alt="Logo" style="width:110px; animation: floating 2s ease-in-out infinite;">
        <div id="loading-progress-area">
            <div class="loading-text">LOADING...</div>
            <div class="loading-bar-container"><div id="progress-fill" class="loading-bar-fill"></div></div>
        </div>
        <div id="start-action-area" style="display:none; flex-direction:column; align-items:center; margin-top:20px; width: 100%;">
            <button class="btn-main" id="btn-start" onclick="handleStartGame()">START GAME</button>
            <div id="start-hint" style="font-size:0.7rem; color:#bbb; margin-top:8px; letter-spacing:1px; font-weight:800;">TAP TO BREW LUCK</div>
        </div>
    </div>

    <audio id="bgm-player" loop preload="auto">
        <source src="cafe_music_bgm.mp3" type="audio/mpeg">
    </audio>

    <div id="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="modal-list-container"></div>
        </div>
    </div>

    <div class="wrapper">
        <header onclick="goFront()">
            <div class="title-container">
                <span class="title-lucky">lucky</span><span class="title-bean">bean</span>
            </div>
        </header>

        <main id="main-content">
            <div class="game-screen">
                <img src="cafe_facade.png" alt="Cafe" id="main-img" class="title-image">
                <div id="rpg-textbox"><div id="rpg-content"></div></div>
            </div>

            <div id="front-view">
                <div class="card-container">
                    <div id="stats-dashboard" class="stats-container hidden">
                        <div class="stats-title"><span id="txt-donation-kings">ğŸ† DONATION KINGS</span> <button id="btn-reset-small" style="font-size:0.65rem; color:#aaa; border:none; background:none; cursor:pointer;" onclick="resetStats()">RESET</button></div>
                        <div id="stats-list"></div>
                    </div>
                    <div id="no-stats-msg" style="font-size: 0.8rem; color: #ccc; font-weight: 700;">WELCOME TO THE CAFE!</div>
                </div>
                <div style="display: flex; flex-direction: column; align-items: center; width: 100%;">
                    <button class="btn-main" id="btn-enter-shop" onclick="showGameSelector()">ENTER SHOP</button>
                    <button class="btn-sub" id="btn-go-setup" onclick="goSetup()">SETTINGS</button>
                    <button class="btn-sub" id="btn-go-history" onclick="goHistory()">HISTORY</button>
                    <button class="btn-sub" id="btn-go-about" onclick="goAbout()">ABOUT</button>
                </div>
            </div>

            <div id="selector-view" class="hidden">
                <div class="card-container">
                    <div class="order-menu-header">
                        <span id="txt-choose-luck">CHOOSE YOUR LUCK</span>
                        <button class="settings-icon-btn" onclick="goSetup('selector')">âš™ï¸</button>
                    </div>
                    <div class="icon-selector-grid">
                        <div class="icon-btn-item" onclick="startGame()">
                            <div class="icon-square"><img src="random_hand.png" alt="Hand"></div>
                            <div class="icon-label" id="txt-game-hand">Random Hand</div>
                        </div>
                        <div class="icon-btn-item" onclick="goRoulette()">
                            <div class="icon-square"><img src="lucky_roulette.png" alt="Roulette"></div>
                            <div class="icon-label" id="txt-game-roulette">Lucky Roulette</div>
                        </div>
                        <div class="icon-btn-item" onclick="goCatGame()">
                            <div class="icon-square"><img src="cat_icon.png" alt="Cat" style="width:70%;"></div>
                            <div class="icon-label" id="txt-game-cat">Cat's Choice</div>
                        </div>
                    </div>
                </div>
                <button class="btn-main" id="btn-back-menu-selector" onclick="goFront()" style="background:#eee; color:#999; box-shadow:0 8px 0 #ddd;">BACK TO MENU</button>
            </div>

            <div id="setup-view" class="hidden">
                <div class="card-container" style="text-align: left;">
                    <div class="order-menu-header">
                        <span id="txt-setting-title">ğŸ“‹ ORDER MENU SETTING</span>
                        <div class="lang-toggle-container">
                            <button id="lang-ko" class="lang-btn" onclick="setLanguage('ko')">KO</button>
                            <button id="lang-en" class="lang-btn" onclick="setLanguage('en')" style="margin-left:5px;">EN</button>
                        </div>
                    </div>
                    <div class="divider" style="margin-bottom: 15px;"></div>
                    <div class="picker-group">
                        <div class="picker-btn" onclick="openGroupModal()">
                            <span class="picker-label" id="lbl-group">GROUP</span>
                            <div class="picker-value"><span id="display-group-name">Empty</span></div>
                        </div>
                        <div class="picker-btn" onclick="openMemberModal()">
                            <span class="picker-label" id="lbl-members">MEMBERS</span>
                            <div class="picker-value"><span id="display-member-count">3 Members</span></div>
                        </div>
                    </div>
                    
                    <div class="setting-row">
                        <span class="toggle-label" id="lbl-history-onoff">HISTORY RECORDING</span>
                        <label class="switch">
                            <input type="checkbox" id="history-toggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="name-mgmt-bar">
                        <button class="btn-text" id="btn-random" onclick="fillRandomNames()">RANDOM</button>
                        <button class="btn-text" id="btn-clear" onclick="clearNames()">CLEAR</button>
                        <button class="btn-text" id="btn-save-team" onclick="saveCurrentTeam()" style="color:#888;">SAVE</button>
                    </div>
                    <div class="divider"></div>
                    <div id="name-input-container"></div>
                </div>
                <div style="display: flex; flex-direction: column; align-items: center; width: 100%;">
                    <button class="btn-main" id="btn-save-exit" onclick="saveAndGoHome()">SAVE & EXIT</button>
                    <button class="btn-sub" id="btn-back-home" onclick="goFront()" style="background:#fff; color:#bbb; border:2px solid #eee; box-shadow:0 6px 0 #f8f8f8;">BACK TO HOME</button>
                </div>
            </div>

            <div id="game-view" class="hidden">
                <div class="card-container" style="text-align:left;">
                    <div class="order-menu-header">
                        <span id="txt-game-hand-title">RANDOM HAND</span>
                        <button class="settings-icon-btn" onclick="goSetup('hand')">âš™ï¸</button>
                    </div>
                    <div class="divider"></div>
                    <div class="game-canvas-area" style="min-height: 200px;">
                        <div id="hand-display"></div>
                    </div>
                    <button id="btn-shuffle" class="btn-spin" onclick="shufflePositions()">SHUFFLE</button>
                    
                    <div id="hand-result-anchor"></div>
                    <div id="lucky-area" class="hidden" style="margin-bottom:20px; font-weight:900; color:#f1c40f; font-size:1.2rem; text-shadow: 1px 1px 0px #000; text-align: center;">ğŸŒŸ EXTRA LUCK! ALL PASS! ğŸŒŸ</div>
                    
                    <button id="hand-again-btn" class="btn-spin btn-again hidden" onclick="confirmReplay('hand')">REPLAY</button>
                </div>
                <div id="game-btn-group" style="display:flex; flex-direction:column; align-items:center; gap:8px; width:100%;">
                    <button class="btn-main" id="btn-back-selector-hand" onclick="showGameSelector()">CHANGE GAME</button>
                    <button class="btn-sub" id="btn-back-menu-hand" onclick="goFront()" style="color:#bbb; border-color:#eee; box-shadow:0 6px 0 #f8f8f8;">BACK TO MENU</button>
                </div>
            </div>

            <div id="roulette-view" class="hidden">
                <div class="card-container" style="text-align:left;">
                    <div class="order-menu-header">
                        <span id="txt-roulette-title">ğŸ¡ LUCKY ROULETTE</span>
                        <button class="settings-icon-btn" onclick="goSetup('roulette')">âš™ï¸</button>
                    </div>
                    <div class="divider"></div>
                    <div class="game-canvas-area" style="justify-content:center; min-height: 380px;">
                        <div id="roulette-container">
                            <svg class="roulette-pin" viewBox="0 0 30 40">
                                <path d="M15 0 L30 20 L15 40 L0 20 Z" fill="#e74c3c" stroke="#000" stroke-width="2"/>
                            </svg>
                            <canvas id="rouletteCanvas" width="400" height="400" style="width:100%; max-width:320px; border-radius:50%; border:6px solid #333;"></canvas>
                        </div>
                    </div>
                    <button id="roulette-spin-btn" class="btn-spin" onclick="spinRoulette()">SPIN</button>
                    
                    <div id="roulette-result-anchor"></div>
                    <button id="roulette-again-btn" class="btn-spin btn-again hidden" onclick="confirmReplay('roulette')">REPLAY</button>
                </div>
                <div id="roulette-action-area" style="display:flex; flex-direction:column; align-items:center; width:100%; gap:8px;">
                     <button class="btn-main" id="btn-back-selector-roulette" onclick="showGameSelector()">CHANGE GAME</button>
                     <button class="btn-sub" id="btn-back-menu-roulette" onclick="goFront()" style="color:#bbb; border-color:#eee; box-shadow:0 6px 0 #f8f8f8;">BACK TO MENU</button>
                </div>
            </div>

            <div id="cat-view" class="hidden">
                <div class="card-container" style="text-align:left;">
                    <div class="order-menu-header">
                        <span id="txt-cat-title">ğŸˆ CAT'S CHOICE</span>
                        <button class="settings-icon-btn" onclick="goSetup('cat')">âš™ï¸</button>
                    </div>
                    <div class="divider"></div>
                    <div id="cat-white-box" class="game-canvas-area" style="min-height: 320px;">
                        <img src="cat_stand.png" id="moving-cat" alt="Cat" style="left: 50%; transform: translateX(-50%);">
                        <div id="bowls-container"></div>
                    </div>
                    <button id="cat-start-btn" class="btn-spin" onclick="startCatGame()">START</button>
                    
                    <div id="cat-result-anchor"></div>
                    <button id="cat-again-btn" class="btn-spin btn-again hidden" onclick="confirmReplay('cat')">REPLAY</button>
                </div>
                <div id="cat-action-area" style="display:flex; flex-direction:column; align-items:center; width:100%; gap:8px;">
                    <button class="btn-main" id="btn-back-selector-cat" onclick="showGameSelector()">CHANGE GAME</button>
                    <button class="btn-sub" id="btn-back-menu-cat" onclick="goFront()" style="color:#bbb; border-color:#eee; box-shadow:0 6px 0 #f8f8f8;">BACK TO MENU</button>
                </div>
            </div>

            <div id="receipt-prototype-area" class="hidden">
                <div class="receipt-container">
                    <div class="receipt">
                        <div class="receipt-header">RECEIPT</div>
                        <div class="receipt-subheader">LUCKY BEAN SHOP</div>
                        <div class="receipt-item"><span class="receipt-date"></span><span class="receipt-order-no"></span></div>
                        <div class="receipt-line"></div>
                        <div class="receipt-item"><span class="receipt-menu"></span><span class="receipt-qty"></span></div>
                        <div class="receipt-item"><span class="txt-lbl-unit">UNIT PRICE</span><span class="receipt-price"></span></div>
                        <div class="divider" style="margin: 10px 0; border-top: 1px dashed #bbb;"></div>
                        <div class="receipt-item" style="font-weight:800;"><span class="txt-lbl-sub">SUBTOTAL</span><span class="receipt-subtotal"></span></div>
                        <div class="receipt-total">
                            <span class="label-customer txt-lbl-payer">SELECTED CUSTOMER</span>
                            <span class="receipt-payer value-customer"></span>
                        </div>
                        <div class="receipt-line"></div>
                        <div class="fortune-area receipt-fortune"></div>
                        <button class="btn-text btn-capture-run" style="width:100%; margin-top: 15px; color:#ccc; border:1px solid #eee; border-radius:10px; padding:8px; font-size:0.6rem;">GET A RECEIPT</button>
                    </div>
                </div>
            </div>

            <div id="about-view" class="hidden">
                <div class="card-container" style="text-align: left;">
                    <div class="order-menu-header" id="txt-about-title">â˜• ABOUT LUCKY BEAN</div>
                    <div class="divider"></div>
                    <div class="about-text" id="txt-about-content"></div>
                </div>
                <button class="btn-main" id="btn-back-home-about" onclick="goFront()">BACK TO HOME</button>
            </div>

            <div id="history-view" class="hidden">
                <div class="card-container" style="text-align: left;">
                    <div class="order-menu-header" id="txt-history-title">ğŸ† DONATION HISTORY</div>
                    <div class="divider"></div>
                    <div id="monthly-king-area"></div>
                    <div id="history-list-content"></div>
                    <button class="btn-text" id="btn-reset-all" onclick="resetStats()" style="width:100%; margin-top:15px; color:var(--point-red);">RESET ALL DATA</button>
                </div>
                <button class="btn-main" id="btn-back-home-history" onclick="goFront()">BACK TO HOME</button>
            </div>
        </main>
        <div class="footer">v0.6.5 | â“’ 2026. Gonystudio. All rights reserved.</div>
    </div>

    <script>
        const i18n = {
            en: {
                welcome: "Welcome to the Lucky Bean!",
                choose_luck: "Choose your luckiest game!",
                setting_msg: "Settings: Manage your team.",
                how_to: "How to play and track donations.",
                history_msg: "Who donated the most coffee?",
                pick_hand: "Who will pay? Pick a hand!",
                hands_mixed: "Hands Mixed!",
                safe_msg: " is Safe!",
                pay_msg: " will pay!",
                lucky_round: "LUCKY! Everyone is SAFE! ğŸŒŸ",
                spin_msg: "Spin the wheel for luck!",
                cat_msg: "Wait for the cat's choice...",
                cat_start: "Who will the cat visit?",
                all_pass: "ğŸŒŸ ALL PASS ğŸŒŸ",
                all_pass_unbelievable: "ğŸŒŸ UNBELIEVABLE! ALL PASS! ğŸŒŸ",
                btn_start: "START GAME",
                btn_enter_shop: "ENTER SHOP",
                btn_setup: "SETTINGS",
                btn_history: "HISTORY",
                btn_about: "ABOUT",
                btn_back_menu: "BACK TO MENU",
                btn_back_home: "BACK TO HOME",
                btn_save_exit: "SAVE & EXIT",
                btn_shuffle: "SHUFFLE",
                btn_again: "REPLAY",
                btn_spin: "SPIN",
                btn_change_game: "CHANGE GAME",
                lbl_group: "GROUP",
                lbl_members: "MEMBERS",
                lbl_random: "RANDOM",
                lbl_clear: "CLEAR",
                lbl_save: "SAVE",
                lbl_kings: "ğŸ† DONATION KINGS",
                lbl_unit_price: "UNIT PRICE",
                lbl_subtotal: "SUBTOTAL",
                lbl_selected: "SELECTED CUSTOMER",
                lbl_get_receipt: "GET A RECEIPT",
                lbl_monthly_king: "MONTHLY KING",
                lbl_times: "times",
                lbl_empty: "Empty",
                lbl_member_count: "Members",
                lbl_history_onoff: "HISTORY RECORDING",
                confirm_replay: "Are you sure you want to replay?",
                txt_about_content: `<span class="about-label">WHAT IS LUCKY BEAN?</span> Lucky Bean is the ultimate mini-game app for coffee-loving teams! It turns the daily "Who pays?" moment into a thrilling mini-game.<br><span class="about-label">HOW TO PLAY</span> 1. Enter names in SETTINGS. You can save groups for quick access later!<br>2. Go to ENTER SHOP and pick your favorite game: Random Hand, Roulette, or Cat.<br>3. Interact with the game. The 'Chosen One' pays! You can capture and share the receipt.`,
                fortunes: ["Great luck will come to you!", "Kindness returns to you.", "Small loss, big luck later!", "Your team respects you!"],
                menus: ["Americano", "Cafe Latte", "Vanilla Latte", "Flat White", "Cold Brew", "Einspanner"]
            },
            ko: {
                welcome: "ëŸ­í‚¤ë¹ˆì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!",
                choose_luck: "ê°€ì¥ ìš´ ì¢‹ì€ ê²Œì„ì„ ê³¨ë¼ë³´ì„¸ìš”!",
                setting_msg: "ì„¤ì •: íŒ€ ë©¤ë²„ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”.",
                how_to: "ê²Œì„ ë°©ë²• ë° íˆìŠ¤í† ë¦¬ ì•ˆë‚´",
                history_msg: "ëˆ„ê°€ ê°€ì¥ ì»¤í”¼ë¥¼ ë§ì´ ìƒ€ì„ê¹Œìš”?",
                pick_hand: "ëˆ„ê°€ ë‚¼ê¹Œìš”? ì†ì„ ê³¨ë¼ë³´ì„¸ìš”!",
                hands_mixed: "ì†ì´ ì„ì˜€ìŠµë‹ˆë‹¤!",
                safe_msg: " ë‹˜ì€ ìƒì¡´!",
                pay_msg: " ë‹˜ì´ ë‹¹ì²¨ë˜ì—ˆìŠµë‹ˆë‹¤!",
                lucky_round: "ëŸ­í‚¤! ëª¨ë‘ ìƒì¡´í–ˆìŠµë‹ˆë‹¤! ğŸŒŸ",
                spin_msg: "ë£°ë ›ì„ ëŒë ¤ ìš´ì„ ì‹œí—˜í•˜ì„¸ìš”!",
                cat_msg: "ê³ ì–‘ì´ê°€ ê³ ë¯¼ ì¤‘ì…ë‹ˆë‹¤...",
                cat_start: "ê³ ì–‘ì´ëŠ” ëˆ„êµ¬ì—ê²Œ ê°ˆê¹Œìš”?",
                all_pass: "ğŸŒŸ ì „ì› í†µê³¼ ğŸŒŸ",
                all_pass_unbelievable: "ğŸŒŸ ëŒ€ë°•! ì „ì› í†µê³¼ì…ë‹ˆë‹¤! ğŸŒŸ",
                btn_start: "ê²Œì„ ì‹œì‘",
                btn_enter_shop: "ì…ì¥í•˜ê¸°",
                btn_setup: "ì„¤ì •",
                btn_history: "íˆìŠ¤í† ë¦¬",
                btn_about: "ì •ë³´",
                btn_back_menu: "ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°",
                btn_back_home: "í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°",
                btn_save_exit: "ì €ì¥ ë° ë‚˜ê°€ê¸°",
                btn_shuffle: "ì…”í”Œ",
                btn_again: "ë‹¤ì‹œí•˜ê¸°",
                btn_spin: "ëŒë¦¬ê¸°",
                btn_change_game: "ê²Œì„ ë³€ê²½",
                lbl_group: "ê·¸ë£¹",
                lbl_members: "ì¸ì›",
                lbl_random: "ëœë¤",
                lbl_clear: "ì´ˆê¸°í™”",
                lbl_save: "ì €ì¥",
                lbl_kings: "ğŸ† ì˜¤ëŠ˜ì˜ ê¸°ë¶€ì™•",
                lbl_unit_price: "ë‹¨ê°€",
                lbl_subtotal: "í•©ê³„",
                lbl_selected: "ë‹¹ì²¨ì",
                lbl_get_receipt: "ì˜ìˆ˜ì¦ ë°›ê¸°",
                lbl_monthly_king: "ì´ë‹¬ì˜ ê¸°ë¶€ì™•",
                lbl_times: "íšŒ",
                lbl_empty: "ë¹„ì–´ìˆìŒ",
                lbl_member_count: "ëª…",
                lbl_history_onoff: "ê²Œì„ ê¸°ë¡ ì €ì¥",
                confirm_replay: "ì •ë§ ê²Œì„ì„ ë‹¤ì‹œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
                txt_about_content: `<span class="about-label">ëŸ­í‚¤ë¹ˆì´ë€?</span> ì»¤í”¼ë¥¼ ì‚¬ë‘í•˜ëŠ” ë™ë£Œë“¤ì„ ìœ„í•œ ìµœê³ ì˜ ë³µë¶ˆë³µ ë„êµ¬ì…ë‹ˆë‹¤. ë§¤ì¼ ëŒì•„ì˜¤ëŠ” "ëˆ„ê°€ ì»¤í”¼ ì‚´ê¹Œ?"ì˜ ê³ ë¯¼ì„ ì§œë¦¿í•œ ë¯¸ë‹ˆ ê²Œì„ìœ¼ë¡œ ì¦ê²¨ë³´ì„¸ìš”!<br><span class="about-label">ê²Œì„ ë°©ë²•</span> 1. SETTINGSì—ì„œ íŒ€ì› ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”. ê·¸ë£¹ ì €ì¥ì´ ê°€ëŠ¥í•´ í¸ë¦¬í•©ë‹ˆë‹¤.<br>2. ENTER SHOPì—ì„œ ì›í•˜ëŠ” ê²Œì„ì„ ì„ íƒí•˜ì„¸ìš”.<br>3. ê²Œì„ì— ì°¸ì—¬í•˜ë©´ í–‰ìš´ì˜ ë‹¹ì²¨ìê°€ ê²°ì •ë©ë‹ˆë‹¤. ë‹¹ì²¨ëœ ì‚¬ëŒì´ ê²°ì œ! ì˜ìˆ˜ì¦ì„ ìº¡ì²˜í•´ ê³µìœ í•´ë³´ì„¸ìš”.`,
                fortunes: ["ì˜¤ëŠ˜ ì»¤í”¼ë¥¼ ìœ ë‹¹ì‹ , ëŒ€ë°• í–‰ìš´ì´ ì˜¬ ê±°ì˜ˆìš”!", "ë² í‘¼ ë§Œí¼ ë” í° ë³µì´ ë“¤ì–´ì˜µë‹ˆë‹¤.", "ì§€ê°‘ì€ ë¹„ì—ˆì–´ë„ ì¸ì‹¬ì€ ê½‰ ì°¼ë„¤ìš”!"],
                menus: ["ì•„ë©”ë¦¬ì¹´ë…¸", "ì¹´í˜ë¼ë–¼", "ë°”ë‹ë¼ë¼ë–¼", "í”Œë«í™”ì´íŠ¸", "ì½œë“œë¸Œë£¨"]
            }
        };

        let currentLang = localStorage.getItem('luckyBeanLang') || 'en';
        const randomNicknames = ["Coffee Monster", "Latte King", "Ice Bear", "Sugar Addict", "Lucky Guy", "Morning Coffee", "Bean Hunter", "Cream Lover"];

        let memberNames = []; let typeTimeout; let isGameOver = false; let winnerIndex = -1;
        let isLuckyRound = false; let lastWasLucky = false;
        let currentTeamName = 'Empty'; let currentMemberCount = 3; let isShuffling = false;
        let isAudioStarted = false;
        let rouletteAngle = 0; let rouletteSpinning = false; let currentRouletteItems = [];
        let catRunning = false;
        let fromView = 'front';
        let recordStats = localStorage.getItem('luckyBeanRecord') !== 'false';

        const AudioEngine = {
            ctx: null, bgm: null,
            initAndPlayBGM() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                    this.bgm = document.getElementById('bgm-player');
                    this.bgm.volume = 0.15;
                }
                if (this.ctx.state === 'suspended') this.ctx.resume();
                if (this.bgm && this.bgm.paused) this.bgm.play().then(() => { isAudioStarted = true; }).catch(e => console.log(e));
            },
            pauseBGM() { if (this.bgm) this.bgm.pause(); },
            resumeBGM() { if (this.bgm && isAudioStarted) this.bgm.play(); },
            play(type) {
                if (!this.ctx || this.ctx.state === 'suspended') return;
                const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain(); const now = this.ctx.currentTime;
                osc.connect(gain); gain.connect(this.ctx.destination);
                if (type === 'start') {
                    osc.frequency.setValueAtTime(698.46, now); osc.frequency.exponentialRampToValueAtTime(1046.50, now + 0.15);
                    gain.gain.setValueAtTime(0.5, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                    osc.start(now); osc.stop(now + 0.2);
                } else if (type === 'safe') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(1174.66, now);
                    gain.gain.setValueAtTime(0.3, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    osc.start(now); osc.stop(now + 0.1);
                } else if (type === 'fail') {
                    osc.frequency.setValueAtTime(880, now); osc.frequency.exponentialRampToValueAtTime(110, now + 0.5);
                    gain.gain.setValueAtTime(0.5, now); gain.gain.linearRampToValueAtTime(0, now + 0.5);
                    osc.start(now); osc.stop(now + 0.5);
                } else if (type === 'whoosh') {
                    osc.type = 'triangle'; osc.frequency.setValueAtTime(100, now); osc.frequency.exponentialRampToValueAtTime(1200, now + 0.3);
                    gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc.start(now); osc.stop(now + 0.3);
                }
            }
        };

        document.addEventListener("visibilitychange", () => {
            if (document.hidden) AudioEngine.pauseBGM();
            else AudioEngine.resumeBGM();
        });

        window.onload = () => {
            const fill = document.getElementById('progress-fill');
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress >= 100) {
                    progress = 100; clearInterval(interval);
                    setTimeout(() => {
                        document.getElementById('loading-progress-area').style.display = 'none';
                        document.getElementById('start-action-area').style.display = 'flex';
                    }, 500);
                }
                fill.style.width = progress + '%';
            }, 50);
            document.getElementById('history-toggle').checked = recordStats;
            applyLanguage();
        };

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('luckyBeanLang', lang);
            applyLanguage();
            if (!document.getElementById('setup-view').classList.contains('hidden')) goSetup(fromView);
        }

        function applyLanguage() {
            const t = i18n[currentLang];
            document.getElementById('lang-ko').classList.toggle('active', currentLang === 'ko');
            document.getElementById('lang-en').classList.toggle('active', currentLang === 'en');
            document.getElementById('btn-start').innerText = t.btn_start;
            document.getElementById('btn-enter-shop').innerText = t.btn_enter_shop;
            document.getElementById('btn-go-setup').innerText = t.btn_setup;
            document.getElementById('btn-go-history').innerText = t.btn_history;
            document.getElementById('btn-go-about').innerText = t.btn_about;
            document.getElementById('btn-back-menu-selector').innerText = t.btn_back_menu;
            document.getElementById('btn-back-menu-hand').innerText = t.btn_back_menu;
            document.getElementById('btn-back-menu-roulette').innerText = t.btn_back_menu;
            document.getElementById('btn-back-menu-cat').innerText = t.btn_back_menu;
            document.getElementById('btn-back-home').innerText = t.btn_back_home;
            document.getElementById('btn-back-home-about').innerText = t.btn_back_home;
            document.getElementById('btn-back-home-history').innerText = t.btn_back_home;
            document.getElementById('btn-save-exit').innerText = t.btn_save_exit;
            document.getElementById('btn-shuffle').innerText = t.btn_shuffle;
            document.getElementById('hand-again-btn').innerText = t.btn_again;
            document.getElementById('roulette-again-btn').innerText = t.btn_again;
            document.getElementById('cat-again-btn').innerText = t.btn_again;
            document.getElementById('roulette-spin-btn').innerText = t.btn_spin;
            document.getElementById('cat-start-btn').innerText = t.btn_start;
            
            document.getElementById('btn-back-selector-hand').innerText = t.btn_change_game;
            document.getElementById('btn-back-selector-roulette').innerText = t.btn_change_game;
            document.getElementById('btn-back-selector-cat').innerText = t.btn_change_game;

            document.getElementById('lbl-group').innerText = t.lbl_group;
            document.getElementById('lbl-members').innerText = t.lbl_members;
            document.getElementById('lbl-history-onoff').innerText = t.lbl_history_onoff;
            document.getElementById('btn-random').innerText = t.lbl_random;
            document.getElementById('btn-clear').innerText = t.lbl_clear;
            document.getElementById('btn-save-team').innerText = t.lbl_save;
            document.getElementById('txt-donation-kings').innerText = t.lbl_kings;
            document.getElementById('txt-choose-luck').innerText = t.choose_luck;

            document.getElementById('txt-game-hand-title').innerText = currentLang === 'ko' ? "ëœë¤ ì† ë½‘ê¸°" : "Random Hand";
            document.getElementById('txt-game-hand').innerText = currentLang === 'ko' ? "ëœë¤ ì† ë½‘ê¸°" : "Random Hand";
            document.getElementById('txt-game-roulette').innerText = currentLang === 'ko' ? "í–‰ìš´ì˜ ë£°ë ›" : "Lucky Roulette";
            document.getElementById('txt-game-cat').innerText = currentLang === 'ko' ? "ê³ ì–‘ì´ì˜ ì„ íƒ" : "Cat's Choice";
            
            document.getElementById('txt-setting-title').innerHTML = `ğŸ“‹ ${currentLang === 'ko' ? "ì£¼ë¬¸ ë©”ë‰´ ì„¤ì •" : "ORDER MENU SETTING"}`;
            document.getElementById('txt-roulette-title').innerHTML = `ğŸ¡ ${currentLang === 'ko' ? "í–‰ìš´ì˜ ë£°ë ›" : "LUCKY ROULETTE"}`;
            document.getElementById('txt-cat-title').innerHTML = `ğŸˆ ${currentLang === 'ko' ? "ê³ ì–‘ì´ì˜ ì„ íƒ" : "CAT'S CHOICE"}`;
            document.getElementById('txt-about-title').innerHTML = `â˜• ${currentLang === 'ko' ? "ëŸ­í‚¤ë¹ˆ ì •ë³´" : "ABOUT LUCKY BEAN"}`;
            document.getElementById('txt-history-title').innerHTML = `ğŸ† ${currentLang === 'ko' ? "ê¸°ë¶€ íˆìŠ¤í† ë¦¬" : "DONATION HISTORY"}`;
            document.getElementById('txt-about-content').innerHTML = t.txt_about_content;
            document.getElementById('display-group-name').innerText = currentTeamName === 'Empty' ? t.lbl_empty : currentTeamName;
            document.getElementById('display-member-count').innerText = `${currentMemberCount}${currentLang === 'ko' ? 'ëª…' : ' Members'}`;
        }

        function updateText(msgKey, isDirect = false) {
            clearTimeout(typeTimeout);
            const content = document.getElementById('rpg-content'); content.innerText = ''; let i = 0;
            const msg = isDirect ? msgKey : i18n[currentLang][msgKey];
            function typing() { if (i < msg.length) { content.innerText += msg.charAt(i); i++; typeTimeout = setTimeout(typing, 40); } }
            typing();
        }

        function handleStartGame() {
            AudioEngine.initAndPlayBGM();
            const splash = document.getElementById('splash-screen');
            splash.style.opacity = '0';
            setTimeout(() => { splash.style.display = 'none'; goFront(); }, 600);
        }

        function goFront() {
            fromView = 'front'; hideAllViews();
            document.getElementById('front-view').classList.remove('hidden');
            document.getElementById('main-img').src = 'cafe_facade.png';
            updateText('welcome'); showStats();
        }

        function showGameSelector() {
            fromView = 'selector'; hideAllViews();
            document.getElementById('selector-view').classList.remove('hidden');
            document.getElementById('main-img').src = 'cafe_facade_zoom.png';
            updateText('choose_luck');
        }

        function goSetup(source = 'front') {
            fromView = source; hideAllViews();
            document.getElementById('setup-view').classList.remove('hidden');
            document.getElementById('main-img').src = 'cafe_setting.png';
            updateText('setting_msg'); generateNameInputs();
        }

        function goAbout() {
            hideAllViews(); document.getElementById('about-view').classList.remove('hidden');
            document.getElementById('main-img').src = 'cafe_facade.png'; updateText('how_to');
        }

        function goHistory() {
            hideAllViews(); document.getElementById('history-view').classList.remove('hidden');
            document.getElementById('main-img').src = 'cafe_history.png';
            updateText('history_msg'); renderHistoryPage();
        }

        function hideAllViews() {
            ['front-view', 'selector-view', 'setup-view', 'game-view', 'about-view', 'history-view', 'roulette-view', 'cat-view'].forEach(v => {
                const el = document.getElementById(v); if(el) el.classList.add('hidden');
            });
            document.getElementById('lucky-area').classList.add('hidden');
            
            // ëª¨ë“  ì•µì»¤ ë¹„ìš°ê¸°
            document.getElementById('hand-result-anchor').innerHTML = '';
            document.getElementById('roulette-result-anchor').innerHTML = '';
            document.getElementById('cat-result-anchor').innerHTML = '';

            // ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™” (ì‚¬ë¼ì¡Œë˜ ë²„íŠ¼ë“¤ ë³µêµ¬)
            document.getElementById('btn-shuffle').classList.remove('hidden');
            document.getElementById('btn-shuffle').disabled = false;
            document.getElementById('roulette-spin-btn').classList.remove('hidden');
            document.getElementById('roulette-spin-btn').disabled = false;
            document.getElementById('cat-start-btn').classList.remove('hidden');
            document.getElementById('cat-start-btn').disabled = false;

            // ë‹¤ì‹œí•˜ê¸° ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            document.getElementById('hand-again-btn').classList.add('hidden');
            document.getElementById('roulette-again-btn').classList.add('hidden');
            document.getElementById('cat-again-btn').classList.add('hidden');
            
            document.querySelectorAll('button').forEach(btn => btn.disabled = false);
        }

        function saveAndGoHome() {
            recordStats = document.getElementById('history-toggle').checked;
            localStorage.setItem('luckyBeanRecord', recordStats);
            const inputs = document.querySelectorAll('.name-input');
            const tempNames = [];
            for (let i = 0; i < currentMemberCount; i++) { tempNames.push(inputs[i].value.trim() || `User ${i+1}`); }
            localStorage.setItem('lastCoffeeMembers', JSON.stringify(tempNames));
            
            if (fromView === 'hand') startGame();
            else if (fromView === 'roulette') goRoulette();
            else if (fromView === 'cat') goCatGame();
            else goFront();
        }

        function confirmReplay(gameType) {
            if (confirm(i18n[currentLang].confirm_replay)) {
                if (gameType === 'hand') startGame();
                else if (gameType === 'roulette') goRoulette();
                else if (gameType === 'cat') goCatGame();
            }
        }

        function openMemberModal() {
            const overlay = document.getElementById('modal-overlay'); const container = document.getElementById('modal-list-container');
            overlay.style.display = 'flex'; container.innerHTML = '';
            for (let i = 2; i <= 12; i++) {
                const div = document.createElement('div');
                div.style = "padding:18px 5px; border-bottom:1px solid #f8f8f8; text-align:center; cursor:pointer; font-weight:700;";
                div.innerText = `${i}${currentLang === 'ko' ? 'ëª…' : ' Members'}`; 
                div.onclick = () => { currentMemberCount = i; generateNameInputs(); closeModal(); };
                container.appendChild(div);
            }
        }

        function generateNameInputs(providedNames = null) {
            const container = document.getElementById('name-input-container');
            const saved = localStorage.getItem('lastCoffeeMembers');
            const lastSaved = saved ? JSON.parse(saved) : null;
            const currentInputs = Array.from(container.querySelectorAll('.name-input')).map(i => i.value);
            let namesToUse = providedNames || (lastSaved && lastSaved.length === currentMemberCount ? lastSaved : currentInputs);
            container.innerHTML = '';
            for (let i = 0; i < currentMemberCount; i++) {
                const input = document.createElement('input'); input.type = 'text'; input.className = 'name-input';
                input.placeholder = `User ${i+1}`; if (namesToUse && namesToUse[i]) input.value = namesToUse[i];
                container.appendChild(input);
            }
            document.getElementById('display-member-count').innerText = `${currentMemberCount}${currentLang === 'ko' ? 'ëª…' : ' Members'}`;
        }

        function fillRandomNames() {
            let shuffled = [...randomNicknames].sort(() => Math.random() - 0.5);
            document.querySelectorAll('.name-input').forEach((input, idx) => { input.value = shuffled[idx % shuffled.length]; });
        }

        function openGroupModal() {
            const overlay = document.getElementById('modal-overlay'); const container = document.getElementById('modal-list-container');
            overlay.style.display = 'flex'; container.innerHTML = '';
            const teams = JSON.parse(localStorage.getItem('coffeeTeams') || '{}');
            Object.keys(teams).forEach(name => {
                const div = document.createElement('div');
                div.style = "display:flex; justify-content:space-between; padding:18px 5px; border-bottom:1px solid #f8f8f8;";
                div.innerHTML = `<span style="flex:1; cursor:pointer; font-weight:700;" onclick="loadTeam('${name}')">${name}</span><span style="color:#eee; font-size:1.5rem; cursor:pointer; padding:0 10px;" onclick="deleteTeam('${name}')">Ã—</span>`;
                container.appendChild(div);
            });
        }

        function deleteTeam(name) {
            if(confirm(`${name} íŒ€ì„ ì‚­ì œí• ê¹Œìš”?`)) {
                const teams = JSON.parse(localStorage.getItem('coffeeTeams') || '{}');
                delete teams[name]; localStorage.setItem('coffeeTeams', JSON.stringify(teams));
                openGroupModal();
            }
        }

        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
        
        function loadTeam(name) {
            currentTeamName = name; document.getElementById('display-group-name').innerText = name;
            const teams = JSON.parse(localStorage.getItem('coffeeTeams') || '{}');
            if (teams[name]) { currentMemberCount = teams[name].count; generateNameInputs(teams[name].names); }
            closeModal();
        }

        function saveCurrentTeam() {
            const name = prompt(currentLang === 'ko' ? "ê·¸ë£¹ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:" : "Group Name:"); if (!name) return;
            const names = Array.from(document.querySelectorAll('.name-input')).map(i => i.value.trim() || `User`);
            const teams = JSON.parse(localStorage.getItem('coffeeTeams') || '{}');
            teams[name] = { count: currentMemberCount, names: names };
            localStorage.setItem('coffeeTeams', JSON.stringify(teams));
            currentTeamName = name; document.getElementById('display-group-name').innerText = name;
        }

        function clearNames() { document.querySelectorAll('.name-input').forEach(i => i.value = ''); }

        /* --- Hand Game --- */
        function startGame() {
            const saved = localStorage.getItem('lastCoffeeMembers');
            memberNames = saved ? JSON.parse(saved) : ["User 1", "User 2", "User 3"];
            AudioEngine.play('start'); winnerIndex = Math.floor(Math.random() * memberNames.length);
            isLuckyRound = !lastWasLucky && Math.random() < 0.15;
            isGameOver = false; hideAllViews(); // ì—¬ê¸°ì„œ ë²„íŠ¼ ìƒíƒœê°€ ëª¨ë‘ ë¦¬ì…‹ë¨
            document.getElementById('game-view').classList.remove('hidden');
            updateText('pick_hand');
            document.getElementById('main-img').src = 'cafe_counter.png';
            renderHands();
        }

        function renderHands() {
            const display = document.getElementById('hand-display'); display.innerHTML = '';
            for (let i = 0; i < memberNames.length; i++) {
                const wrapper = document.createElement('div'); wrapper.className = 'hand-wrapper';
                const handImg = document.createElement('img'); handImg.src = 'hand_nothing.png'; handImg.className = 'hand-img';
                handImg.onclick = () => handleHandClick(i, memberNames.length);
                const nameTag = document.createElement('div'); nameTag.className = 'hand-name'; nameTag.innerText = memberNames[i];
                wrapper.appendChild(handImg); wrapper.appendChild(nameTag); display.appendChild(wrapper);
            }
        }

        function shufflePositions() {
            if (isGameOver || isShuffling) return;
            isShuffling = true; AudioEngine.play('whoosh');
            const wrappers = document.querySelectorAll('.hand-wrapper');
            wrappers.forEach(w => { w.style.transition = "transform 0.4s"; w.style.transform = `scale(0.5) translate(${(Math.random()-0.5)*50}px, 50px)`; });
            setTimeout(() => {
                for (let i = memberNames.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1)); [memberNames[i], memberNames[j]] = [memberNames[j], memberNames[i]];
                }
                winnerIndex = Math.floor(Math.random() * memberNames.length);
                wrappers.forEach(w => { w.style.transform = `scale(1) translate(0, 0)`; });
                setTimeout(() => { renderHands(); isShuffling = false; updateText('hands_mixed'); }, 450);
            }, 450);
        }

        function handleHandClick(index, total) {
            if (isGameOver || isShuffling) return;
            const hands = document.getElementsByClassName('hand-img');
            if (hands[index].dataset.opened === "true") return;
            document.getElementById('btn-shuffle').disabled = true;
            hands[index].classList.add('tension-shake');
            setTimeout(() => {
                hands[index].classList.remove('tension-shake');
                if (isLuckyRound) {
                    isGameOver = true; lastWasLucky = true; AudioEngine.play('start');
                    for(let h of hands) { h.src = 'hand_open.png'; h.style.animation = "floating 0.5s infinite"; }
                    updateText('lucky_round'); document.getElementById('main-img').src = 'cafe_counter_lucky.png';
                    document.getElementById('lucky-area').classList.remove('hidden');
                    document.getElementById('hand-again-btn').classList.remove('hidden');
                    document.getElementById('btn-shuffle').classList.add('hidden');
                } else if (index === winnerIndex) {
                    isGameOver = true; lastWasLucky = false; AudioEngine.play('fail');
                    hands[index].src = 'hand_money.png'; hands[index].classList.add('shake');
                    for (let i = 0; i < hands.length; i++) if (i !== winnerIndex) hands[i].src = 'hand_clap.gif';
                    updateText(`${memberNames[index]}${i18n[currentLang].pay_msg}`, true);
                    document.getElementById('main-img').src = 'cafe_counter_thanks.gif';
                    if (recordStats) updateStats(memberNames[index]); 
                    confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
                    showFinish(total, memberNames[index], 'hand-result-anchor');
                    document.getElementById('hand-again-btn').classList.remove('hidden');
                    document.getElementById('btn-shuffle').classList.add('hidden');
                } else {
                    AudioEngine.play('safe'); hands[index].src = 'hand_open.png'; hands[index].dataset.opened = "true";
                    updateText(`${memberNames[index]}${i18n[currentLang].safe_msg}`, true);
                }
            }, 800);
        }

        /* --- Roulette --- */
        function goRoulette() {
            hideAllViews(); // ì—¬ê¸°ì„œ ë²„íŠ¼ ìƒíƒœê°€ ëª¨ë‘ ë¦¬ì…‹ë¨
            const saved = localStorage.getItem('lastCoffeeMembers');
            const members = saved ? JSON.parse(saved) : ["User 1", "User 2", "User 3"];
            currentRouletteItems = [...members, i18n[currentLang].all_pass];
            document.getElementById('roulette-view').classList.remove('hidden');
            document.getElementById('main-img').src = 'cafe_counter.png';
            updateText('spin_msg'); rouletteAngle = 0; drawRoulette();
        }

        function drawRoulette() {
            const canvas = document.getElementById('rouletteCanvas'); const ctx = canvas.getContext('2d');
            const cx = 200, cy = 200, r = 190;
            const weights = currentRouletteItems.map(item => item.includes('PASS') || item.includes('í†µê³¼') ? 0.2 : 1);
            const totalWeight = weights.reduce((a, b) => a + b, 0);
            ctx.clearRect(0, 0, 400, 400);
            let startAngle = rouletteAngle;
            for (let i = 0; i < currentRouletteItems.length; i++) {
                const sliceAngle = (weights[i] / totalWeight) * Math.PI * 2;
                ctx.beginPath(); 
                ctx.fillStyle = (currentRouletteItems[i].includes('PASS') || currentRouletteItems[i].includes('í†µê³¼')) ? "#000" : (i % 2 === 0 ? "#f8f8f8" : "#ebebeb");
                ctx.moveTo(cx, cy); ctx.arc(cx, cy, r, startAngle, startAngle + sliceAngle); ctx.fill();
                ctx.strokeStyle = "#333"; ctx.lineWidth = 2; ctx.stroke();
                ctx.save(); ctx.translate(cx, cy); ctx.rotate(startAngle + sliceAngle / 2); ctx.textAlign = "right";
                ctx.fillStyle = (currentRouletteItems[i].includes('PASS') || currentRouletteItems[i].includes('í†µê³¼')) ? "#f1c40f" : "#333";
                ctx.font = "bold 14px Montserrat"; ctx.fillText(currentRouletteItems[i], r - 30, 5); ctx.restore();
                startAngle += sliceAngle;
            }
            ctx.beginPath(); ctx.arc(cx, cy, 15, 0, Math.PI * 2); ctx.fillStyle = "#333"; ctx.fill();
        }

        function spinRoulette() {
            if (rouletteSpinning) return;
            rouletteSpinning = true; AudioEngine.play('whoosh');
            document.getElementById('roulette-spin-btn').disabled = true;
            const duration = 4500; const startTS = performance.now(); const startRot = rouletteAngle;
            const targetRot = startRot + (Math.random() * 5 + 5) * Math.PI * 2;
            function animate(now) {
                const elapsed = now - startTS; const progress = Math.min(elapsed / duration, 1);
                const easeOut = 1 - Math.pow(1 - progress, 4);
                rouletteAngle = startRot + (targetRot - startRot) * easeOut;
                drawRoulette();
                if (progress < 1) requestAnimationFrame(animate);
                else { rouletteSpinning = false; finishSpin(); }
            }
            requestAnimationFrame(animate);
        }

        function finishSpin() {
            const weights = currentRouletteItems.map(item => item.includes('PASS') || item.includes('í†µê³¼') ? 0.2 : 1);
            const totalWeight = weights.reduce((a, b) => a + b, 0);
            let normalizedAngle = (rouletteAngle % (Math.PI * 2)); if (normalizedAngle < 0) normalizedAngle += Math.PI * 2;
            const pinPos = (Math.PI * 1.5); let checkAngle = normalizedAngle, winnerIdx = 0;
            for (let i = 0; i < currentRouletteItems.length; i++) {
                const sliceAngle = (weights[i] / totalWeight) * Math.PI * 2;
                const start = checkAngle % (Math.PI * 2); const end = (checkAngle + sliceAngle) % (Math.PI * 2);
                if (end < start) { if (pinPos >= start || pinPos <= end) { winnerIdx = i; break; } }
                else { if (pinPos >= start && pinPos <= end) { winnerIdx = i; break; } }
                checkAngle += sliceAngle;
            }
            const winnerName = currentRouletteItems[winnerIdx];
            document.getElementById('roulette-spin-btn').classList.add('hidden');
            document.getElementById('roulette-again-btn').classList.remove('hidden');
            
            if (winnerName.includes('PASS') || winnerName.includes('í†µê³¼')) {
                AudioEngine.play('start'); updateText('all_pass_unbelievable');
                document.getElementById('main-img').src = 'cafe_counter_lucky.png';
                confetti({ particleCount: 200, spread: 100, origin: { y: 0.7 }, colors: ['#f1c40f', '#fff'] });
            } else {
                AudioEngine.play('fail'); updateText(`${winnerName}${i18n[currentLang].pay_msg}`, true);
                document.getElementById('main-img').src = 'cafe_counter_thanks.gif';
                if (recordStats) updateStats(winnerName); 
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.7 } });
                showFinish(currentRouletteItems.length - 1, winnerName, 'roulette-result-anchor');
            }
        }

        /* --- Cat Game --- */
        function goCatGame() {
            hideAllViews(); // ì—¬ê¸°ì„œ ë²„íŠ¼ ìƒíƒœê°€ ëª¨ë‘ ë¦¬ì…‹ë˜ê³  ê³ ì–‘ì´ ìœ„ì¹˜ê°€ ì´ˆê¸°í™”ë¨
            const saved = localStorage.getItem('lastCoffeeMembers');
            memberNames = saved ? JSON.parse(saved) : ["User 1", "User 2", "User 3"];
            document.getElementById('cat-view').classList.remove('hidden');
            document.getElementById('main-img').src = 'cafe_counter.png';
            updateText('cat_start');
            
            // ê³ ì–‘ì´ ìœ„ì¹˜ ë° ìƒíƒœ ì™„ì „ ì´ˆê¸°í™”
            const cat = document.getElementById('moving-cat');
            cat.src = 'cat_stand.png';
            cat.style.transition = 'none'; // ì´ˆê¸° ë°°ì¹˜ ì‹œ íŠ¸ëœì§€ì…˜ ë„ê¸°
            cat.style.left = '50%';
            cat.style.top = '15px';
            cat.style.transform = 'translateX(-50%)';
            cat.className = '';
            
            // í•œ í”„ë ˆì„ ë’¤ì— íŠ¸ëœì§€ì…˜ ë‹¤ì‹œ ì¼œê¸°
            setTimeout(() => {
                cat.style.transition = 'left 0.4s ease-in-out, top 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
            }, 50);
            
            renderCatBowls();
        }

        function renderCatBowls() {
            const container = document.getElementById('bowls-container'); container.innerHTML = '';
            const count = memberNames.length;
            const rows = Math.ceil(count / 6);
            
            const whiteBox = document.getElementById('cat-white-box');
            if(rows >= 2) {
                whiteBox.style.minHeight = "400px";
                container.style.paddingTop = "100px";
            } else {
                whiteBox.style.minHeight = "320px";
                container.style.paddingTop = "120px";
            }

            memberNames.forEach((name, i) => {
                const bowl = document.createElement('div'); bowl.className = 'cat-bowl';
                bowl.innerHTML = `<img src="cat_bowl_full.png" class="bowl-img" id="img-bowl-${i}"><div class="bowl-name">${name}</div>`;
                container.appendChild(bowl);
            });
        }

        function startCatGame() {
            if (catRunning) return; catRunning = true;
            document.getElementById('cat-start-btn').disabled = true;
            updateText('cat_msg'); AudioEngine.play('whoosh');
            const cat = document.getElementById('moving-cat');
            cat.src = 'cat_walk.gif'; cat.style.transform = 'none'; cat.classList.add('cat-moving');
            const winnerIdx = Math.floor(Math.random() * memberNames.length);
            const bowlEls = document.querySelectorAll('.cat-bowl');
            const gameArea = document.getElementById('cat-white-box');
            const parentRect = gameArea.getBoundingClientRect();
            let visits = 0; const maxVisits = 7 + Math.floor(Math.random() * 4);
            
            function moveCat() {
                if (visits < maxVisits) {
                    const target = bowlEls[Math.floor(Math.random() * memberNames.length)].getBoundingClientRect();
                    cat.style.left = (target.left - parentRect.left + (target.width / 2)) - (cat.offsetWidth / 2) + 'px';
                    cat.style.top = (15 + Math.random() * 40) + 'px';
                    visits++; setTimeout(moveCat, 450 + Math.random() * 200);
                } else {
                    const final = bowlEls[winnerIdx].getBoundingClientRect();
                    cat.style.left = (final.left - parentRect.left + (final.width / 2)) - (cat.offsetWidth / 2) + 'px';
                    cat.style.top = (final.top - parentRect.top - cat.offsetHeight + 18) + 'px';
                    setTimeout(() => {
                        cat.classList.remove('cat-moving'); cat.src = 'cat_eat.png';
                        bowlEls.forEach((b, idx) => {
                            if(idx !== winnerIdx) b.classList.add('bowl-dimmed');
                            else {
                                b.classList.add('bowl-highlight');
                                setTimeout(() => { document.getElementById(`img-bowl-${winnerIdx}`).src = 'cat_bowl_empty.png'; }, 500);
                            }
                        });
                        AudioEngine.play('fail');
                        updateText(`${memberNames[winnerIdx]}${i18n[currentLang].pay_msg}`, true);
                        document.getElementById('main-img').src = 'cafe_counter_thanks.gif';
                        if (recordStats) updateStats(memberNames[winnerIdx]); 
                        confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
                        showFinish(memberNames.length, memberNames[winnerIdx], 'cat-result-anchor');
                        document.getElementById('cat-start-btn').classList.add('hidden');
                        document.getElementById('cat-again-btn').classList.remove('hidden');
                        catRunning = false;
                    }, 600);
                }
            }
            moveCat();
        }

        /* --- Global Utilities --- */
        function showFinish(total, payerName, anchorId) {
            const now = new Date(); const randomPrice = (Math.random() * 5 + 3).toFixed(2);
            const t = i18n[currentLang];
            
            const prototype = document.getElementById('receipt-prototype-area').querySelector('.receipt-container').cloneNode(true);
            const receipt = prototype.querySelector('.receipt');
            
            receipt.querySelector('.receipt-date').innerText = now.toLocaleDateString();
            receipt.querySelector('.receipt-order-no').innerText = "NO." + Math.floor(1000 + Math.random() * 9000);
            receipt.querySelector('.receipt-qty').innerText = "x" + total;
            receipt.querySelector('.receipt-price').innerText = "$" + randomPrice;
            receipt.querySelector('.receipt-subtotal').innerText = "$" + (randomPrice * total).toFixed(2);
            receipt.querySelector('.receipt-payer').innerText = payerName;
            receipt.querySelector('.receipt-fortune').innerText = t.fortunes[Math.floor(Math.random() * t.fortunes.length)];
            receipt.querySelector('.receipt-menu').innerText = t.menus[Math.floor(Math.random() * t.menus.length)];
            
            receipt.querySelector('.txt-lbl-unit').innerText = t.lbl_unit_price;
            receipt.querySelector('.txt-lbl-sub').innerText = t.lbl_subtotal;
            receipt.querySelector('.txt-lbl-payer').innerText = t.lbl_selected;
            receipt.querySelector('.btn-capture-run').innerText = t.lbl_get_receipt;
            
            const anchor = document.getElementById(anchorId);
            anchor.innerHTML = ''; anchor.appendChild(prototype);
            
            setTimeout(() => { receipt.classList.add('show'); }, 100);
            receipt.querySelector('.btn-capture-run').onclick = function() { shareAsImage(receipt, this); };
        }

        async function shareAsImage(element, btn) {
            btn.innerText = "...";
            try {
                const canvas = await html2canvas(element, { backgroundColor: "#ffffff", scale: 3 });
                canvas.toBlob(async (blob) => {
                    const file = new File([blob], "receipt.png", { type: "image/png" });
                    if (navigator.share) await navigator.share({ files: [file] });
                    else { const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'receipt.png'; a.click(); }
                    btn.innerText = i18n[currentLang].lbl_get_receipt;
                });
            } catch (e) { btn.innerText = "ERROR"; }
        }

        function updateStats(name) {
            let stats = JSON.parse(localStorage.getItem('coffeeStats') || '{}');
            const monthKey = new Date().toISOString().slice(0, 7);
            if(!stats[name]) stats[name] = { total: 0, monthly: {} };
            stats[name].total += 1; stats[name].monthly[monthKey] = (stats[name].monthly[monthKey] || 0) + 1;
            localStorage.setItem('coffeeStats', JSON.stringify(stats));
        }

        function showStats() {
            const stats = JSON.parse(localStorage.getItem('coffeeStats') || '{}');
            const entries = Object.entries(stats).map(([n, d]) => [n, d.total]).sort((a, b) => b[1] - a[1]);
            const dash = document.getElementById('stats-dashboard');
            if (entries.length === 0) { if(dash) dash.classList.add('hidden'); return; }
            if(dash) dash.classList.remove('hidden');
            const list = document.getElementById('stats-list');
            if(list) list.innerHTML = entries.slice(0, 3).map(e => `<div class="stats-row"><span>${e[0]}</span><span>${e[1]} ${i18n[currentLang].lbl_times}</span></div>`).join('');
        }

        function renderHistoryPage() {
            const stats = JSON.parse(localStorage.getItem('coffeeStats') || '{}');
            const month = new Date().toISOString().slice(0, 7);
            const entries = Object.entries(stats).map(([n, d]) => ({ name: n, total: d.total, monthly: d.monthly[month] || 0 })).sort((a, b) => b.total - a.total);
            const kingArea = document.getElementById('monthly-king-area');
            const content = document.getElementById('history-list-content');
            if (entries.length === 0) { kingArea.innerHTML = ""; content.innerHTML = `<div style="text-align:center; padding:50px; color:#ccc;">NO DATA</div>`; return; }
            const king = [...entries].sort((a,b) => b.monthly - a.monthly)[0];
            if(king && king.monthly > 0) kingArea.innerHTML = `<div class="monthly-king-badge"><div class="king-crown">ğŸ‘‘</div><div class="king-info"><div class="king-tag">${i18n[currentLang].lbl_monthly_king}</div><div class="king-name">${king.name}</div></div><div class="king-count-area">${king.monthly}${i18n[currentLang].lbl_times}</div></div>`;
            content.innerHTML = entries.map(item => `<div class="history-item"><span>${item.name}</span><span style="color:var(--point-red)">${item.total}${i18n[currentLang].lbl_times}</span></div>`).join('');
        }

        function resetStats() { if(confirm("Clear all?")) { localStorage.removeItem('coffeeStats'); goFront(); } }
    </script>
</body>
</html>
