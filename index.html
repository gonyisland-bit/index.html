<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>lucky bean - v0.5.5 (Stable)</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Lucky Bean">
    <link rel="icon" type="image/png" href="coffeegame_icon.png">
    <link rel="apple-touch-icon" href="coffeegame_icon.png">

    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@1,300&family=Montserrat:wght@800&family=Courier+Prime&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-color: #ffffff;
            --primary-color: #000000;
            --text-gray-70: #4d4d4d;
            --rpg-border: #000000;
            --tablet-bg: #f8f8f8;
            --tablet-border: #eeeeee;
            --point-red: #ff4d4d;
            --divider-color: #ebebeb;
            --btn-shadow: #333333;
            --btn-light-shadow: #e0e0e0;
            --roulette-gold: #f1c40f;
        }

        html, body { height: 100%; margin: 0; padding: 0; touch-action: pan-x pan-y; -webkit-text-size-adjust: none; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color); color: var(--primary-color);
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            overflow-x: hidden; overflow-y: auto;
        }

        .wrapper { width: 100%; max-width: 600px; display: flex; flex-direction: column; align-items: center; text-align: center; padding-bottom: 40px; }

        header { padding: 30px 0 10px; cursor: pointer; width: 100%; display: flex; flex-direction: column; align-items: center; }
        .title-lucky { font-family: 'Playfair Display', serif; font-style: italic; font-weight: 300; font-size: 2.8rem; letter-spacing: -1px; }
        .title-bean { font-family: 'Montserrat', sans-serif; font-weight: 800; font-size: 3.1rem; letter-spacing: -2px; margin-left: -5px; }

        .game-screen {
            position: relative; width: 92%; max-width: 500px; margin: 10px auto 25px;
            border: 6px solid #000; line-height: 0; overflow: hidden; background: #eee; border-radius: 4px;
        }

        .title-image { width: 100%; height: auto; display: block; transition: none; }

        #rpg-textbox {
            position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%); width: 90%;
            background: rgba(255, 255, 255, 0.92); border: 3px solid var(--rpg-border);
            border-radius: 8px; padding: 12px 15px; box-sizing: border-box; line-height: 1.4; pointer-events: none; z-index: 10;
        }
        #rpg-content { font-size: 0.95rem; font-weight: 800; color: #000; min-height: 1.2rem; word-break: keep-all; white-space: pre-wrap; text-align: left; }

        .card-container {
            position: relative;
            width: 90%; max-width: 450px; background: var(--tablet-bg); border-radius: 30px;
            padding: 25px; box-sizing: border-box; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.01), 0 15px 35px rgba(0,0,0,0.03); margin: 0 auto 25px;
        }

        .order-menu-header { font-family: 'Montserrat', sans-serif; font-weight: 800; font-size: 0.8rem; color: #333; text-align: left; margin-bottom: 10px; letter-spacing: 1px; }

        /* ì„¤ì • ë²„íŠ¼ (ê²Œì„ ë‚´ ìƒë‹¨ ìš°ì¸¡) */
        .btn-mini-setup {
            position: absolute; top: 20px; right: 20px; font-size: 0.8rem; background: #fff; border: 1px solid #ddd;
            border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.05); z-index: 100;
        }

        .picker-group { width: 100%; display: flex; gap: 12px; margin-bottom: 20px; }
        .picker-btn {
            flex: 1; padding: 14px; border: 1px solid #eee; border-radius: 16px;
            background: white; font-weight: 700; font-size: 0.85rem; color: #333; cursor: pointer;
            display: flex; flex-direction: column; align-items: flex-start; transition: all 0.1s; position: relative;
            box-shadow: 0 4px 0 var(--btn-light-shadow);
        }
        .picker-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 var(--btn-light-shadow); }
        .picker-label { color: #bbb; font-size: 0.65rem; font-weight: 800; margin-bottom: 4px; letter-spacing: 0.5px; }
        .picker-value { display: flex; justify-content: space-between; width: 100%; align-items: center; }
        .picker-value::after { content: 'â–¾'; color: #ccc; font-size: 1rem; }

        .icon-selector-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; margin-top: 10px; }
        .icon-btn-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: transform 0.1s; }
        .icon-btn-item:active { transform: scale(0.95); }
        .icon-square {
            width: 100%; aspect-ratio: 1/1; border: 3px solid #000; border-radius: 15px;
            background: #fff; overflow: hidden; margin-bottom: 8px; box-shadow: 0 4px 0 #333;
            display: flex; align-items: center; justify-content: center;
        }
        .icon-square img { width: 80%; height: 80%; object-fit: contain; }
        .icon-label { font-size: 0.65rem; font-weight: 900; color: #000; letter-spacing: 0px; text-transform: uppercase; line-height: 1.2; height: 2.4em; display: flex; align-items: center; }

        .name-mgmt-bar { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 8px; }
        .btn-text { background: none; border: none; color: #bbb; font-size: 0.7rem; font-weight: 800; cursor: pointer; padding: 5px 10px; transition: 0.2s; letter-spacing: 1px; text-align: center; }

        .divider { width: 100%; height: 1px; background-color: var(--divider-color); margin-bottom: 20px; }

        #name-input-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; width: 100%; margin-bottom: 10px; }
        .name-input {
            padding: 14px 5px; border: 1px solid #eee; border-radius: 14px; font-size: 0.85rem;
            outline: none; text-align: center; width: 100%; box-sizing: border-box; background: white;
            transition: all 0.2s; font-weight: 600;
        }

        .stats-container { width: 100%; background: #fff; padding: 15px; border-radius: 20px; font-size: 0.8rem; box-sizing: border-box; border: 1px solid #eee; }
        .stats-title { font-weight: 800; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; color: #bbb; font-size: 0.7rem; letter-spacing: 1px; }
        
        /* ëœë¤ í•¸ë“œ ê²Œì„ ë‚´ë¶€ ìŠ¤íƒ€ì¼ ì ìš© */
        .hand-game-inner-card {
            background: #fff; border-radius: 20px; padding: 20px 10px; border: 1px solid #eee; min-height: 200px;
        }

        #hand-display { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; padding: 10px 0; width: 100%; position: relative; }
        .hand-wrapper { display: flex; flex-direction: column; align-items: center; flex: 0 0 calc(33.33% - 10px); min-width: 80px; transition: transform 0.4s ease; z-index: 1; }
        .hand-img { width: 100%; max-width: 100px; height: auto; aspect-ratio: 1/1; object-fit: contain; cursor: pointer; -webkit-tap-highlight-color: transparent; animation: floating 3s ease-in-out infinite; }

        @keyframes floating { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .tension-shake { animation: tension-animation 0.1s infinite !important; }
        @keyframes tension-animation { 0% { transform: translate(2px, 2px); } 50% { transform: translate(-2px, -2px); } 100% { transform: translate(2px, -2px); } }
        .shake { animation: winner-shake 0.15s infinite !important; }
        @keyframes winner-shake { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(4px); } }

        /* ê³ ì–‘ì´ ê²Œì„ ì• ë‹ˆë©”ì´ì…˜ ë° ë ˆì´ì–´ ì„¤ì • */
        @keyframes cat-walk { 0% { transform: translateX(-5px) rotate(-1deg); } 50% { transform: translateX(5px) rotate(1deg); } 100% { transform: translateX(-5px) rotate(-1deg); } }
        .cat-moving { animation: cat-walk 0.4s infinite; }
        
        .bowl-highlight { transform: scale(1.2); z-index: 10 !important; filter: drop-shadow(0 0 8px rgba(255,215,0,0.5)); }
        .bowl-dimmed { opacity: 0.2; filter: blur(2px); z-index: 1 !important; }

        .game-header-btns {
            display: flex; justify-content: center; align-items: center; gap: 12px;
            width: 100%; max-width: 450px; margin: 0 auto 10px; padding: 0 15px; box-sizing: border-box;
        }
        /* ì…”í”Œ ë²„íŠ¼ ë¹¨ê°„ìƒ‰ ìŠ¤íƒ€ì¼ ìš”ì²­ ë°˜ì˜ */
        .btn-shuffle-red {
            flex: 1; max-width: 160px; background-color: var(--point-red); color: #fff; border: 2px solid #000; padding: 12px 0; font-size: 0.9rem; font-weight: 900;
            border-radius: 50px; cursor: pointer; box-shadow: 0 5px 0 #333; transition: all 0.1s; letter-spacing: 1px; text-transform: uppercase;
        }
        .btn-shuffle-red:active:not(:disabled) { transform: translateY(3px); box-shadow: 0 2px 0 #333; }
        .btn-shuffle-red:disabled { opacity: 0.3; cursor: not-allowed; box-shadow: none; transform: translateY(3px); filter: grayscale(1); }

        .btn-pixel-game {
            flex: 1; max-width: 160px; background-color: #fff; color: #333; border: 2px solid #333; padding: 12px 0; font-size: 0.9rem; font-weight: 900;
            border-radius: 50px; cursor: pointer; box-shadow: 0 5px 0 #333; transition: all 0.1s; letter-spacing: 1px; text-transform: uppercase;
        }
        .btn-pixel-game:active:not(:disabled) { transform: translateY(3px); box-shadow: 0 2px 0 #333; }
        .btn-pixel-game:disabled { opacity: 0.3; cursor: not-allowed; box-shadow: none; transform: translateY(3px); filter: grayscale(1); }

        .member-name { font-size: 0.75rem; font-weight: 800; margin-top: 5px; color: #555; width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        .receipt {
            background: #fff; color: #333; width: 280px; padding: 35px 25px 25px; font-family: 'Courier Prime', monospace;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1); border-radius: 2px; position: relative; opacity: 0; margin: 0 auto;
        }
        .receipt::after {
            content: ""; position: absolute; bottom: 0; left: 0; width: 100%; height: 12px;
            background: linear-gradient(-45deg, transparent 6px, #fff 6px), linear-gradient(45deg, transparent 6px, #fff 6px);
            background-size: 12px 24px; transform: translateY(50%);
        }
        .receipt.show { animation: slideUpReceipt 0.6s forwards; }
        @keyframes slideUpReceipt { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .receipt-header { font-size: 1.4rem; font-weight: 800; margin-bottom: 5px; letter-spacing: 2px; text-align: center; }
        .receipt-subheader { font-size: 0.75rem; margin-bottom: 20px; text-align: center; color: #666; }
        .receipt-line { border-top: 1px dashed #bbb; margin: 12px 0; width: 100%; }
        .receipt-item { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.85rem; width: 100%; }
        .receipt-total { display: flex; flex-direction: column; align-items: center; margin: 20px 0; padding: 10px 0; border-top: 2px solid #333; border-bottom: 2px solid #333; }
        .label-customer { font-size: 0.7rem; font-weight: 700; color: #888; margin-bottom: 5px; }
        .value-customer { font-size: 2rem; font-weight: 900; color: var(--point-red); letter-spacing: -1px; }
        .fortune-area { font-size: 0.75rem; line-height: 1.5; color: #555; text-align: center; margin-top: 15px; word-break: keep-all; }

        .btn-main {
            padding: 20px 10px; font-size: 1.1rem; font-weight: 800; background: var(--primary-color); color: white; border: none; border-radius: 20px;
            cursor: pointer; width: 85%; max-width: 320px; transition: all 0.1s;
            box-shadow: 0 8px 0 var(--btn-shadow); text-transform: uppercase;
            position: relative; top: 0; margin-bottom: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .btn-main:active:not(:disabled) { top: 4px; box-shadow: 0 4px 0 var(--btn-shadow); transform: scale(0.98); }
        .btn-main:disabled { opacity: 0.4; cursor: not-allowed; box-shadow: none; top: 4px; }

        .btn-sub {
            padding: 16px; font-size: 0.9rem; font-weight: 800; background: #fff; color: #000; border: 2px solid #000; border-radius: 20px;
            cursor: pointer; width: 85%; max-width: 320px; transition: all 0.1s;
            box-shadow: 0 6px 0 var(--btn-shadow); text-transform: uppercase; margin-bottom: 12px;
        }
        .btn-sub:active:not(:disabled) { transform: translateY(3px); box-shadow: 0 3px 0 var(--btn-shadow); }
        .btn-sub:disabled { opacity: 0.4; cursor: not-allowed; filter: grayscale(1); }

        .btn-spin {
            padding: 18px; font-size: 1.2rem; font-weight: 900; background: #e74c3c; color: white; border: 3px solid #000; border-radius: 50px;
            cursor: pointer; width: 80%; max-width: 280px; transition: all 0.1s;
            box-shadow: 0 6px 0 #333; text-transform: uppercase; margin: 20px auto;
        }
        .btn-spin:active:not(:disabled) { transform: translateY(4px); box-shadow: 0 2px 0 #333; }
        .btn-spin:disabled { opacity: 0.4; cursor: not-allowed; box-shadow: none; transform: translateY(4px); }

        .footer { width: 100%; text-align: center; padding: 40px 0; font-size: 0.75rem; color: #ccc; letter-spacing: 1px; }
        .hidden { display: none !important; }

        #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: none; align-items: flex-end; justify-content: center; backdrop-filter: blur(4px); }
        .modal-content { background: white; width: 100%; max-width: 500px; border-radius: 30px 30px 0 0; padding: 30px 25px; box-sizing: border-box; animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.6s ease-out; }
        .loading-text { font-family: 'Courier Prime', monospace; font-size: 0.8rem; letter-spacing: 3px; margin-top: 20px; color: #333; }
        .loading-bar-container { width: 150px; height: 4px; background: #eee; border-radius: 10px; margin-top: 10px; overflow: hidden; }
        .loading-bar-fill { height: 100%; width: 0%; background: #000; transition: width 0.1s; }

        .about-text { font-size: 0.85rem; color: #666; line-height: 1.6; text-align: left; word-break: keep-all; }
        .about-label { font-weight: 800; color: #000; margin-top: 15px; display: block; }

        .monthly-king-badge {
            background: #fff8e1; border: 1.5px solid #ffca28; border-radius: 15px;
            padding: 10px 15px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;
            flex-wrap: nowrap; overflow: hidden;
        }
        .king-crown { font-size: 1.4rem; flex-shrink: 0; }
        .king-info { text-align: left; flex: 1; min-width: 0; }
        .king-name { font-weight: 900; font-size: 1rem; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .king-tag { font-size: 0.65rem; font-weight: 800; color: #ffca28; letter-spacing: 1px; white-space: nowrap; }
        .king-count-area { margin-left: auto; font-weight: 800; color: #ffca28; white-space: nowrap; flex-shrink: 0; }

        #roulette-container { position: relative; width: 100%; max-width: 320px; margin: 20px auto; }
        .roulette-pin {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            width: 30px; height: 40px; z-index: 20; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .lang-toggle-container { display: flex; justify-content: flex-end; width: 100%; margin-bottom: 15px; }
        .lang-btn { background: #eee; border: none; padding: 6px 12px; font-size: 0.7rem; font-weight: 800; border-radius: 8px; cursor: pointer; color: #999; transition: 0.2s; }
        .lang-btn.active { background: #000; color: #fff; }

        /* ê³ ì–‘ì´ ê²Œì„ ìŠ¤íƒ€ì¼ë§: 6ê°œ í•œ ì¤„ ë ˆì´ì–´ ì¡°ì • */
        #cat-game-area { width: 100%; height: 320px; position: relative; margin: 15px 0; overflow: hidden; background: #fff; border: 2px solid #eee; border-radius: 20px; }
        .cat-bowl { position: absolute; bottom: 25px; width: 50px; text-align: center; transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .bowl-img { width: 38px; height: auto; display: block; margin: 0 auto; transition: transform 0.3s; }
        .bowl-name { font-size: 0.6rem; font-weight: 800; color: #888; margin-top: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        #moving-cat { 
            position: absolute; width: 85px; height: auto; z-index: 15; 
            transition: left 0.4s ease-in-out, top 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
    </style>
</head>
<body>

    <div id="splash-screen">
        <img src="coffee.png" alt="Logo" id="splash-logo" style="width:110px;">
        <div id="loading-progress-area">
            <div class="loading-text">LOADING...</div>
            <div class="loading-bar-container"><div id="progress-fill" class="loading-bar-fill"></div></div>
        </div>
        <div id="start-action-area" style="display:none; flex-direction:column; align-items:center; margin-top:20px; width: 100%;">
            <button class="btn-main" id="btn-start" onclick="handleStartGame()">START GAME</button>
            <div id="start-hint" style="font-size:0.7rem; color:#bbb; margin-top:8px; letter-spacing:1px; font-weight:800;">TAP TO BREW LUCK</div>
        </div>
    </div>

    <audio id="bgm-player" loop preload="auto">
        <source src="cafe_music_bgm.mp3" type="audio/mpeg">
    </audio>

    <div id="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-title" id="modal-title" style="font-weight:800; font-size:1.2rem; margin-bottom:20px;">Select</div>
            <div id="modal-list-container"></div>
            <button class="btn-text" id="modal-close-btn" style="width:100%; padding:20px; color:#999;" onclick="closeModal()">CLOSE</button>
        </div>
    </div>

    <div class="wrapper">
        <header onclick="goFront()">
            <div class="title-container">
                <span class="title-lucky">lucky</span><span class="title-bean">bean</span>
            </div>
        </header>

        <main id="main-content">
            <div class="game-screen">
                <img src="cafe_facade.png" alt="Cafe" id="main-img" class="title-image">
                <div id="rpg-textbox"><div id="rpg-content"></div></div>
            </div>

            <div id="front-view">
                <div class="card-container">
                    <div id="stats-dashboard" class="stats-container hidden">
                        <div class="stats-title"><span id="txt-donation-kings">ğŸ† DONATION KINGS</span> <button id="btn-reset-small" style="font-size:0.65rem; color:#aaa; border:none; background:none; cursor:pointer;" onclick="resetStats()">RESET</button></div>
                        <div id="stats-list"></div>
                    </div>
                    <div id="no-stats-msg" style="font-size: 0.8rem; color: #ccc; font-weight: 700;">WELCOME TO THE CAFE!</div>
                </div>
                <div style="display: flex; flex-direction: column; align-items: center; width: 100%;">
                    <button class="btn-main" id="btn-enter-shop" onclick="showGameSelector()">ENTER SHOP</button>
                    <button class="btn-sub" id="btn-go-setup" onclick="goSetup()">SETTINGS</button>
                    <button class="btn-sub" id="btn-go-history" onclick="goHistory()">HISTORY</button>
                    <button class="btn-sub" id="btn-go-about" onclick="goAbout()">ABOUT</button>
                </div>
            </div>

            <div id="selector-view" class="hidden">
                <div class="card-container">
                    <div class="order-menu-header" id="txt-choose-luck" style="text-align: center; margin-bottom: 25px;">CHOOSE YOUR LUCK</div>
                    <div class="icon-selector-grid">
                        <div class="icon-btn-item" onclick="startGame()">
                            <div class="icon-square"><img src="random_hand.png" alt="Hand"></div>
                            <div class="icon-label" id="txt-game-hand">Random Hand</div>
                        </div>
                        <div class="icon-btn-item" onclick="goRoulette()">
                            <div class="icon-square"><img src="lucky_roulette.png" alt="Roulette"></div>
                            <div class="icon-label" id="txt-game-roulette">Lucky Roulette</div>
                        </div>
                        <div class="icon-btn-item" onclick="goCatGame()">
                            <div class="icon-square"><img src="cat_icon.png" alt="Cat" style="width:70%;"></div>
                            <div class="icon-label" id="txt-game-cat">Cat's Choice</div>
                        </div>
                    </div>
                </div>
                <button class="btn-main" id="btn-back-menu-selector" onclick="goFront()" style="background:#eee; color:#999; box-shadow:0 8px 0 #ddd;">BACK TO MENU</button>
            </div>

            <div id="setup-view" class="hidden">
                <div class="card-container">
                    <div class="lang-toggle-container">
                        <button id="lang-ko" class="lang-btn" onclick="setLanguage('ko')">KO</button>
                        <button id="lang-en" class="lang-btn" onclick="setLanguage('en')" style="margin-left:5px;">EN</button>
                    </div>
                    <div class="order-menu-header" id="txt-setting-title">ğŸ“‹ <b>ORDER MENU SETTING</b></div>
                    <div class="divider" style="margin-bottom: 15px;"></div>
                    <div class="picker-group">
                        <div class="picker-btn" onclick="openGroupModal()">
                            <span class="picker-label" id="lbl-group">GROUP</span>
                            <div class="picker-value"><span id="display-group-name">Empty</span></div>
                        </div>
                        <div class="picker-btn" onclick="openMemberModal()">
                            <span class="picker-label" id="lbl-members">MEMBERS</span>
                            <div class="picker-value"><span id="display-member-count">3 Members</span></div>
                        </div>
                    </div>
                    <div class="name-mgmt-bar">
                        <button class="btn-text" id="btn-random" onclick="fillRandomNames()">RANDOM</button>
                        <button class="btn-text" id="btn-clear" onclick="clearNames()">CLEAR</button>
                        <button class="btn-text" id="btn-save-team" onclick="saveCurrentTeam()" style="color:#888;">SAVE</button>
                    </div>
                    <div class="divider"></div>
                    <div id="name-input-container"></div>
                </div>
                <div style="display: flex; flex-direction: column; align-items: center; width: 100%;">
                    <button class="btn-main" id="btn-save-exit" onclick="saveAndGoHome()">SAVE & EXIT</button>
                    <button class="btn-sub" id="btn-back-home" onclick="goBackFromSetup()" style="background:#fff; color:#bbb; border:2px solid #eee; box-shadow:0 6px 0 #f8f8f8;">BACK</button>
                </div>
            </div>

            <div id="game-view" class="hidden">
                <div class="card-container">
                    <div class="btn-mini-setup" onclick="goSetupFromGame('hand')">âš™ï¸</div>
                    <div class="order-menu-header" id="txt-hand-game-title">âœ‹ <b>RANDOM HAND</b></div>
                    <div class="divider"></div>
                    <div class="hand-game-inner-card">
                        <div id="hand-display"></div>
                    </div>
                    <div style="margin-top:20px;">
                        <button class="btn-shuffle-red" id="btn-shuffle" onclick="shufflePositions()">SHUFFLE</button>
                        <button class="btn-pixel-game hidden" id="btn-again-hand" onclick="startGame()">AGAIN</button>
                    </div>
                </div>
                <div id="game-btn-group" style="display:flex; flex-direction:column; align-items:center; gap:8px; width:100%;">
                    <div id="lucky-area" class="hidden" style="margin-bottom:20px; font-weight:900; color:#f1c40f; font-size:1.2rem; text-shadow: 1px 1px 0px #000;">ğŸŒŸ EXTRA LUCK! ALL PASS! ğŸŒŸ</div>
                    <button class="btn-main" id="btn-back-selector-hand" onclick="showGameSelector()">CHANGE GAME</button>
                    <button class="btn-sub" id="btn-back-menu-hand" onclick="goFront()" style="color:#bbb; border-color:#eee; box-shadow:0 6px 0 #f8f8f8;">BACK TO MENU</button>
                </div>
            </div>

            <div id="roulette-view" class="hidden">
                <div class="card-container" style="text-align:center;">
                    <div class="btn-mini-setup" onclick="goSetupFromGame('roulette')">âš™ï¸</div>
                    <div class="order-menu-header" id="txt-roulette-title">ğŸ¡ <b>LUCKY ROULETTE</b></div>
                    <div class="divider"></div>
                    <div id="roulette-container">
                        <svg class="roulette-pin" viewBox="0 0 30 40">
                            <path d="M15 0 L30 20 L15 40 L0 20 Z" fill="#e74c3c" stroke="#000" stroke-width="2"/>
                        </svg>
                        <canvas id="rouletteCanvas" width="400" height="400" style="width:100%; max-width:320px; border-radius:50%; border:6px solid #333;"></canvas>
                    </div>
                    <button id="roulette-spin-btn" class="btn-spin" onclick="spinRoulette()">SPIN</button>
                </div>
                <div id="roulette-action-area" style="display:flex; flex-direction:column; align-items:center; width:100%; gap:8px;">
                     <button class="btn-main" id="btn-back-selector-roulette" onclick="showGameSelector()">CHANGE GAME</button>
                     <button class="btn-sub" id="btn-back-menu-roulette" onclick="goFront()" style="color:#bbb; border-color:#eee; box-shadow:0 6px 0 #f8f8f8;">BACK TO MENU</button>
                </div>
            </div>

            <div id="cat-view" class="hidden">
                <div class="card-container" style="text-align:center;">
                    <div class="btn-mini-setup" onclick="goSetupFromGame('cat')">âš™ï¸</div>
                    <div class="order-menu-header" id="txt-cat-title">ğŸˆ <b>CAT'S CHOICE</b></div>
                    <div class="divider"></div>
                    <div id="cat-game-area">
                        <img src="cat_stand.png" id="moving-cat" alt="Cat" style="left: 50%; top: 12%; transform: translateX(-50%);">
                        <div id="bowls-container"></div>
                    </div>
                    <button id="cat-start-btn" class="btn-spin" onclick="startCatGame()">START</button>
                </div>
                <div id="cat-action-area" style="display:flex; flex-direction:column; align-items:center; width:100%; gap:8px;">
                    <button class="btn-main" id="btn-back-selector-cat" onclick="showGameSelector()">CHANGE GAME</button>
                    <button class="btn-sub" id="btn-back-menu-cat" onclick="goFront()" style="color:#bbb; border-color:#eee; box-shadow:0 6px 0 #f8f8f8;">BACK TO MENU</button>
                </div>
            </div>

            <div id="result-shared-root" class="hidden">
                <div id="capture-area" style="padding: 15px 0; background: transparent; width:100%;">
                    <div class="receipt" id="receipt">
                        <div class="receipt-header">RECEIPT</div>
                        <div class="receipt-subheader">LUCKY BEAN SHOP</div>
                        <div class="receipt-item"><span id="receipt-date"></span><span id="receipt-order-no"></span></div>
                        <div class="receipt-line"></div>
                        <div class="receipt-item"><span id="receipt-menu"></span><span id="receipt-qty"></span></div>
                        <div class="receipt-item"><span id="txt-unit-price">UNIT PRICE</span><span id="receipt-price"></span></div>
                        <div class="receipt-line"></div>
                        <div class="receipt-item" style="font-weight:800;"><span id="txt-subtotal">SUBTOTAL</span><span id="receipt-subtotal"></span></div>
                        <div class="receipt-total">
                            <span class="label-customer" id="txt-selected-customer">SELECTED CUSTOMER</span>
                            <span id="receipt-payer" class="value-customer"></span>
                        </div>
                        <div class="receipt-line"></div>
                        <div class="fortune-area" id="receipt-fortune"></div>
                        <button class="btn-text" id="id-share-btn" onclick="shareAsImage()" style="width:100%; margin-top: 15px; border:1px solid #eee; border-radius:10px; padding:8px; font-size:0.6rem;">GET A RECEIPT</button>
                    </div>
                </div>
            </div>

            <div id="about-view" class="hidden">
                <div class="card-container" style="text-align: left;">
                    <div class="order-menu-header" id="txt-about-title">â˜• <b>ABOUT LUCKY BEAN</b></div>
                    <div class="divider"></div>
                    <div class="about-text" id="txt-about-content"></div>
                </div>
                <button class="btn-main" id="btn-back-home-about" onclick="goFront()">BACK TO HOME</button>
            </div>

            <div id="history-view" class="hidden">
                <div class="card-container" style="text-align: left;">
                    <div class="order-menu-header" id="txt-history-title">ğŸ† <b>DONATION HISTORY</b></div>
                    <div class="divider"></div>
                    <div id="monthly-king-area"></div>
                    <div id="history-list-content" class="about-text"></div>
                    <button class="btn-text" id="btn-reset-all" onclick="resetStats()" style="width:100%; margin-top:15px; color:var(--point-red);">RESET ALL DATA</button>
                </div>
                <button class="btn-main" id="btn-back-home-history" onclick="goFront()">BACK TO HOME</button>
            </div>
        </main>
        <div class="footer">v0.5.5 | â“’ 2026. Gonystudio. All rights reserved.</div>
    </div>

    <script>
        const i18n = {
            en: {
                welcome: "Welcome to the Lucky Bean!",
                choose_luck: "Choose your luckiest game!",
                setting_msg: "Settings: Manage your team.",
                how_to: "How to play and track donations.",
                history_msg: "Who donated the most coffee?",
                pick_hand: "Who will pay? Pick a hand!",
                hands_mixed: "Hands Mixed!",
                safe_msg: " is Safe!",
                pay_msg: " will pay!",
                lucky_round: "LUCKY! Everyone is SAFE! ğŸŒŸ",
                spin_msg: "Spin the wheel for luck!",
                cat_msg: "Wait for the cat's choice...",
                cat_start: "Who will the cat visit?",
                all_pass: "ğŸŒŸ ALL PASS ğŸŒŸ",
                all_pass_unbelievable: "ğŸŒŸ UNBELIEVABLE! ALL PASS! ğŸŒŸ",
                btn_start: "START GAME",
                btn_enter_shop: "ENTER SHOP",
                btn_setup: "SETTINGS",
                btn_history: "HISTORY",
                btn_about: "ABOUT",
                btn_back_menu: "BACK TO MENU",
                btn_back_home: "BACK TO HOME",
                btn_save_exit: "SAVE & EXIT",
                btn_shuffle: "SHUFFLE",
                btn_again: "AGAIN",
                btn_spin: "SPIN",
                btn_change_game: "CHANGE GAME",
                lbl_group: "GROUP",
                lbl_members: "MEMBERS",
                lbl_random: "RANDOM",
                lbl_clear: "CLEAR",
                lbl_save: "SAVE",
                lbl_kings: "ğŸ† DONATION KINGS",
                lbl_unit_price: "UNIT PRICE",
                lbl_subtotal: "SUBTOTAL",
                lbl_selected: "SELECTED CUSTOMER",
                lbl_get_receipt: "GET A RECEIPT",
                lbl_monthly_king: "MONTHLY KING",
                lbl_times: "times",
                lbl_empty: "Empty",
                lbl_member_count: "Members",
                txt_about_content: `<span class="about-label">HOW TO PLAY</span> 1. Enter names in SETTINGS.<br> 2. Go to ENTER SHOP and pick a game.<br> 3. Pick a hand, spin the wheel, or wait for the cat.<br> 4. The one chosen pays!<br> <span class="about-label">HISTORY & RANKING</span> - Every win is recorded in HISTORY.<br> - Check the 'DONATION KINGS' to see who paid the most.`,
                fortunes: ["Great luck will come to you!", "Kindness returns to you.", "Small loss, big luck later!", "Your team respects you!", "Tip: Choose the next payer!"],
                menus: ["Americano", "Cafe Latte", "Vanilla Latte", "Flat White", "Cold Brew", "Einspanner", "Dolce Latte", "Caramel Macchiato"]
            },
            ko: {
                welcome: "ëŸ­í‚¤ë¹ˆì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!",
                choose_luck: "ê°€ì¥ ìš´ ì¢‹ì€ ê²Œì„ì„ ê³¨ë¼ë³´ì„¸ìš”!",
                setting_msg: "ì„¤ì •: íŒ€ ë©¤ë²„ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”.",
                how_to: "ê²Œì„ ë°©ë²• ë° íˆìŠ¤í† ë¦¬ ì•ˆë‚´",
                history_msg: "ëˆ„ê°€ ê°€ì¥ ì»¤í”¼ë¥¼ ë§ì´ ìƒ€ì„ê¹Œìš”?",
                pick_hand: "ëˆ„ê°€ ë‚¼ê¹Œìš”? ì†ì„ ê³¨ë¼ë³´ì„¸ìš”!",
                hands_mixed: "ì†ì´ ì„ì˜€ìŠµë‹ˆë‹¤!",
                safe_msg: "ë‹˜ì€ ìƒì¡´!",
                pay_msg: "ë‹˜ì´ ë‹¹ì²¨ë˜ì—ˆìŠµë‹ˆë‹¤!",
                lucky_round: "ëŸ­í‚¤! ëª¨ë‘ ìƒì¡´í–ˆìŠµë‹ˆë‹¤! ğŸŒŸ",
                spin_msg: "ë£°ë ›ì„ ëŒë ¤ ìš´ì„ ì‹œí—˜í•˜ì„¸ìš”!",
                cat_msg: "ê³ ì–‘ì´ê°€ ê³ ë¯¼ ì¤‘ì…ë‹ˆë‹¤...",
                cat_start: "ê³ ì–‘ì´ëŠ” ëˆ„êµ¬ì—ê²Œ ê°ˆê¹Œìš”?",
                all_pass: "ğŸŒŸ ì „ì› í†µê³¼ ğŸŒŸ",
                all_pass_unbelievable: "ğŸŒŸ ëŒ€ë°•! ì „ì› í†µê³¼ì…ë‹ˆë‹¤! ğŸŒŸ",
                btn_start: "ê²Œì„ ì‹œì‘",
                btn_enter_shop: "ì…ì¥í•˜ê¸°",
                btn_setup: "ì„¤ì •",
                btn_history: "íˆìŠ¤í† ë¦¬",
                btn_about: "ì •ë³´",
                btn_back_menu: "ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°",
                btn_back_home: "í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°",
                btn_save_exit: "ì €ì¥ ë° ë‚˜ê°€ê¸°",
                btn_shuffle: "ì„ê¸°",
                btn_again: "ë‹¤ì‹œí•˜ê¸°",
                btn_spin: "ëŒë¦¬ê¸°",
                btn_change_game: "ê²Œì„ ë³€ê²½",
                lbl_group: "ê·¸ë£¹",
                lbl_members: "ì¸ì›",
                lbl_random: "ëœë¤",
                lbl_clear: "ì´ˆê¸°í™”",
                lbl_save: "ì €ì¥",
                lbl_kings: "ğŸ† ì˜¤ëŠ˜ì˜ ê¸°ë¶€ì™•",
                lbl_unit_price: "ë‹¨ê°€",
                lbl_subtotal: "í•©ê³„",
                lbl_selected: "ë‹¹ì²¨ì",
                lbl_get_receipt: "ì˜ìˆ˜ì¦ ë°›ê¸°",
                lbl_monthly_king: "ì´ë‹¬ì˜ ê¸°ë¶€ì™•",
                lbl_times: "íšŒ",
                lbl_empty: "ì—†ìŒ",
                lbl_member_count: "ëª…",
                txt_about_content: `<span class="about-label">ê²Œì„ ë°©ë²•</span> 1. ì„¤ì •ì—ì„œ íŒ€ ë©¤ë²„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.<br> 2. ENTER SHOPì—ì„œ ê²Œì„ì„ ì„ íƒí•©ë‹ˆë‹¤.<br> 3. ì†ì„ ê³ ë¥´ê±°ë‚˜ ë£°ë ›ì„ ëŒë ¤ë³´ì„¸ìš”.<br> 4. ê³ ì–‘ì´ì˜ ì„ íƒì„ ê¸°ë‹¤ë ¤ë„ ì¢‹ìŠµë‹ˆë‹¤!<br> <span class="about-label">ê¸°ë¡ ë° ë­í‚¹</span> - ëª¨ë“  ê²°ê³¼ëŠ” íˆìŠ¤í† ë¦¬ì— ê¸°ë¡ë©ë‹ˆë‹¤.<br> - ê¸°ë¶€ì™• ë­í‚¹ì—ì„œ ëˆ„ê°€ ê°€ì¥ ë§ì´ ìƒ€ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.`,
                fortunes: ["ì˜¤ëŠ˜ì€ ì¢‹ì€ ì¼ì´ ìƒê¸¸ ê±°ì˜ˆìš”!", "ë°°ë ¤ê°€ í–‰ìš´ìœ¼ë¡œ ëŒì•„ì˜µë‹ˆë‹¤.", "ì‘ì€ ì§€ì¶œì´ í° í–‰ìš´ì´ ë˜ì–´!", "íŒ€ì›ë“¤ì´ ë‹¹ì‹ ì˜ ë°°ë ¤ë¥¼ ê¸°ì–µí•´ìš”!", "íŒ: ë‹¤ìŒ ê²Œì„ ë‹¹ì²¨ìë¥¼ ì§€ëª©í•´ë³´ì„¸ìš”!"],
                menus: ["ì•„ë©”ë¦¬ì¹´ë…¸", "ì¹´í˜ë¼ë–¼", "ë°”ë‹ë¼ë¼ë–¼", "í”Œë«í™”ì´íŠ¸", "ì½œë“œë¸Œë£¨", "ì•„ì¸ìŠˆí˜ë„ˆ", "ëŒì²´ë¼ë–¼", "ì¹´ë¼ë©œ ë§ˆí‚¤ì•„ë˜"]
            }
        };

        const randomNames = ["Emma", "Noah", "Olivia", "Liam", "Ava", "Lucas", "Mia", "Ethan", "Luna", "Oliver", "ì² ìˆ˜", "ì˜í¬", "ê¸¸ë™", "ìˆ˜ì§€", "ë¯¼ìˆ˜", "ì§€í˜œ", "í˜„ìš°", "ë‚˜ë¦¬", "ì¤€ì„œ", "ë¯¸ë‚˜"];
        const presetGroups = [
            { name: "Coffee Friends", members: ["Emma", "Noah", "Olivia"] },
            { name: "Tech Team", members: ["Liam", "Lucas", "Ethan", "Mia"] },
            { name: "Office Mates", members: ["ì² ìˆ˜", "ì˜í¬", "ë¯¼ìˆ˜", "ì§€í˜œ", "ë‚˜ë¦¬"] }
        ];

        let currentLang = localStorage.getItem('luckyBeanLang') || 'ko';
        let members = JSON.parse(localStorage.getItem('luckyBeanMembers')) || ["Member 1", "Member 2", "Member 3"];
        let groupName = localStorage.getItem('luckyBeanGroup') || "My Team";
        let history = JSON.parse(localStorage.getItem('coffeeStats')) || [];
        let previousView = 'front-view';

        const mainImg = document.getElementById('main-img');
        const rpgContent = document.getElementById('rpg-content');

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('luckyBeanLang', lang);
            updateUI();
        }

        function updateUI() {
            const t = i18n[currentLang];
            document.getElementById('lang-ko').className = currentLang === 'ko' ? 'lang-btn active' : 'lang-btn';
            document.getElementById('lang-en').className = currentLang === 'en' ? 'lang-btn active' : 'lang-btn';

            document.getElementById('btn-start').innerText = t.btn_start;
            document.getElementById('btn-enter-shop').innerText = t.btn_enter_shop;
            document.getElementById('btn-go-setup').innerText = t.btn_setup;
            document.getElementById('btn-go-history').innerText = t.btn_history;
            document.getElementById('btn-go-about').innerText = t.btn_about;

            document.getElementById('txt-choose-luck').innerText = t.choose_luck;
            document.getElementById('btn-back-menu-selector').innerText = t.btn_back_menu;
            
            document.getElementById('txt-setting-title').innerHTML = `ğŸ“‹ <b>${currentLang === 'ko' ? 'ì£¼ë¬¸ ë©”ë‰´ ì„¤ì •' : 'ORDER MENU SETTING'}</b>`;
            document.getElementById('lbl-group').innerText = t.lbl_group;
            document.getElementById('lbl-members').innerText = t.lbl_members;
            document.getElementById('btn-random').innerText = t.lbl_random;
            document.getElementById('btn-clear').innerText = t.lbl_clear;
            document.getElementById('btn-save-team').innerText = t.lbl_save;
            document.getElementById('btn-save-exit').innerText = t.btn_save_exit;
            document.getElementById('btn-back-home').innerText = currentLang === 'ko' ? 'ë’¤ë¡œ' : 'BACK';

            document.getElementById('btn-shuffle').innerText = t.btn_shuffle;
            document.getElementById('btn-again-hand').innerText = t.btn_again;
            document.getElementById('btn-back-selector-hand').innerText = t.btn_change_game;
            document.getElementById('btn-back-menu-hand').innerText = t.btn_back_menu;

            document.getElementById('txt-roulette-title').innerHTML = `ğŸ¡ <b>${currentLang === 'ko' ? 'í–‰ìš´ì˜ ë£°ë ›' : 'LUCKY ROULETTE'}</b>`;
            document.getElementById('roulette-spin-btn').innerText = t.btn_spin;
            document.getElementById('btn-back-selector-roulette').innerText = t.btn_change_game;
            document.getElementById('btn-back-menu-roulette').innerText = t.btn_back_menu;

            document.getElementById('txt-cat-title').innerHTML = `ğŸˆ <b>${currentLang === 'ko' ? 'ê³ ì–‘ì´ì˜ ì„ íƒ' : "CAT'S CHOICE"}</b>`;
            document.getElementById('cat-start-btn').innerText = currentLang === 'ko' ? 'ì‹œì‘' : 'START';
            document.getElementById('btn-back-selector-cat').innerText = t.btn_change_game;
            document.getElementById('btn-back-menu-cat').innerText = t.btn_back_menu;

            document.getElementById('txt-about-title').innerHTML = `â˜• <b>ABOUT LUCKY BEAN</b>`;
            document.getElementById('txt-about-content').innerHTML = t.txt_about_content;
            document.getElementById('btn-back-home-about').innerText = t.btn_back_home;

            document.getElementById('txt-history-title').innerHTML = `ğŸ† <b>${currentLang === 'ko' ? 'ê¸°ë¶€ íˆìŠ¤í† ë¦¬' : 'DONATION HISTORY'}</b>`;
            document.getElementById('btn-back-home-history').innerText = t.btn_back_home;
            document.getElementById('btn-reset-all').innerText = currentLang === 'ko' ? 'ë°ì´í„° ì´ˆê¸°í™”' : 'RESET ALL DATA';

            document.getElementById('txt-donation-kings').innerText = t.lbl_kings;
            document.getElementById('btn-reset-small').innerText = currentLang === 'ko' ? 'ì´ˆê¸°í™”' : 'RESET';

            document.getElementById('display-group-name').innerText = groupName || t.lbl_empty;
            document.getElementById('display-member-count').innerText = `${members.length} ${t.lbl_member_count}`;

            if(previousView === 'front-view') updateRPG(t.welcome);
            renderStats();
            renderInputGrid();
        }

        function updateRPG(msg) { rpgContent.innerText = msg; }

        function showView(viewId) {
            const views = ['front-view', 'selector-view', 'setup-view', 'game-view', 'roulette-view', 'cat-view', 'about-view', 'history-view'];
            views.forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            if(viewId !== 'setup-view') previousView = viewId;
            
            if(viewId === 'front-view') mainImg.src = 'cafe_facade.png';
            else if(viewId === 'selector-view') mainImg.src = 'cafe_inside.png';
            else if(viewId === 'game-view') mainImg.src = 'cafe_table.png';
            else if(viewId === 'roulette-view') mainImg.src = 'cafe_table.png';
            else if(viewId === 'cat-view') mainImg.src = 'cafe_garden.png';
        }

        function goFront() { 
            document.getElementById('result-shared-root').classList.add('hidden');
            showView('front-view'); 
            updateRPG(i18n[currentLang].welcome);
        }
        function showGameSelector() { 
            document.getElementById('result-shared-root').classList.add('hidden');
            showView('selector-view'); 
            updateRPG(i18n[currentLang].choose_luck);
        }
        function goAbout() { showView('about-view'); }
        function goHistory() { showView('history-view'); renderHistoryList(); }
        function goSetup() { 
            showView('setup-view'); 
            renderInputGrid();
            updateRPG(i18n[currentLang].setting_msg);
        }
        
        // ê²Œì„ë‚´ ì„¤ì • ì§„ì… ë° ëŒì•„ì˜¤ê¸° ë¡œì§
        let lastGameView = 'selector-view';
        function goSetupFromGame(game) {
            lastGameView = game === 'hand' ? 'game-view' : (game === 'roulette' ? 'roulette-view' : 'cat-view');
            goSetup();
        }
        function goBackFromSetup() {
            showView(lastGameView);
            // ë§Œì•½ ê²Œì„ë·°ì—ì„œ ì˜¨ê²ƒì´ë¼ë©´ ë°ì´í„° ì¦‰ì‹œ ë°˜ì˜ ìœ„í•´ ì¬ì‹œì‘ í•„ìš”í•  ìˆ˜ ìˆìŒ
            if(lastGameView === 'game-view') startGame();
            if(lastGameView === 'roulette-view') goRoulette();
            if(lastGameView === 'cat-view') goCatGame();
        }

        function renderInputGrid() {
            const container = document.getElementById('name-input-container');
            container.innerHTML = "";
            members.forEach((m, idx) => {
                const input = document.createElement('input');
                input.className = 'name-input';
                input.value = m;
                input.placeholder = `Name ${idx+1}`;
                input.oninput = (e) => { members[idx] = e.target.value; };
                container.appendChild(input);
            });
        }

        function openGroupModal() {
            const container = document.getElementById('modal-list-container');
            container.innerHTML = "";
            document.getElementById('modal-title').innerText = i18n[currentLang].lbl_group;
            presetGroups.forEach(g => {
                const div = document.createElement('div');
                div.className = 'stats-row';
                div.style.padding = "15px";
                div.style.cursor = "pointer";
                div.style.borderBottom = "1px solid #f0f0f0";
                div.innerHTML = `<span style="font-weight:800;">${g.name}</span><span style="color:#bbb; font-size:0.7rem;">${g.members.length} members</span>`;
                div.onclick = () => {
                    groupName = g.name;
                    members = [...g.members];
                    updateUI();
                    closeModal();
                };
                container.appendChild(div);
            });
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function openMemberModal() {
            const container = document.getElementById('modal-list-container');
            container.innerHTML = "";
            document.getElementById('modal-title').innerText = i18n[currentLang].lbl_members;
            [2, 3, 4, 5, 6, 8, 10, 12].forEach(n => {
                const div = document.createElement('div');
                div.className = 'stats-row';
                div.style.padding = "15px";
                div.style.cursor = "pointer";
                div.style.borderBottom = "1px solid #f0f0f0";
                div.innerHTML = `<span style="font-weight:800;">${n} ${i18n[currentLang].lbl_member_count}</span>`;
                div.onclick = () => {
                    const diff = n - members.length;
                    if(diff > 0) for(let i=0; i<diff; i++) members.push("");
                    else if(diff < 0) members = members.slice(0, n);
                    updateUI();
                    closeModal();
                };
                container.appendChild(div);
            });
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

        function fillRandomNames() {
            const shuffled = [...randomNames].sort(() => 0.5 - Math.random());
            members = members.map((_, i) => shuffled[i % shuffled.length]);
            renderInputGrid();
        }

        function clearNames() {
            members = members.map(() => "");
            renderInputGrid();
        }

        function saveCurrentTeam() {
            localStorage.setItem('luckyBeanMembers', JSON.stringify(members));
            localStorage.setItem('luckyBeanGroup', groupName);
            alert(currentLang === 'ko' ? "ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!" : "Saved!");
        }

        function saveAndGoHome() {
            saveCurrentTeam();
            goFront();
        }

        // --- ëœë¤ í•¸ë“œ ë¡œì§ ---
        let canPick = true;
        let isAllPass = false;

        function startGame() {
            if(members.filter(m => m.trim() !== "").length < 2) {
                alert(currentLang === 'ko' ? "ìµœì†Œ 2ëª…ì˜ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." : "Please enter at least 2 names.");
                goSetup();
                return;
            }
            showView('game-view');
            document.getElementById('result-shared-root').classList.add('hidden');
            document.getElementById('lucky-area').classList.add('hidden');
            document.getElementById('btn-shuffle').classList.remove('hidden');
            document.getElementById('btn-again-hand').classList.add('hidden');
            
            isAllPass = Math.random() < 0.05;
            canPick = false;
            updateRPG(i18n[currentLang].hands_mixed);
            
            const display = document.getElementById('hand-display');
            display.innerHTML = "";
            
            const activeMembers = members.filter(m => m.trim() !== "");
            activeMembers.forEach((name, i) => {
                const wrap = document.createElement('div');
                wrap.className = 'hand-wrapper';
                wrap.innerHTML = `<img src="hand_closed.png" class="hand-img tension-shake" id="hand-${i}"><div class="member-name">${name}</div>`;
                display.appendChild(wrap);
            });

            setTimeout(() => {
                document.querySelectorAll('.hand-img').forEach(img => img.classList.remove('tension-shake'));
                updateRPG(i18n[currentLang].pick_hand);
                canPick = true;
            }, 1200);
        }

        function shufflePositions() {
            const display = document.getElementById('hand-display');
            const items = Array.from(display.children);
            items.sort(() => Math.random() - 0.5);
            display.innerHTML = "";
            items.forEach(item => display.appendChild(item));
        }

        document.getElementById('hand-display').addEventListener('click', (e) => {
            if(!canPick || !e.target.classList.contains('hand-img')) return;
            const idx = e.target.id.split('-')[1];
            const name = e.target.nextSibling.innerText;
            
            canPick = false;
            if(isAllPass) {
                e.target.src = 'hand_open.png';
                triggerAllPass();
            } else {
                e.target.src = 'hand_loser.png';
                e.target.classList.add('shake');
                const t = i18n[currentLang];
                updateRPG(name + t.pay_msg);
                confetti({ particleCount: 50, spread: 60, origin: { y: 0.7 }, colors: ['#ff4d4d', '#000000'] });
                showReceipt(name);
                saveResult(name);
            }
            document.getElementById('btn-shuffle').classList.add('hidden');
            document.getElementById('btn-again-hand').classList.remove('hidden');
        });

        function triggerAllPass() {
            document.querySelectorAll('.hand-img').forEach(img => {
                img.src = 'hand_open.png';
                img.classList.add('floating');
            });
            document.getElementById('lucky-area').classList.remove('hidden');
            updateRPG(i18n[currentLang].all_pass_unbelievable);
            confetti({ particleCount: 150, spread: 100, origin: { y: 0.6 }, colors: ['#f1c40f', '#ffffff'] });
        }

        // --- ë£°ë › ë¡œì§ ---
        let isSpinning = false;
        function goRoulette() {
            if(members.filter(m => m.trim() !== "").length < 2) {
                alert(currentLang === 'ko' ? "ìµœì†Œ 2ëª…ì˜ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." : "Please enter at least 2 names.");
                goSetup();
                return;
            }
            showView('roulette-view');
            document.getElementById('result-shared-root').classList.add('hidden');
            updateRPG(i18n[currentLang].spin_msg);
            drawRoulette(0);
        }

        function drawRoulette(angle) {
            const canvas = document.getElementById('rouletteCanvas');
            const ctx = canvas.getContext('2d');
            const activeMembers = members.filter(m => m.trim() !== "");
            const slice = (Math.PI * 2) / activeMembers.length;
            
            ctx.clearRect(0, 0, 400, 400);
            activeMembers.forEach((name, i) => {
                const startA = i * slice + angle;
                const endA = startA + slice;
                ctx.beginPath();
                ctx.moveTo(200, 200);
                ctx.arc(200, 200, 190, startA, endA);
                ctx.fillStyle = i % 2 === 0 ? "#ffffff" : "#f1f1f1";
                ctx.fill();
                ctx.stroke();

                ctx.save();
                ctx.translate(200, 200);
                ctx.rotate(startA + slice / 2);
                ctx.textAlign = "right";
                ctx.fillStyle = "#333";
                ctx.font = "800 16px sans-serif";
                ctx.fillText(name, 170, 5);
                ctx.restore();
            });
        }

        function spinRoulette() {
            if(isSpinning) return;
            isSpinning = true;
            const btn = document.getElementById('roulette-spin-btn');
            btn.disabled = true;

            let currentAngle = 0;
            const targetRotation = Math.PI * 2 * (5 + Math.random() * 5);
            const startTime = performance.now();
            const duration = 4000;

            function animate(now) {
                const elapsed = now - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeOut = 1 - Math.pow(1 - progress, 3);
                currentAngle = targetRotation * easeOut;
                drawRoulette(currentAngle);

                if(progress < 1) requestAnimationFrame(animate);
                else {
                    isSpinning = false;
                    btn.disabled = false;
                    const activeMembers = members.filter(m => m.trim() !== "");
                    const slice = (Math.PI * 2) / activeMembers.length;
                    const normalized = (targetRotation % (Math.PI * 2));
                    const winningIdx = activeMembers.length - 1 - Math.floor(normalized / slice);
                    const winner = activeMembers[winningIdx % activeMembers.length];
                    
                    updateRPG(winner + i18n[currentLang].pay_msg);
                    confetti({ particleCount: 80, spread: 70, origin: { y: 0.7 } });
                    showReceipt(winner);
                    saveResult(winner);
                }
            }
            requestAnimationFrame(animate);
        }

        // --- ê³ ì–‘ì´ ê²Œì„ ë¡œì§ ---
        function goCatGame() {
            if(members.filter(m => m.trim() !== "").length < 2) {
                alert(currentLang === 'ko' ? "ìµœì†Œ 2ëª…ì˜ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." : "Please enter at least 2 names.");
                goSetup();
                return;
            }
            showView('cat-view');
            document.getElementById('result-shared-root').classList.add('hidden');
            updateRPG(i18n[currentLang].cat_start);
            
            const area = document.getElementById('bowls-container');
            area.innerHTML = "";
            const activeMembers = members.filter(m => m.trim() !== "");
            
            // 6ëª… ê¸°ì¤€ ê³ ì • ê·¸ë¦¬ë“œ ë°°ì¹˜ ë¡œì§ (í•œ ì¤„ 6ê°œ)
            const count = activeMembers.length;
            const bowlWidth = 50;
            const gap = (320 - (count * bowlWidth)) / (count + 1);

            activeMembers.forEach((name, i) => {
                const bowl = document.createElement('div');
                bowl.className = 'cat-bowl';
                bowl.id = `bowl-${i}`;
                bowl.style.left = `${gap + i * (bowlWidth + gap)}px`;
                bowl.innerHTML = `<img src="cat_bowl.png" class="bowl-img"><div class="bowl-name">${name}</div>`;
                area.appendChild(bowl);
            });
            document.getElementById('moving-cat').style.left = '50%';
            document.getElementById('moving-cat').style.top = '12%';
            document.getElementById('cat-start-btn').disabled = false;
        }

        function startCatGame() {
            const btn = document.getElementById('cat-start-btn');
            btn.disabled = true;
            const cat = document.getElementById('moving-cat');
            cat.src = "cat_walk.gif";
            cat.classList.add('cat-moving');
            updateRPG(i18n[currentLang].cat_msg);

            const activeMembers = members.filter(m => m.trim() !== "");
            const winnerIdx = Math.floor(Math.random() * activeMembers.length);
            const targetBowl = document.getElementById(`bowl-${winnerIdx}`);
            const targetX = targetBowl.offsetLeft + (targetBowl.offsetWidth / 2);
            
            // ê³ ì–‘ì´ê°€ ë°°íšŒí•˜ëŠ” ì²™í•˜ë‹¤ê°€ íƒ€ê²Ÿìœ¼ë¡œ ì´ë™
            setTimeout(() => {
                cat.style.left = `${targetX}px`;
                cat.style.top = '55%';
            }, 1000);

            setTimeout(() => {
                cat.src = "cat_stand.png";
                cat.classList.remove('cat-moving');
                targetBowl.classList.add('bowl-highlight');
                document.querySelectorAll('.cat-bowl').forEach((b, idx) => {
                    if(idx !== winnerIdx) b.classList.add('bowl-dimmed');
                });
                
                const winner = activeMembers[winnerIdx];
                updateRPG(winner + i18n[currentLang].pay_msg);
                confetti({ particleCount: 80, spread: 70, origin: { y: 0.7 } });
                showReceipt(winner);
                saveResult(winner);
                btn.disabled = false;
            }, 2500);
        }

        // --- ê²°ê³¼ ë° ê³µí†µ ë¡œì§ ---
        function showReceipt(name) {
            const t = i18n[currentLang];
            const receipt = document.getElementById('receipt');
            const root = document.getElementById('result-shared-root');
            root.classList.remove('hidden');
            receipt.classList.add('show');
            
            const now = new Date();
            document.getElementById('receipt-date').innerText = now.toLocaleDateString();
            document.getElementById('receipt-order-no').innerText = "ORD-" + Math.floor(Math.random()*9000+1000);
            
            const menu = t.menus[Math.floor(Math.random()*t.menus.length)];
            const price = (Math.floor(Math.random()*3 + 3) * 1000) + (Math.random() < 0.5 ? 500 : 0);
            const qty = members.filter(m => m.trim() !== "").length;

            document.getElementById('receipt-menu').innerText = menu;
            document.getElementById('receipt-qty').innerText = "x" + qty;
            document.getElementById('txt-unit-price').innerText = t.lbl_unit_price;
            document.getElementById('receipt-price').innerText = price.toLocaleString();
            document.getElementById('txt-subtotal').innerText = t.lbl_subtotal;
            document.getElementById('receipt-subtotal').innerText = (price * qty).toLocaleString();
            document.getElementById('txt-selected-customer').innerText = t.lbl_selected;
            document.getElementById('receipt-payer').innerText = name;
            document.getElementById('receipt-fortune').innerText = t.fortunes[Math.floor(Math.random()*t.fortunes.length)];
            document.getElementById('id-share-btn').innerText = t.lbl_get_receipt;
        }

        function saveResult(name) {
            const entry = { name, date: new Date().toISOString(), lang: currentLang };
            history.push(entry);
            localStorage.setItem('coffeeStats', JSON.stringify(history));
            renderStats();
        }

        function renderStats() {
            const statsList = document.getElementById('stats-list');
            const dashboard = document.getElementById('stats-dashboard');
            const noMsg = document.getElementById('no-stats-msg');

            if(history.length === 0) {
                dashboard.classList.add('hidden');
                noMsg.classList.remove('hidden');
                return;
            }
            dashboard.classList.remove('hidden');
            noMsg.classList.add('hidden');

            const counts = history.reduce((acc, curr) => {
                acc[curr.name] = (acc[curr.name] || 0) + 1;
                return acc;
            }, {});

            const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 5);
            statsList.innerHTML = sorted.map(([name, count]) => `
                <div class="stats-row">
                    <span>${name}</span>
                    <span style="color:var(--point-red); font-weight:800;">${count} ${i18n[currentLang].lbl_times}</span>
                </div>
            `).join('');
        }

        function renderHistoryList() {
            const content = document.getElementById('history-list-content');
            const kingArea = document.getElementById('monthly-king-area');
            if(history.length === 0) {
                content.innerText = currentLang === 'ko' ? "ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤." : "No history yet.";
                kingArea.innerHTML = "";
                return;
            }

            // ì´ë‹¬ì˜ ì™• ê³„ì‚°
            const counts = history.reduce((acc, curr) => {
                acc[curr.name] = (acc[curr.name] || 0) + 1;
                return acc;
            }, {});
            const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
            const king = sorted[0];

            kingArea.innerHTML = `
                <div class="monthly-king-badge">
                    <div class="king-crown">ğŸ‘‘</div>
                    <div class="king-info">
                        <div class="king-tag">${i18n[currentLang].lbl_monthly_king}</div>
                        <div class="king-name">${king[0]}</div>
                    </div>
                    <div class="king-count-area">${king[1]}${i18n[currentLang].lbl_times}</div>
                </div>
            `;

            content.innerHTML = history.slice().reverse().map(h => `
                <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #f0f0f0;">
                    <span>${h.name}</span>
                    <span style="font-size:0.7rem; color:#bbb;">${new Date(h.date).toLocaleDateString()}</span>
                </div>
            `).join('');
        }

        function resetStats() {
            if(confirm(currentLang === 'ko' ? "ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí• ê¹Œìš”?" : "Clear all stats?")) {
                history = [];
                localStorage.removeItem('coffeeStats');
                updateUI();
                if(!document.getElementById('history-view').classList.contains('hidden')) goHistory();
            }
        }

        async function shareAsImage() {
            const btn = document.getElementById('id-share-btn');
            const originalText = btn.innerText;
            btn.innerText = "...";
            const captureArea = document.getElementById('capture-area');
            
            try {
                const canvas = await html2canvas(captureArea, { backgroundColor: null, scale: 2 });
                canvas.toBlob(async (blob) => {
                    const file = new File([blob], "lucky_receipt.png", { type: "image/png" });
                    if (navigator.share) {
                        await navigator.share({ files: [file], title: 'Lucky Bean Receipt' });
                    } else {
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = 'receipt.png';
                        link.click();
                    }
                    btn.innerText = originalText;
                });
            } catch (e) {
                console.error(e);
                btn.innerText = originalText;
            }
        }

        function handleStartGame() {
            const bgm = document.getElementById('bgm-player');
            bgm.play().catch(() => console.log("Audio auto-play blocked"));
            document.getElementById('splash-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('splash-screen').style.display = 'none';
            }, 600);
        }

        // ì´ˆê¸° ë¡œë”© ì• ë‹ˆë©”ì´ì…˜
        window.addEventListener('load', () => {
            const fill = document.getElementById('progress-fill');
            let p = 0;
            const iv = setInterval(() => {
                p += Math.random() * 20;
                if(p >= 100) {
                    p = 100;
                    clearInterval(iv);
                    document.getElementById('loading-progress-area').style.display = 'none';
                    document.getElementById('start-action-area').style.display = 'flex';
                }
                fill.style.width = p + '%';
            }, 150);
            updateUI();
        });
    </script>
</body>
</html>
