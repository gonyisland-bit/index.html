<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>lucky bean - v0.4.6</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Lucky Bean">
    <link rel="icon" type="image/png" href="coffeegame_icon.png">
    <link rel="apple-touch-icon" href="coffeegame_icon.png">

    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@1,300&family=Montserrat:wght@800&family=Courier+Prime&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-color: #ffffff;
            --primary-color: #000000;
            --text-gray-70: #4d4d4d;
            --rpg-border: #000000;
            --tablet-bg: #f8f8f8;
            --tablet-border: #eeeeee;
            --point-red: #ff4d4d;
            --divider-color: #ebebeb;
            --btn-shadow: #333333;
            --btn-light-shadow: #e0e0e0;
            --roulette-gold: #f1c40f;
        }

        html, body { height: 100%; margin: 0; padding: 0; touch-action: pan-x pan-y; -webkit-text-size-adjust: none; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color); color: var(--primary-color);
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            overflow-x: hidden; overflow-y: auto;
        }

        .wrapper { width: 100%; max-width: 600px; display: flex; flex-direction: column; align-items: center; text-align: center; padding-bottom: 40px; }

        header { padding: 30px 0 10px; cursor: pointer; width: 100%; display: flex; flex-direction: column; align-items: center; }
        .title-lucky { font-family: 'Playfair Display', serif; font-style: italic; font-weight: 300; font-size: 2.8rem; letter-spacing: -1px; }
        .title-bean { font-family: 'Montserrat', sans-serif; font-weight: 800; font-size: 3.1rem; letter-spacing: -2px; margin-left: -5px; }

        .game-screen {
            position: relative; width: 92%; max-width: 500px; margin: 10px auto 25px;
            border: 6px solid #000; line-height: 0; overflow: hidden; background: #eee; border-radius: 4px;
        }

        .title-image { width: 100%; height: auto; display: block; transition: none; }

        #rpg-textbox {
            position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%); width: 90%;
            background: rgba(255, 255, 255, 0.92); border: 3px solid var(--rpg-border);
            border-radius: 8px; padding: 12px 15px; box-sizing: border-box; line-height: 1.4; pointer-events: none; z-index: 10;
        }
        #rpg-content { font-size: 0.95rem; font-weight: 800; color: #000; min-height: 1.2rem; word-break: keep-all; white-space: pre-wrap; text-align: left; }

        .card-container {
            width: 90%; max-width: 450px; background: var(--tablet-bg); border-radius: 30px;
            padding: 25px; box-sizing: border-box; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.01), 0 15px 35px rgba(0,0,0,0.03); margin: 0 auto 25px;
        }

        .order-menu-header { font-family: 'Montserrat', sans-serif; font-weight: 800; font-size: 0.8rem; color: #333; text-align: left; margin-bottom: 10px; letter-spacing: 1px; }

        .picker-group { width: 100%; display: flex; gap: 12px; margin-bottom: 20px; }
        .picker-btn {
            flex: 1; padding: 14px; border: 1px solid #eee; border-radius: 16px;
            background: white; font-weight: 700; font-size: 0.85rem; color: #333; cursor: pointer;
            display: flex; flex-direction: column; align-items: flex-start; transition: all 0.1s; position: relative;
            box-shadow: 0 4px 0 var(--btn-light-shadow);
        }
        .picker-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 var(--btn-light-shadow); }
        .picker-label { color: #bbb; font-size: 0.65rem; font-weight: 800; margin-bottom: 4px; letter-spacing: 0.5px; }
        .picker-value { display: flex; justify-content: space-between; width: 100%; align-items: center; }
        .picker-value::after { content: 'â–¾'; color: #ccc; font-size: 1rem; }

        .icon-selector-grid { display: flex; justify-content: center; gap: 20px; width: 100%; margin-top: 10px; }
        .icon-btn-item { flex: 1; display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: transform 0.1s; }
        .icon-btn-item:active { transform: scale(0.95); }
        .icon-square {
            width: 100%; aspect-ratio: 1/1; border: 3px solid #000; border-radius: 20px;
            background: #fff; overflow: hidden; margin-bottom: 10px; box-shadow: 0 6px 0 #333;
            display: flex; align-items: center; justify-content: center;
        }
        .icon-square img { width: 85%; height: 85%; object-fit: contain; }
        .icon-label { font-size: 0.75rem; font-weight: 900; color: #000; letter-spacing: 0.5px; text-transform: uppercase; }

        .name-mgmt-bar { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 8px; }
        .btn-text { background: none; border: none; color: #bbb; font-size: 0.7rem; font-weight: 800; cursor: pointer; padding: 5px 10px; transition: 0.2s; letter-spacing: 1px; text-align: center; }

        .divider { width: 100%; height: 1px; background-color: var(--divider-color); margin-bottom: 20px; }

        #name-input-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; width: 100%; margin-bottom: 10px; }
        .name-input {
            padding: 14px 5px; border: 1px solid #eee; border-radius: 14px; font-size: 0.85rem;
            outline: none; text-align: center; width: 100%; box-sizing: border-box; background: white;
            transition: all 0.2s; font-weight: 600;
        }

        .stats-container { width: 100%; background: #fff; padding: 15px; border-radius: 20px; font-size: 0.8rem; box-sizing: border-box; border: 1px solid #eee; }
        .stats-title { font-weight: 800; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; color: #bbb; font-size: 0.7rem; letter-spacing: 1px; }
        .stats-row { display: flex; justify-content: space-between; margin-bottom: 8px; color: #666; font-weight: 600; }

        #hand-display { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; padding: 10px 10px; width: 100%; box-sizing: border-box; position: relative; margin-bottom: 20px; }
        .hand-wrapper { display: flex; flex-direction: column; align-items: center; flex: 0 0 calc(33.33% - 20px); min-width: 90px; transition: transform 0.4s ease; z-index: 1; }
        .hand-img { width: 100%; max-width: 140px; height: auto; aspect-ratio: 1/1; object-fit: contain; cursor: pointer; -webkit-tap-highlight-color: transparent; animation: floating 3s ease-in-out infinite; }

        @keyframes floating { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .tension-shake { animation: tension-animation 0.1s infinite !important; }
        @keyframes tension-animation { 0% { transform: translate(2px, 2px); } 50% { transform: translate(-2px, -2px); } 100% { transform: translate(2px, -2px); } }
        .shake { animation: winner-shake 0.15s infinite !important; }
        @keyframes winner-shake { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(4px); } }

        .game-header-btns {
            display: flex; justify-content: center; align-items: center; gap: 12px;
            width: 100%; max-width: 450px; margin: 0 auto 20px; padding: 0 15px; box-sizing: border-box;
        }
        .btn-pixel-game {
            flex: 1; max-width: 160px; background-color: #fff; color: #333; border: 2px solid #333; padding: 12px 0; font-size: 0.9rem; font-weight: 900;
            border-radius: 50px; cursor: pointer; box-shadow: 0 5px 0 #333; transition: all 0.1s; letter-spacing: 1px; text-transform: uppercase;
        }
        .btn-pixel-game:active:not(:disabled) { transform: translateY(3px); box-shadow: 0 2px 0 #333; }
        .btn-pixel-game:disabled { opacity: 0.3; cursor: not-allowed; box-shadow: none; transform: translateY(3px); filter: grayscale(1); }

        .member-name { font-size: 0.85rem; font-weight: 800; margin-top: 10px; color: #555; }

        .receipt {
            background: #fff; color: #333; width: 280px; padding: 35px 25px 25px; font-family: 'Courier Prime', monospace;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1); border-radius: 2px; position: relative; opacity: 0; margin: 0 auto;
        }
        .receipt::after {
            content: ""; position: absolute; bottom: 0; left: 0; width: 100%; height: 12px;
            background: linear-gradient(-45deg, transparent 6px, #fff 6px), linear-gradient(45deg, transparent 6px, #fff 6px);
            background-size: 12px 24px; transform: translateY(50%);
        }
        .receipt.show { animation: slideUpReceipt 0.6s forwards; }
        @keyframes slideUpReceipt { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .receipt-header { font-size: 1.4rem; font-weight: 800; margin-bottom: 5px; letter-spacing: 2px; text-align: center; }
        .receipt-subheader { font-size: 0.75rem; margin-bottom: 20px; text-align: center; color: #666; }
        .receipt-line { border-top: 1px dashed #bbb; margin: 12px 0; width: 100%; }
        .receipt-item { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.85rem; width: 100%; }
        .receipt-total { display: flex; flex-direction: column; align-items: center; margin: 20px 0; padding: 10px 0; border-top: 2px solid #333; border-bottom: 2px solid #333; }
        .label-customer { font-size: 0.7rem; font-weight: 700; color: #888; margin-bottom: 5px; }
        .value-customer { font-size: 2rem; font-weight: 900; color: var(--point-red); letter-spacing: -1px; }
        .fortune-area { font-size: 0.75rem; line-height: 1.5; color: #555; text-align: center; margin-top: 15px; word-break: keep-all; }

        .btn-main {
            padding: 20px 10px; font-size: 1.1rem; font-weight: 800; background: var(--primary-color); color: white; border: none; border-radius: 20px;
            cursor: pointer; width: 85%; max-width: 320px; transition: all 0.1s;
            box-shadow: 0 8px 0 var(--btn-shadow); text-transform: uppercase;
            position: relative; top: 0; margin-bottom: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .btn-main:active { top: 4px; box-shadow: 0 4px 0 var(--btn-shadow); transform: scale(0.98); }

        .btn-sub {
            padding: 16px; font-size: 0.9rem; font-weight: 800; background: #fff; color: #000; border: 2px solid #000; border-radius: 20px;
            cursor: pointer; width: 85%; max-width: 320px; transition: all 0.1s;
            box-shadow: 0 6px 0 var(--btn-shadow); text-transform: uppercase; margin-bottom: 12px;
        }
        .btn-sub:active { transform: translateY(3px); box-shadow: 0 3px 0 var(--btn-shadow); }

        .btn-spin {
            padding: 18px; font-size: 1.2rem; font-weight: 900; background: #e74c3c; color: white; border: 3px solid #000; border-radius: 50px;
            cursor: pointer; width: 80%; max-width: 280px; transition: all 0.1s;
            box-shadow: 0 6px 0 #333; text-transform: uppercase; margin: 20px auto;
        }
        .btn-spin:active { transform: translateY(4px); box-shadow: 0 2px 0 #333; }

        .footer { width: 100%; text-align: center; padding: 40px 0; font-size: 0.75rem; color: #ccc; letter-spacing: 1px; }
        .hidden { display: none !important; }

        #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: none; align-items: flex-end; justify-content: center; backdrop-filter: blur(4px); }
        .modal-content { background: white; width: 100%; max-width: 500px; border-radius: 30px 30px 0 0; padding: 30px 25px; box-sizing: border-box; animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.6s ease-out; }
        .loading-text { font-family: 'Courier Prime', monospace; font-size: 0.8rem; letter-spacing: 3px; margin-top: 20px; color: #333; }
        .loading-bar-container { width: 150px; height: 4px; background: #eee; border-radius: 10px; margin-top: 10px; overflow: hidden; }
        .loading-bar-fill { height: 100%; width: 0%; background: #000; transition: width 0.1s; }

        .about-text { font-size: 0.85rem; color: #666; line-height: 1.6; text-align: left; word-break: keep-all; }
        .about-label { font-weight: 800; color: #000; margin-top: 15px; display: block; }

        /* íˆìŠ¤í† ë¦¬ ëª¨ë°”ì¼ ìµœì í™” ìˆ˜ì • */
        .monthly-king-badge {
            background: #fff8e1; border: 1.5px solid #ffca28; border-radius: 15px;
            padding: 10px 15px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;
            flex-wrap: nowrap; /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
            overflow: hidden;
        }
        .king-crown { font-size: 1.4rem; flex-shrink: 0; }
        .king-info { text-align: left; flex: 1; min-width: 0; }
        .king-name { font-weight: 900; font-size: 1rem; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .king-tag { font-size: 0.65rem; font-weight: 800; color: #ffca28; letter-spacing: 1px; white-space: nowrap; }
        .king-count-area { margin-left: auto; font-weight: 800; color: #ffca28; white-space: nowrap; flex-shrink: 0; }

        #roulette-container { position: relative; width: 100%; max-width: 320px; margin: 20px auto; }
        .roulette-pin {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            width: 30px; height: 40px; z-index: 20; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .lang-toggle-container { display: flex; justify-content: flex-end; width: 100%; margin-bottom: 15px; }
        .lang-btn { background: #eee; border: none; padding: 6px 12px; font-size: 0.7rem; font-weight: 800; border-radius: 8px; cursor: pointer; color: #999; transition: 0.2s; }
        .lang-btn.active { background: #000; color: #fff; }
    </style>
</head>
<body>

    <div id="splash-screen">
        <img src="coffee.png" alt="Logo" style="width:110px; animation: floating 2s ease-in-out infinite;">
        <div id="loading-progress-area">
            <div class="loading-text">LOADING...</div>
            <div class="loading-bar-container"><div id="progress-fill" class="loading-bar-fill"></div></div>
        </div>
        <div id="start-action-area" style="display:none; flex-direction:column; align-items:center; margin-top:20px; width: 100%;">
            <button class="btn-main" id="btn-start" onclick="handleStartGame()">START GAME</button>
            <div id="start-hint" style="font-size:0.7rem; color:#bbb; margin-top:8px; letter-spacing:1px; font-weight:800;">TAP TO BREW LUCK</div>
        </div>
    </div>

    <audio id="bgm-player" loop preload="auto">
        <source src="cafe_music_bgm.mp3" type="audio/mpeg">
    </audio>

    <div id="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-title" id="modal-title" style="font-weight:800; font-size:1.2rem; margin-bottom:20px;">Select</div>
            <div id="modal-list-container"></div>
            <button class="btn-text" id="modal-close-btn" style="width:100%; padding:20px; color:#999;" onclick="closeModal()">CLOSE</button>
        </div>
    </div>

    <div class="wrapper">
        <header onclick="goFront()">
            <div class="title-container">
                <span class="title-lucky">lucky</span><span class="title-bean">bean</span>
            </div>
        </header>

        <main id="main-content">
            <div class="game-screen">
                <img src="cafe_facade.png" alt="Cafe" id="main-img" class="title-image">
                <div id="rpg-textbox"><div id="rpg-content"></div></div>
            </div>

            <div id="front-view">
                <div class="card-container">
                    <div id="stats-dashboard" class="stats-container hidden">
                        <div class="stats-title"><span id="txt-donation-kings">ğŸ† DONATION KINGS</span> <button id="btn-reset-small" style="font-size:0.65rem; color:#aaa; border:none; background:none; cursor:pointer;" onclick="resetStats()">RESET</button></div>
                        <div id="stats-list"></div>
                    </div>
                    <div id="no-stats-msg" style="font-size: 0.8rem; color: #ccc; font-weight: 700;">WELCOME TO THE CAFE!</div>
                </div>
                <div style="display: flex; flex-direction: column; align-items: center; width: 100%;">
                    <button class="btn-main" id="btn-enter-shop" onclick="showGameSelector()">ENTER SHOP</button>
                    <button class="btn-sub" id="btn-go-setup" onclick="goSetup()">SETTINGS</button>
                    <button class="btn-sub" id="btn-go-history" onclick="goHistory()">HISTORY</button>
                    <button class="btn-sub" id="btn-go-about" onclick="goAbout()">ABOUT</button>
                </div>
            </div>

            <div id="selector-view" class="hidden">
                <div class="card-container">
                    <div class="order-menu-header" id="txt-choose-luck" style="text-align: center; margin-bottom: 25px;">CHOOSE YOUR LUCK</div>
                    <div class="icon-selector-grid">
                        <div class="icon-btn-item" onclick="startGame()">
                            <div class="icon-square"><img src="random_hand.png" alt="Hand"></div>
                            <div class="icon-label" id="txt-game-hand">Random Hand</div>
                        </div>
                        <div class="icon-btn-item" onclick="goRoulette()">
                            <div class="icon-square"><img src="lucky_roulette.png" alt="Roulette"></div>
                            <div class="icon-label" id="txt-game-roulette">Lucky Roulette</div>
                        </div>
                    </div>
                </div>
                <button class="btn-main" id="btn-back-menu-selector" onclick="goFront()" style="background:#eee; color:#999; box-shadow:0 8px 0 #ddd;">BACK TO MENU</button>
            </div>

            <div id="setup-view" class="hidden">
                <div class="card-container">
                    <div class="lang-toggle-container">
                        <button id="lang-ko" class="lang-btn" onclick="setLanguage('ko')">KO</button>
                        <button id="lang-en" class="lang-btn" onclick="setLanguage('en')" style="margin-left:5px;">EN</button>
                    </div>
                    <div class="order-menu-header" id="txt-setting-title">ğŸ“‹ <b>ORDER MENU SETTING</b></div>
                    <div class="divider" style="margin-bottom: 15px;"></div>
                    <div class="picker-group">
                        <div class="picker-btn" onclick="openGroupModal()">
                            <span class="picker-label" id="lbl-group">GROUP</span>
                            <div class="picker-value"><span id="display-group-name">Empty</span></div>
                        </div>
                        <div class="picker-btn" onclick="openMemberModal()">
                            <span class="picker-label" id="lbl-members">MEMBERS</span>
                            <div class="picker-value"><span id="display-member-count">3 Members</span></div>
                        </div>
                    </div>
                    <div class="name-mgmt-bar">
                        <button class="btn-text" id="btn-random" onclick="fillRandomNames()">RANDOM</button>
                        <button class="btn-text" id="btn-clear" onclick="clearNames()">CLEAR</button>
                        <button class="btn-text" id="btn-save-team" onclick="saveCurrentTeam()" style="color:#888;">SAVE</button>
                    </div>
                    <div class="divider"></div>
                    <div id="name-input-container"></div>
                </div>
                <div style="display: flex; flex-direction: column; align-items: center; width: 100%;">
                    <button class="btn-main" id="btn-save-exit" onclick="saveAndGoHome()">SAVE & EXIT</button>
                    <button class="btn-sub" id="btn-back-home" onclick="goFront()" style="background:#fff; color:#bbb; border:2px solid #eee; box-shadow:0 6px 0 #f8f8f8;">BACK TO HOME</button>
                </div>
            </div>

            <div id="game-view" class="hidden">
                <div class="game-header-btns">
                    <button class="btn-pixel-game" id="btn-shuffle" onclick="shufflePositions()">SHUFFLE</button>
                    <button class="btn-pixel-game" id="btn-again-hand" onclick="startGame()" disabled>AGAIN</button>
                </div>
                <div id="hand-display"></div>
                <div id="game-btn-group" style="display:flex; flex-direction:column; align-items:center; gap:8px; width:100%;">
                    <div id="lucky-area" class="hidden" style="margin-bottom:20px; font-weight:900; color:#f1c40f; font-size:1.2rem; text-shadow: 1px 1px 0px #000;">ğŸŒŸ EXTRA LUCK! ALL PASS! ğŸŒŸ</div>
                    <button class="btn-main" id="btn-back-selector-hand" onclick="showGameSelector()">CHANGE GAME</button>
                    <button class="btn-sub" id="btn-back-menu-hand" onclick="goFront()" style="color:#bbb; border-color:#eee; box-shadow:0 6px 0 #f8f8f8;">BACK TO MENU</button>
                </div>
            </div>

            <div id="roulette-view" class="hidden">
                <div class="card-container" style="text-align:center;">
                    <div class="order-menu-header" id="txt-roulette-title">ğŸ¡ <b>LUCKY ROULETTE</b></div>
                    <div class="divider"></div>
                    <div id="roulette-container">
                        <svg class="roulette-pin" viewBox="0 0 30 40">
                            <path d="M15 0 L30 20 L15 40 L0 20 Z" fill="#e74c3c" stroke="#000" stroke-width="2"/>
                        </svg>
                        <canvas id="rouletteCanvas" width="400" height="400" style="width:100%; max-width:320px; border-radius:50%; border:6px solid #333;"></canvas>
                    </div>
                    <button id="roulette-spin-btn" class="btn-spin" onclick="spinRoulette()">SPIN</button>
                </div>
                <div id="roulette-action-area" style="display:flex; flex-direction:column; align-items:center; width:100%; gap:8px;">
                     <button class="btn-main" id="btn-back-selector-roulette" onclick="showGameSelector()">CHANGE GAME</button>
                     <button class="btn-sub" id="btn-back-menu-roulette" onclick="goFront()" style="color:#bbb; border-color:#eee; box-shadow:0 6px 0 #f8f8f8;">BACK TO MENU</button>
                </div>
            </div>

            <div id="result-shared-root" class="hidden">
                <div id="capture-area" style="padding: 15px 0; background: transparent; width:100%;">
                    <div class="receipt" id="receipt">
                        <div class="receipt-header">RECEIPT</div>
                        <div class="receipt-subheader">LUCKY BEAN SHOP</div>
                        <div class="receipt-item"><span id="receipt-date"></span><span id="receipt-order-no"></span></div>
                        <div class="receipt-line"></div>
                        <div class="receipt-item"><span id="receipt-menu"></span><span id="receipt-qty"></span></div>
                        <div class="receipt-item"><span id="txt-unit-price">UNIT PRICE</span><span id="receipt-price"></span></div>
                        <div class="receipt-line"></div>
                        <div class="receipt-item" style="font-weight:800;"><span id="txt-subtotal">SUBTOTAL</span><span id="receipt-subtotal"></span></div>
                        <div class="receipt-total">
                            <span class="label-customer" id="txt-selected-customer">SELECTED CUSTOMER</span>
                            <span id="receipt-payer" class="value-customer"></span>
                        </div>
                        <div class="receipt-line"></div>
                        <div class="fortune-area" id="receipt-fortune"></div>
                        <button class="btn-text" id="id-share-btn" onclick="shareAsImage()" style="width:100%; margin-top: 15px; color:#ccc; border:1px solid #eee; border-radius:10px; padding:8px; font-size:0.6rem;">GET A RECEIPT</button>
                    </div>
                </div>
            </div>

            <div id="about-view" class="hidden">
                <div class="card-container" style="text-align: left;">
                    <div class="order-menu-header" id="txt-about-title">â˜• <b>ABOUT LUCKY BEAN</b></div>
                    <div class="divider"></div>
                    <div class="about-text" id="txt-about-content"></div>
                </div>
                <button class="btn-main" id="btn-back-home-about" onclick="goFront()">BACK TO HOME</button>
            </div>

            <div id="history-view" class="hidden">
                <div class="card-container" style="text-align: left;">
                    <div class="order-menu-header" id="txt-history-title">ğŸ† <b>DONATION HISTORY</b></div>
                    <div class="divider"></div>
                    <div id="monthly-king-area"></div>
                    <div id="history-list-content" class="about-text"></div>
                    <button class="btn-text" id="btn-reset-all" onclick="resetStats()" style="width:100%; margin-top:15px; color:var(--point-red);">RESET ALL DATA</button>
                </div>
                <button class="btn-main" id="btn-back-home-history" onclick="goFront()">BACK TO HOME</button>
            </div>
        </main>
        <div class="footer">v0.4.6 | â“’ 2026. Gonystudio. All rights reserved.</div>
    </div>

    <script>
        const i18n = {
            en: {
                welcome: "Welcome to the Lucky Bean!",
                choose_luck: "Choose your luckiest game!",
                setting_msg: "Settings: Manage your team.",
                how_to: "How to play and track donations.",
                history_msg: "Who donated the most coffee?",
                pick_hand: "Who will pay? Pick a hand!",
                hands_mixed: "Hands Mixed!",
                safe_msg: " is Safe!",
                pay_msg: " will pay!",
                lucky_round: "LUCKY! Everyone is SAFE! ğŸŒŸ",
                spin_msg: "Spin the wheel for luck!",
                all_pass: "ğŸŒŸ ALL PASS ğŸŒŸ",
                all_pass_unbelievable: "ğŸŒŸ UNBELIEVABLE! ALL PASS! ğŸŒŸ",
                btn_start: "START GAME",
                btn_enter_shop: "ENTER SHOP",
                btn_setup: "SETTINGS",
                btn_history: "HISTORY",
                btn_about: "ABOUT",
                btn_back_menu: "BACK TO MENU",
                btn_back_home: "BACK TO HOME",
                btn_save_exit: "SAVE & EXIT",
                btn_shuffle: "SHUFFLE",
                btn_again: "AGAIN",
                btn_spin: "SPIN",
                btn_change_game: "CHANGE GAME",
                lbl_group: "GROUP",
                lbl_members: "MEMBERS",
                lbl_random: "RANDOM",
                lbl_clear: "CLEAR",
                lbl_save: "SAVE",
                lbl_kings: "ğŸ† DONATION KINGS",
                lbl_unit_price: "UNIT PRICE",
                lbl_subtotal: "SUBTOTAL",
                lbl_selected: "SELECTED CUSTOMER",
                lbl_get_receipt: "GET A RECEIPT",
                lbl_monthly_king: "MONTHLY KING",
                lbl_times: "times",
                lbl_empty: "Empty",
                lbl_member_count: "Members",
                txt_about_content: `<span class="about-label">HOW TO PLAY</span>
                        1. Enter names in SETTINGS.<br>
                        2. Go to ENTER SHOP and pick a game.<br>
                        3. Pick a hand or spin the wheel.<br>
                        4. The one with 'MONEY' pays!<br>
                        <span class="about-label">HISTORY & RANKING</span>
                        - Every win is recorded in HISTORY.<br>
                        - Check the 'DONATION KINGS' to see who paid the most.<br>
                        - 'MONTHLY KING' resets every month. Be generous!`,
                fortunes: ["Great luck will come to you!", "Kindness returns to you.", "Small loss, big luck later!", "This coffee is on luck!", "Your team respects you!", "Tip: Choose the next payer!"],
                menus: ["Americano", "Cafe Latte", "Vanilla Latte", "Flat White", "Cold Brew", "Einspanner", "Dolce Latte", "Caramel Macchiato"]
            },
            ko: {
                welcome: "ëŸ­í‚¤ë¹ˆì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!",
                choose_luck: "ê°€ì¥ ìš´ ì¢‹ì€ ê²Œì„ì„ ê³¨ë¼ë³´ì„¸ìš”!",
                setting_msg: "ì„¤ì •: íŒ€ ë©¤ë²„ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”.",
                how_to: "ê²Œì„ ë°©ë²• ë° íˆìŠ¤í† ë¦¬ ì•ˆë‚´",
                history_msg: "ëˆ„ê°€ ê°€ì¥ ì»¤í”¼ë¥¼ ë§ì´ ìƒ€ì„ê¹Œìš”?",
                pick_hand: "ëˆ„ê°€ ë‚¼ê¹Œìš”? ì†ì„ ê³¨ë¼ë³´ì„¸ìš”!",
                hands_mixed: "ì†ì´ ì„ì˜€ìŠµë‹ˆë‹¤!",
                safe_msg: "ë‹˜ì€ ìƒì¡´!",
                pay_msg: "ë‹˜ì´ ë‹¹ì²¨ë˜ì—ˆìŠµë‹ˆë‹¤!",
                lucky_round: "ëŸ­í‚¤! ëª¨ë‘ ìƒì¡´í–ˆìŠµë‹ˆë‹¤! ğŸŒŸ",
                spin_msg: "ë£°ë ›ì„ ëŒë ¤ ìš´ì„ ì‹œí—˜í•˜ì„¸ìš”!",
                all_pass: "ğŸŒŸ ì „ì› í†µê³¼ ğŸŒŸ",
                all_pass_unbelievable: "ğŸŒŸ ëŒ€ë°•! ì „ì› í†µê³¼ì…ë‹ˆë‹¤! ğŸŒŸ",
                btn_start: "ê²Œì„ ì‹œì‘",
                btn_enter_shop: "ì…ì¥í•˜ê¸°",
                btn_setup: "ì„¤ì •",
                btn_history: "íˆìŠ¤í† ë¦¬",
                btn_about: "ì •ë³´",
                btn_back_menu: "ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°",
                btn_back_home: "í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°",
                btn_save_exit: "ì €ì¥ ë° ë‚˜ê°€ê¸°",
                btn_shuffle: "ì„ê¸°",
                btn_again: "ë‹¤ì‹œí•˜ê¸°",
                btn_spin: "ëŒë¦¬ê¸°",
                btn_change_game: "ê²Œì„ ë³€ê²½",
                lbl_group: "ê·¸ë£¹",
                lbl_members: "ì¸ì›",
                lbl_random: "ëœë¤",
                lbl_clear: "ì´ˆê¸°í™”",
                lbl_save: "ì €ì¥",
                lbl_kings: "ğŸ† ì˜¤ëŠ˜ì˜ ê¸°ë¶€ì™•",
                lbl_unit_price: "ë‹¨ê°€",
                lbl_subtotal: "í•©ê³„",
                lbl_selected: "ë‹¹ì²¨ì",
                lbl_get_receipt: "ì˜ìˆ˜ì¦ ë°›ê¸°",
                lbl_monthly_king: "ì´ë‹¬ì˜ ê¸°ë¶€ì™•",
                lbl_times: "íšŒ",
                lbl_empty: "ë¹„ì–´ìˆìŒ",
                lbl_member_count: "ëª…",
                txt_about_content: `<span class="about-label">ê²Œì„ ë°©ë²•</span>
                        1. SETTINGSì—ì„œ ë©¤ë²„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.<br>
                        2. ENTER SHOPì„ ëˆŒëŸ¬ ê²Œì„ì„ ê³ ë¥´ì„¸ìš”.<br>
                        3. ì†ì„ ê³ ë¥´ê±°ë‚˜ ë£°ë ›ì„ ëŒë¦¬ì„¸ìš”.<br>
                        4. 'ëˆ'ì„ ì¥” ì‚¬ëŒì´ ì˜¤ëŠ˜ì˜ ê²°ì œ ë‹¹ì²¨!<br>
                        <span class="about-label">íˆìŠ¤í† ë¦¬ ë° ë­í‚¹</span>
                        - ê²°ì œ ë‹¹ì²¨ ë‚´ì—­ì€ HISTORYì— ìë™ ê¸°ë¡ë©ë‹ˆë‹¤.<br>
                        - ë©”ì¸ í™”ë©´ê³¼ íˆìŠ¤í† ë¦¬ì—ì„œ ëˆ„ê°€ ê°€ì¥ ë§ì´ ëƒˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.<br>
                        - ë§¤ë‹¬ ê°€ì¥ ë§ì´ ê¸°ë¶€í•œ 'ì´ë‹¬ì˜ ê¸°ë¶€ì™•'ì„ ë½‘ìŠµë‹ˆë‹¤.`,
                fortunes: ["ì˜¤ëŠ˜ ì»¤í”¼ë¥¼ ìœ ë‹¹ì‹ , ëŒ€ë°• í–‰ìš´ì´ ì˜¬ ê±°ì˜ˆìš”!", "ë² í‘¼ ë§Œí¼ ë” í° ë³µì´ ë“¤ì–´ì˜µë‹ˆë‹¤.", "ì§€ê°‘ì€ ë¹„ì—ˆì–´ë„ ì¸ì‹¬ì€ ê½‰ ì°¼ë„¤ìš”!", "ì˜¤ëŠ˜ ë§ˆì‹œëŠ” ì»¤í”¼ëŠ” ì¸ìƒ ìµœê³ ë¡œ ë‹¬ì½¤í•  ê²ë‹ˆë‹¤.", "ë©‹ì§„ ê²°ì œ! íŒ€ì›ë“¤ì´ ë‹¹ì‹ ì„ ì¡´ê²½í•©ë‹ˆë‹¤.", "ë‹¤ìŒì—” ëˆ„ê°€ ì‚´ì§€ ë¯¸ë¦¬ ì •í•´ë‘ì„¸ìš”!"],
                menus: ["ì•„ë©”ë¦¬ì¹´ë…¸", "ì¹´í˜ë¼ë–¼", "ë°”ë‹ë¼ë¼ë–¼", "í”Œë«í™”ì´íŠ¸", "ì½œë“œë¸Œë£¨", "ì•„ì¸ìŠˆí˜ë„ˆ", "ëŒì²´ë¼ë–¼", "ì¹´ë¼ë©œ ë§ˆí‚¤ì•„ë˜"]
            }
        };

        let currentLang = localStorage.getItem('luckyBeanLang') || 'en';
        const randomNicknames = ["Coffee Monster", "Latte King", "Ice Bear", "Sugar Addict", "Lucky Guy", "Morning Coffee", "Bean Hunter", "Cream Lover", "Caffeine Bomb", "Daily Bread"];

        let memberNames = []; let typeTimeout; let isGameOver = false; let winnerIndex = -1;
        let isLuckyRound = false; let lastWasLucky = false;
        let currentTeamName = 'Empty'; let currentMemberCount = 3; let isShuffling = false;
        let isAudioStarted = false;
        let rouletteAngle = 0; let rouletteSpinning = false; let currentRouletteItems = [];

        const AudioEngine = {
            ctx: null, bgm: null,
            initAndPlayBGM() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                    this.bgm = document.getElementById('bgm-player');
                    this.bgm.volume = 0.15;
                }
                if (this.ctx.state === 'suspended') this.ctx.resume();
                if (this.bgm && this.bgm.paused) this.bgm.play().then(() => { isAudioStarted = true; }).catch(e => console.log(e));
            },
            pauseBGM() { if (this.bgm) this.bgm.pause(); },
            resumeBGM() { if (this.bgm && isAudioStarted) this.bgm.play(); },
            play(type) {
                if (!this.ctx || this.ctx.state === 'suspended') return;
                const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain(); const now = this.ctx.currentTime;
                osc.connect(gain); gain.connect(this.ctx.destination);
                if (type === 'start') {
                    osc.frequency.setValueAtTime(698.46, now); osc.frequency.exponentialRampToValueAtTime(1046.50, now + 0.15);
                    gain.gain.setValueAtTime(0.5, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                    osc.start(now); osc.stop(now + 0.2);
                } else if (type === 'safe') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(1174.66, now);
                    gain.gain.setValueAtTime(0.3, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    osc.start(now); osc.stop(now + 0.1);
                } else if (type === 'fail') {
                    osc.frequency.setValueAtTime(880, now); osc.frequency.exponentialRampToValueAtTime(110, now + 0.5);
                    gain.gain.setValueAtTime(0.5, now); gain.gain.linearRampToValueAtTime(0, now + 0.5);
                    osc.start(now); osc.stop(now + 0.5);
                } else if (type === 'whoosh') {
                    osc.type = 'triangle'; osc.frequency.setValueAtTime(100, now); osc.frequency.exponentialRampToValueAtTime(1200, now + 0.3);
                    gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc.start(now); osc.stop(now + 0.3);
                }
            }
        };

        document.addEventListener("visibilitychange", () => {
            if (document.hidden) AudioEngine.pauseBGM();
            else AudioEngine.resumeBGM();
        });

        window.onload = () => {
            const fill = document.getElementById('progress-fill');
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress >= 100) {
                    progress = 100; clearInterval(interval);
                    setTimeout(() => {
                        document.getElementById('loading-progress-area').style.display = 'none';
                        document.getElementById('start-action-area').style.display = 'flex';
                    }, 500);
                }
                fill.style.width = progress + '%';
            }, 50);
            applyLanguage();
        };

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('luckyBeanLang', lang);
            applyLanguage();
            if (!document.getElementById('front-view').classList.contains('hidden')) goFront();
            else if (!document.getElementById('setup-view').classList.contains('hidden')) goSetup();
            else if (!document.getElementById('about-view').classList.contains('hidden')) goAbout();
            else if (!document.getElementById('history-view').classList.contains('hidden')) goHistory();
            else if (!document.getElementById('selector-view').classList.contains('hidden')) showGameSelector();
        }

        function applyLanguage() {
            const t = i18n[currentLang];
            document.getElementById('lang-ko').classList.toggle('active', currentLang === 'ko');
            document.getElementById('lang-en').classList.toggle('active', currentLang === 'en');
            document.getElementById('btn-start').innerText = t.btn_start;
            document.getElementById('btn-enter-shop').innerText = t.btn_enter_shop;
            document.getElementById('btn-go-setup').innerText = t.btn_setup;
            document.getElementById('btn-go-history').innerText = t.btn_history;
            document.getElementById('btn-go-about').innerText = t.btn_about;
            document.getElementById('btn-back-menu-selector').innerText = t.btn_back_menu;
            document.getElementById('btn-back-menu-hand').innerText = t.btn_back_menu;
            document.getElementById('btn-back-menu-roulette').innerText = t.btn_back_menu;
            document.getElementById('btn-back-home').innerText = t.btn_back_home;
            document.getElementById('btn-back-home-about').innerText = t.btn_back_home;
            document.getElementById('btn-back-home-history').innerText = t.btn_back_home;
            document.getElementById('btn-save-exit').innerText = t.btn_save_exit;
            document.getElementById('btn-shuffle').innerText = t.btn_shuffle;
            document.getElementById('btn-again-hand').innerText = t.btn_again;
            document.getElementById('roulette-spin-btn').innerText = t.btn_spin;
            
            // ì¶”ê°€ëœ ë‹¤êµ­ì–´ ë§¤í•‘
            document.getElementById('btn-back-selector-hand').innerText = t.btn_change_game;
            document.getElementById('btn-back-selector-roulette').innerText = t.btn_change_game;

            document.getElementById('lbl-group').innerText = t.lbl_group;
            document.getElementById('lbl-members').innerText = t.lbl_members;
            document.getElementById('btn-random').innerText = t.lbl_random;
            document.getElementById('btn-clear').innerText = t.lbl_clear;
            document.getElementById('btn-save-team').innerText = t.lbl_save;
            document.getElementById('txt-donation-kings').innerText = t.lbl_kings;
            document.getElementById('txt-unit-price').innerText = t.lbl_unit_price;
            document.getElementById('txt-subtotal').innerText = t.lbl_subtotal;
            document.getElementById('txt-selected-customer').innerText = t.lbl_selected;
            document.getElementById('id-share-btn').innerText = t.lbl_get_receipt;
            document.getElementById('txt-choose-luck').innerText = t.choose_luck;
            document.getElementById('txt-game-hand').innerText = currentLang === 'ko' ? "ëœë¤ ì† ë½‘ê¸°" : "Random Hand";
            document.getElementById('txt-game-roulette').innerText = currentLang === 'ko' ? "í–‰ìš´ì˜ ë£°ë ›" : "Lucky Roulette";
            document.getElementById('txt-setting-title').innerHTML = `ğŸ“‹ <b>${currentLang === 'ko' ? "ì£¼ë¬¸ ë©”ë‰´ ì„¤ì •" : "ORDER MENU SETTING"}</b>`;
            document.getElementById('txt-roulette-title').innerHTML = `ğŸ¡ <b>${currentLang === 'ko' ? "í–‰ìš´ì˜ ë£°ë ›" : "LUCKY ROULETTE"}</b>`;
            document.getElementById('txt-about-title').innerHTML = `â˜• <b>${currentLang === 'ko' ? "ëŸ­í‚¤ë¹ˆ ì •ë³´" : "ABOUT LUCKY BEAN"}</b>`;
            document.getElementById('txt-history-title').innerHTML = `ğŸ† <b>${currentLang === 'ko' ? "ê¸°ë¶€ íˆìŠ¤í† ë¦¬" : "DONATION HISTORY"}</b>`;
            document.getElementById('txt-about-content').innerHTML = t.txt_about_content;
            document.getElementById('display-group-name').innerText = currentTeamName === 'Empty' ? t.lbl_empty : currentTeamName;
            document.getElementById('display-member-count').innerText = `${currentMemberCount}${currentLang === 'ko' ? 'ëª…' : ' Members'}`;
        }

        function updateText(msgKey, isDirect = false) {
            clearTimeout(typeTimeout);
            const content = document.getElementById('rpg-content'); content.innerText = ''; let i = 0;
            const msg = isDirect ? msgKey : i18n[currentLang][msgKey];
            function typing() { if (i < msg.length) { content.innerText += msg.charAt(i); i++; typeTimeout = setTimeout(typing, 40); } }
            typing();
        }

        function handleStartGame() {
            AudioEngine.initAndPlayBGM();
            const splash = document.getElementById('splash-screen');
            splash.style.opacity = '0';
            setTimeout(() => { splash.style.display = 'none'; goFront(); }, 600);
        }

        function goFront() {
            hideAllViews();
            document.getElementById('front-view').classList.remove('hidden');
            document.getElementById('main-img').src = 'cafe_facade.png';
            updateText('welcome');
            showStats();
        }

        function showGameSelector() {
            hideAllViews();
            document.getElementById('selector-view').classList.remove('hidden');
            document.getElementById('main-img').src = 'cafe_facade_zoom.png';
            updateText('choose_luck');
        }

        function goSetup() {
            hideAllViews();
            document.getElementById('setup-view').classList.remove('hidden');
            document.getElementById('main-img').src = 'cafe_setting.png';
            updateText('setting_msg');
            generateNameInputs();
        }

        function goAbout() {
            hideAllViews();
            document.getElementById('about-view').classList.remove('hidden');
            document.getElementById('main-img').src = 'cafe_facade.png';
            updateText('how_to');
        }

        function goHistory() {
            hideAllViews();
            document.getElementById('history-view').classList.remove('hidden');
            document.getElementById('main-img').src = 'cafe_history.png';
            updateText('history_msg');
            renderHistoryPage();
        }

        function hideAllViews() {
            ['front-view', 'selector-view', 'setup-view', 'game-view', 'about-view', 'history-view', 'roulette-view'].forEach(v => {
                const el = document.getElementById(v);
                if(el) el.classList.add('hidden');
            });
            document.getElementById('result-shared-root').classList.add('hidden');
            document.getElementById('receipt').classList.remove('show');
            document.getElementById('lucky-area').classList.add('hidden');
            
            // ìº¡ì²˜ ì˜ì—­ ì›ìœ„ì¹˜
            const captureArea = document.getElementById('capture-area');
            const rootContainer = document.getElementById('result-shared-root');
            if(captureArea && rootContainer && captureArea.parentElement !== rootContainer) {
                rootContainer.appendChild(captureArea);
            }
        }

        function saveAndGoHome() {
            const inputs = document.querySelectorAll('.name-input');
            const tempNames = [];
            for (let i = 0; i < currentMemberCount; i++) { tempNames.push(inputs[i].value.trim() || `User ${i+1}`); }
            localStorage.setItem('lastCoffeeMembers', JSON.stringify(tempNames));
            goFront();
        }

        function generateNameInputs(providedNames = null) {
            const container = document.getElementById('name-input-container');
            const saved = localStorage.getItem('lastCoffeeMembers');
            const lastSaved = saved ? JSON.parse(saved) : null;
            const currentInputs = Array.from(container.querySelectorAll('.name-input')).map(i => i.value);
            let namesToUse = providedNames || (lastSaved && lastSaved.length === currentMemberCount ? lastSaved : currentInputs);
            container.innerHTML = '';
            for (let i = 0; i < currentMemberCount; i++) {
                const input = document.createElement('input'); input.type = 'text'; input.className = 'name-input';
                input.placeholder = `User ${i+1}`; input.id = `input-name-${i}`;
                if (namesToUse && namesToUse[i]) input.value = namesToUse[i];
                container.appendChild(input);
            }
            document.getElementById('display-member-count').innerText = `${currentMemberCount}${currentLang === 'ko' ? 'ëª…' : ' Members'}`;
        }

        function fillRandomNames() {
            let shuffled = [...randomNicknames].sort(() => Math.random() - 0.5);
            document.querySelectorAll('.name-input').forEach((input, idx) => { input.value = shuffled[idx % shuffled.length]; });
        }

        function openGroupModal() {
            const overlay = document.getElementById('modal-overlay'); const container = document.getElementById('modal-list-container');
            document.getElementById('modal-title').innerText = i18n[currentLang].lbl_group;
            overlay.style.display = 'flex'; container.innerHTML = '';
            const teams = JSON.parse(localStorage.getItem('coffeeTeams') || '{}');
            Object.keys(teams).forEach(name => {
                const div = document.createElement('div');
                div.style = "display:flex; justify-content:space-between; padding:18px 5px; border-bottom:1px solid #f8f8f8;";
                div.innerHTML = `<span style="flex:1; cursor:pointer; font-weight:600;" onclick="loadTeam('${name}')">${name}</span><span style="color:#eee; font-size:1.5rem; cursor:pointer; padding:0 10px;" onclick="deleteTeam('${name}')">Ã—</span>`;
                container.appendChild(div);
            });
        }

        function deleteTeam(name) {
            if(confirm(`${name} íŒ€ì„ ì‚­ì œí• ê¹Œìš”?`)) {
                const teams = JSON.parse(localStorage.getItem('coffeeTeams') || '{}');
                delete teams[name];
                localStorage.setItem('coffeeTeams', JSON.stringify(teams));
                openGroupModal();
            }
        }

        function openMemberModal() {
            const overlay = document.getElementById('modal-overlay'); const container = document.getElementById('modal-list-container');
            document.getElementById('modal-title').innerText = currentLang === 'ko' ? "ì¸ì› ì„ íƒ" : "How many?";
            overlay.style.display = 'flex'; container.innerHTML = '';
            for (let i = 2; i <= 12; i++) {
                const div = document.createElement('div');
                div.style = "padding:18px 5px; border-bottom:1px solid #f8f8f8; text-align:center; cursor:pointer; font-weight:600;";
                div.innerText = `${i}${currentLang === 'ko' ? 'ëª…' : ' Members'}`; div.onclick = () => { currentMemberCount = i; generateNameInputs(); closeModal(); };
                container.appendChild(div);
            }
        }

        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
        
        function loadTeam(name) {
            currentTeamName = name; document.getElementById('display-group-name').innerText = name;
            const teams = JSON.parse(localStorage.getItem('coffeeTeams') || '{}');
            if (teams[name]) { currentMemberCount = teams[name].count; generateNameInputs(teams[name].names); }
            closeModal();
        }

        function saveCurrentTeam() {
            const name = prompt(currentLang === 'ko' ? "ê·¸ë£¹ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:" : "Group Name:"); if (!name) return;
            const names = Array.from(document.querySelectorAll('.name-input')).map(i => i.value.trim() || `User`);
            const teams = JSON.parse(localStorage.getItem('coffeeTeams') || '{}');
            teams[name] = { count: currentMemberCount, names: names };
            localStorage.setItem('coffeeTeams', JSON.stringify(teams));
            currentTeamName = name; document.getElementById('display-group-name').innerText = name;
        }

        function clearNames() { document.querySelectorAll('.name-input').forEach(i => i.value = ''); }

        function startGame() {
            const saved = localStorage.getItem('lastCoffeeMembers');
            memberNames = saved ? JSON.parse(saved) : ["User 1", "User 2", "User 3"];
            AudioEngine.play('start'); winnerIndex = Math.floor(Math.random() * memberNames.length);
            isLuckyRound = !lastWasLucky && Math.random() < 0.15;
            isGameOver = false; hideAllViews();
            document.getElementById('game-view').classList.remove('hidden');
            document.getElementById('btn-shuffle').disabled = false;
            document.getElementById('btn-again-hand').disabled = true;
            updateText('pick_hand');
            document.getElementById('main-img').src = 'cafe_counter.png';
            renderHands();
        }

        function renderHands() {
            const display = document.getElementById('hand-display'); display.innerHTML = '';
            for (let i = 0; i < memberNames.length; i++) {
                const wrapper = document.createElement('div'); wrapper.className = 'hand-wrapper';
                const handImg = document.createElement('img'); handImg.src = 'hand_nothing.png'; handImg.className = 'hand-img';
                handImg.onclick = () => handleHandClick(i, memberNames.length);
                const nameTag = document.createElement('div'); nameTag.className = 'member-name'; nameTag.innerText = memberNames[i];
                wrapper.appendChild(handImg); wrapper.appendChild(nameTag); display.appendChild(wrapper);
            }
        }

        function shufflePositions() {
            if (isGameOver || isShuffling) return;
            isShuffling = true; AudioEngine.play('whoosh');
            const wrappers = document.querySelectorAll('.hand-wrapper');
            wrappers.forEach(w => { w.style.transition = "transform 0.4s"; w.style.transform = `scale(0.5) translate(0, 50px)`; });
            setTimeout(() => {
                for (let i = memberNames.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1)); [memberNames[i], memberNames[j]] = [memberNames[j], memberNames[i]];
                }
                winnerIndex = Math.floor(Math.random() * memberNames.length);
                wrappers.forEach(w => { w.style.transform = `translate(${(Math.random()-0.5)*100}px, ${(Math.random()-0.5)*100}px) scale(1)`; });
                setTimeout(() => { renderHands(); isShuffling = false; updateText('hands_mixed'); }, 450);
            }, 450);
        }

        function handleHandClick(index, total) {
            if (isGameOver || isShuffling) return;
            const hands = document.getElementsByClassName('hand-img');
            if (hands[index].dataset.opened === "true") return;

            document.getElementById('btn-shuffle').disabled = true;

            hands[index].classList.add('tension-shake');
            setTimeout(() => {
                hands[index].classList.remove('tension-shake');
                if (isLuckyRound) {
                    isGameOver = true; lastWasLucky = true; AudioEngine.play('start');
                    for(let h of hands) { h.src = 'hand_open.png'; h.style.animation = "floating 0.5s infinite"; }
                    updateText('lucky_round');
                    document.getElementById('main-img').src = 'cafe_counter_lucky.png';
                    document.getElementById('lucky-area').classList.remove('hidden');
                    document.getElementById('btn-again-hand').disabled = false;
                } else if (index === winnerIndex) {
                    isGameOver = true; lastWasLucky = false; AudioEngine.play('fail');
                    hands[index].src = 'hand_money.png'; hands[index].classList.add('shake');
                    for (let i = 0; i < hands.length; i++) if (i !== winnerIndex) hands[i].src = 'hand_clap.gif';
                    updateText(`${memberNames[index]}${i18n[currentLang].pay_msg}`, true);
                    document.getElementById('main-img').src = 'cafe_counter_thanks.gif';
                    updateStats(memberNames[index]); confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
                    showFinish(total, memberNames[index], 'game-view');
                } else {
                    AudioEngine.play('safe'); hands[index].src = 'hand_open.png'; hands[index].dataset.opened = "true";
                    updateText(`${memberNames[index]}${i18n[currentLang].safe_msg}`, true);
                }
            }, 800);
        }

        function goRoulette() {
            hideAllViews();
            const saved = localStorage.getItem('lastCoffeeMembers');
            const members = saved ? JSON.parse(saved) : ["User 1", "User 2", "User 3"];
            currentRouletteItems = [...members, i18n[currentLang].all_pass];
            document.getElementById('roulette-view').classList.remove('hidden');
            document.getElementById('main-img').src = 'cafe_counter.png';
            document.getElementById('roulette-spin-btn').innerText = i18n[currentLang].btn_spin;
            updateText('spin_msg');
            rouletteAngle = 0; drawRoulette();
        }

        function drawRoulette() {
            const canvas = document.getElementById('rouletteCanvas'); const ctx = canvas.getContext('2d');
            const cx = 200, cy = 200, r = 190;
            const weights = currentRouletteItems.map(item => item.includes(i18n.en.all_pass) || item.includes(i18n.ko.all_pass) ? 0.2 : 1);
            const totalWeight = weights.reduce((a, b) => a + b, 0);
            ctx.clearRect(0, 0, 400, 400);
            let startAngle = rouletteAngle;
            for (let i = 0; i < currentRouletteItems.length; i++) {
                const sliceAngle = (weights[i] / totalWeight) * Math.PI * 2;
                ctx.beginPath(); ctx.fillStyle = (currentRouletteItems[i].includes(i18n.en.all_pass) || currentRouletteItems[i].includes(i18n.ko.all_pass)) ? "#000" : (i % 2 === 0 ? "#f8f8f8" : "#ebebeb");
                ctx.moveTo(cx, cy); ctx.arc(cx, cy, r, startAngle, startAngle + sliceAngle); ctx.fill();
                ctx.strokeStyle = "#333"; ctx.lineWidth = 2; ctx.stroke();
                ctx.save(); ctx.translate(cx, cy); ctx.rotate(startAngle + sliceAngle / 2); ctx.textAlign = "right";
                ctx.fillStyle = (currentRouletteItems[i].includes(i18n.en.all_pass) || currentRouletteItems[i].includes(i18n.ko.all_pass)) ? "#f1c40f" : "#333";
                ctx.font = "bold 14px Montserrat"; ctx.fillText(currentRouletteItems[i], r - 30, 5); ctx.restore();
                startAngle += sliceAngle;
            }
            ctx.beginPath(); ctx.arc(cx, cy, 15, 0, Math.PI * 2); ctx.fillStyle = "#333"; ctx.fill();
        }

        function spinRoulette() {
            if (rouletteSpinning) return;
            if (document.getElementById('roulette-spin-btn').innerText === i18n[currentLang].btn_again) { goRoulette(); return; }
            rouletteSpinning = true; AudioEngine.play('whoosh');
            const duration = 4000; const startTS = performance.now(); const startRot = rouletteAngle;
            const targetRot = startRot + (Math.random() * 5 + 5) * Math.PI * 2;
            function animate(now) {
                const elapsed = now - startTS; const progress = Math.min(elapsed / duration, 1);
                const easeOut = 1 - Math.pow(1 - progress, 3);
                rouletteAngle = startRot + (targetRot - startRot) * easeOut;
                drawRoulette();
                if (progress < 1) requestAnimationFrame(animate);
                else { rouletteSpinning = false; finishSpin(); }
            }
            requestAnimationFrame(animate);
        }

        function finishSpin() {
            const weights = currentRouletteItems.map(item => item.includes(i18n.en.all_pass) || item.includes(i18n.ko.all_pass) ? 0.2 : 1);
            const totalWeight = weights.reduce((a, b) => a + b, 0);
            let normalizedAngle = (rouletteAngle % (Math.PI * 2)); if (normalizedAngle < 0) normalizedAngle += Math.PI * 2;
            const pinPos = (Math.PI * 1.5); let checkAngle = normalizedAngle, winnerIdx = 0;
            for (let i = 0; i < currentRouletteItems.length; i++) {
                const sliceAngle = (weights[i] / totalWeight) * Math.PI * 2;
                const start = checkAngle % (Math.PI * 2); const end = (checkAngle + sliceAngle) % (Math.PI * 2);
                if (end < start) { if (pinPos >= start || pinPos <= end) { winnerIdx = i; break; } }
                else { if (pinPos >= start && pinPos <= end) { winnerIdx = i; break; } }
                checkAngle += sliceAngle;
            }
            const winnerName = currentRouletteItems[winnerIdx];
            document.getElementById('roulette-spin-btn').innerText = i18n[currentLang].btn_again;
            
            if (winnerName.includes(i18n.en.all_pass) || winnerName.includes(i18n.ko.all_pass)) {
                AudioEngine.play('start'); updateText('all_pass_unbelievable');
                document.getElementById('main-img').src = 'cafe_counter_lucky.png';
                confetti({ particleCount: 200, spread: 100, origin: { y: 0.7 }, colors: ['#f1c40f', '#fff'] });
                showFinish(currentRouletteItems.length - 1, winnerName, 'roulette-view');
            } else {
                AudioEngine.play('fail'); 
                updateText(`${winnerName}${i18n[currentLang].pay_msg}`, true);
                document.getElementById('main-img').src = 'cafe_counter_thanks.gif';
                updateStats(winnerName); confetti({ particleCount: 100, spread: 70, origin: { y: 0.7 } });
                showFinish(currentRouletteItems.length - 1, winnerName, 'roulette-view');
            }
        }

        function showFinish(total, payerName, viewId) {
            const now = new Date(); const randomPrice = (Math.random() * (8.5 - 3.5) + 3.5).toFixed(2);
            const t = i18n[currentLang];
            document.getElementById('receipt-date').innerText = now.toLocaleDateString();
            document.getElementById('receipt-order-no').innerText = "NO." + Math.floor(1000 + Math.random() * 9000);
            document.getElementById('receipt-qty').innerText = "x" + total;
            document.getElementById('receipt-price').innerText = "$" + randomPrice;
            document.getElementById('receipt-subtotal').innerText = "$" + (randomPrice * total).toFixed(2);
            document.getElementById('receipt-fortune').innerText = t.fortunes[Math.floor(Math.random() * t.fortunes.length)];
            document.getElementById('receipt-menu').innerText = t.menus[Math.floor(Math.random() * t.menus.length)];
            
            const payerEl = document.getElementById('receipt-payer');
            if(payerName.includes(i18n.en.all_pass) || payerName.includes(i18n.ko.all_pass)) {
                payerEl.innerText = "FREE";
                payerEl.style.color = "var(--roulette-gold)";
            } else {
                payerEl.innerText = payerName;
                payerEl.style.color = "var(--point-red)";
            }

            const resRoot = document.getElementById('result-shared-root');
            const captureArea = document.getElementById('capture-area');
            resRoot.classList.remove('hidden');

            if(viewId === 'game-view') {
                document.getElementById('game-btn-group').prepend(captureArea);
                document.getElementById('btn-again-hand').disabled = false;
            } else {
                document.getElementById('roulette-action-area').prepend(captureArea);
            }
            setTimeout(() => document.getElementById('receipt').classList.add('show'), 200);
        }

        function updateStats(name) {
            let stats = JSON.parse(localStorage.getItem('coffeeStats') || '{}');
            const monthKey = new Date().toISOString().slice(0, 7);
            if(!stats[name] || typeof stats[name] !== 'object') { stats[name] = { total: 0, monthly: {} }; }
            stats[name].total += 1;
            stats[name].monthly[monthKey] = (stats[name].monthly[monthKey] || 0) + 1;
            localStorage.setItem('coffeeStats', JSON.stringify(stats));
        }

        function showStats() {
            const stats = JSON.parse(localStorage.getItem('coffeeStats') || '{}');
            const entries = Object.entries(stats).map(([name, data]) => [name, data.total || 0]).sort((a, b) => b[1] - a[1]);
            const dashboard = document.getElementById('stats-dashboard');
            if (entries.length === 0) {
                if(dashboard) dashboard.classList.add('hidden');
                return;
            }
            if(dashboard) dashboard.classList.remove('hidden');
            const list = document.getElementById('stats-list');
            if(list) list.innerHTML = entries.slice(0, 3).map(([name, count]) => `<div class="stats-row"><span>${name}</span><span>${count} ${i18n[currentLang].lbl_times}</span></div>`).join('');
        }

        function renderHistoryPage() {
            const stats = JSON.parse(localStorage.getItem('coffeeStats') || '{}');
            const monthKey = new Date().toISOString().slice(0, 7);
            const entries = Object.entries(stats).map(([name, data]) => ({ name, total: data.total || 0, monthly: (data.monthly && data.monthly[monthKey]) || 0 }))
                            .sort((a, b) => b.total - a.total);
            const kingArea = document.getElementById('monthly-king-area');
            const content = document.getElementById('history-list-content');
            if (entries.length === 0) { kingArea.innerHTML = ""; content.innerHTML = "No Data."; return; }
            const king = [...entries].sort((a,b) => b.monthly - a.monthly)[0];
            
            // ì´ë‹¬ì˜ í‚¹ ë””ìì¸ ìˆ˜ì • (í•œ ì¤„ ê³ ì •)
            if(king && king.monthly > 0) {
                kingArea.innerHTML = `
                    <div class="monthly-king-badge">
                        <div class="king-crown">ğŸ‘‘</div>
                        <div class="king-info">
                            <div class="king-tag">${i18n[currentLang].lbl_monthly_king} (${monthKey})</div>
                            <div class="king-name">${king.name}</div>
                        </div>
                        <div class="king-count-area">
                            ${king.monthly} ${i18n[currentLang].lbl_times}
                        </div>
                    </div>`;
            } else {
                kingArea.innerHTML = "";
            }
            
            content.innerHTML = entries.map(item => `<div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #f0f0f0;"><span style="font-weight:800; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${item.name}</span><span style="color:var(--point-red); font-weight:800; flex-shrink:0; margin-left:10px;">${item.total} ${i18n[currentLang].lbl_times}</span></div>`).join('');
        }

        function resetStats() { if(confirm(currentLang === 'ko' ? "ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí• ê¹Œìš”?" : "Clear all?")) { localStorage.removeItem('coffeeStats'); goFront(); } }

        async function shareAsImage() {
            const captureArea = document.getElementById('capture-area');
            const btn = document.getElementById('id-share-btn'); btn.innerText = "...";
            try {
                const canvas = await html2canvas(captureArea, { backgroundColor: "#ffffff", scale: 3 });
                canvas.toBlob(async (blob) => {
                    const file = new File([blob], "receipt.png", { type: "image/png" });
                    if (navigator.share) await navigator.share({ files: [file] });
                    else { const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'receipt.png'; a.click(); }
                    btn.innerText = i18n[currentLang].lbl_get_receipt;
                });
            } catch (e) { btn.innerText = "ERROR"; }
        }
    </script>
</body>
</html>
